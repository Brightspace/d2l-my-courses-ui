<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-content.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-menu/d2l-menu-item-selectable-behavior.html">
<link rel="import" href="../d2l-menu/d2l-menu-item-radio.html">
<link rel="import" href="../d2l-menu/d2l-menu-item-selectable-styles.html">
<link rel="import" href="../d2l-search-widget/d2l-search-widget.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="d2l-search-widget-custom.html">
<link rel="import" href="localize-behavior.html">

<dom-module id="d2l-list-item-filter">
	<template>
		<style include="d2l-menu-item-selectable-styles">
			:host {
				padding: 0.5rem 1rem;
			}

			:host > span {
				font-size: 0.8rem;
			}

			:host d2l-icon {
				--d2l-icon-height: 1rem;
				--d2l-icon-width: 1rem;
				visibility: visible;
				margin-right: 0.5rem;
			}
		</style>
		<d2l-icon icon="d2l-tier2:check-box-unchecked" aria-hidden="true"></d2l-icon>
		<span>[[text]]</span>
	</template>
	<script>
		'use strict';
		Polymer({
			is: 'd2l-list-item-filter',
			behaviors: [
				window.D2L.PolymerBehaviors.MenuItemSelectableBehavior
			],
			listeners: {
				'd2l-menu-item-select': '_onSelect'
			},
			_onSelect: function(e) {
				this.set('selected', !this.selected);
				this.$$('d2l-icon').setAttribute('icon', this.selected ? 'd2l-tier2:check-box' : 'd2l-tier2:check-box-unchecked');
				this.__onSelect(e);
			}
		});
	</script>
</dom-module>

<dom-module id="d2l-all-courses">
	<template>
		<style>
			:host {
				display: block;
			}
			h2 {
				/* overrides to d2l-heading-3 */
				margin: 20px 0 10px 0;
				font-size: 20px;
				/* end overrides */
			}
			d2l-alert {
				display: block;
				margin-bottom: 20px;
			}
			d2l-icon {
				--d2l-icon-height: 15px;
				--d2l-icon-width: 15px;
				margin-top: -0.35rem;
			}
			.hidden {
				display: none !important;
			}
			.invisible {
				visibility: hidden;
			}
			.search-and-filter {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 50px;
			}
			.search-and-filter > d2l-search-widget-custom {
				flex: calc(5 / 12);
			}
			@media screen and (max-width: 767px) {
				.search-and-filter > d2l-search-widget-custom {
					flex: 1;
				}
				#filterAndSort {
					display: none;
				}
			}
			.search-and-filter > div {
				flex: calc(7 / 12);
				display: flex;
				justify-content: flex-end;
			}
			.dropdown-opener-text {
				@apply(--d2l-body-small-text);
				/* overrides to d2l-body-small-text */
				font-size: 1rem;
				color: var(--d2l-color-tungsten);
				/* end overrides */
				cursor: pointer;
				padding: 0;
				margin-left: 1rem;
			}
			.dropdown-button {
				background: none;
				border: none;
				cursor: pointer;
				padding: 0;
				color: var(--d2l-color-tungsten);
			}
			@media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {
				#filterText {
					padding-top: 4px;
				}
			}
			#filterSection {
				display: flex;
			}
			#filterText {
				padding-right: 4px;
			}
			.clear-button {
				@apply(--d2l-body-small-text);
				/* overrides to d2l-body-small-text */
				color: var(--d2l-color-celestine);
				/* end overrides */
				background: none;
				border: none;
				cursor: pointer;
				margin: 0;
				padding: 0;
			}
			.dropdown-content-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				border-bottom: 1px solid var(--d2l-color-gypsum);
				width: 100%;
				padding: 20px;
			}
			.dropdown-content-header-text {
				font-weight: bold;
			}
			.dropdown-content-gradient {
				background: linear-gradient(to top, white, var(--d2l-color-regolith));
			}
			.dropdown-content-tabs {
				display: flex;
				align-items: center;
				justify-content: space-between;
			}
			.dropdown-content-tab {
				flex: 1;
			}
			.dropdown-content-tab-button {
				@apply(--d2l-body-small-text);
				color: var(--d2l-color-ferrite);
				background: none;
				border: none;
				padding: 10px;
				cursor: pointer;
				display: inherit;
			}
			.dropdown-content-tab-highlight {
				background-color: var(--d2l-color-celestine);
				border-bottom-left-radius: 4px;
				border-bottom-right-radius: 4px;
				height: 4px;
				width: 80%;
				margin: auto;
			}
			d2l-dropdown-content d2l-search-widget {
				--d2l-search-widget-height: 45px;
				margin: 10px 20px;
			}
			button[aria-pressed="true"] {
				color: var(--d2l-color-celestine);
			}
			button:focus > d2l-icon,
			button:hover > d2l-icon,
			button:focus > span,
			button:hover > span,
			#filterText:hover,
			#filterText:focus,
			#filterText:hover + d2l-dropdown button d2l-icon,
			#filterText:focus + d2l-dropdown button d2l-icon,
			d2l-dropdown-content button:hover,
			d2l-dropdown-content button:focus,
			.focus {
				text-decoration: underline;
				color: var(--d2l-color-celestine);
			}
		</style>

		<d2l-ajax
			id="organizationsRequest"
			url="[[_organizationsUrl]]"
			on-iron-ajax-response="_onOrganizationsResponse">
		</d2l-ajax>

		<d2l-ajax
			id="moreDepartmentsRequest"
			url="[[_moreDepartmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onMoreDepartmentsResponse">
		</d2l-ajax>

		<d2l-ajax
			id="moreSemestersRequest"
			url="[[_moreSemestersUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onMoreSemestersResponse">
		</d2l-ajax>

		<div class="search-and-filter">
			<d2l-search-widget-custom
				hidden$="[[_hasEnrollments]]"
				search-root-url="[[searchUrl]]"
				parent-organizations="[[_parentOrganizations]]"
				sort-field="[[_sortField]]">
			</d2l-search-widget-custom>

			<div id="filterAndSort">
				<div id="filterSection">
					<span id="filterText" class="dropdown-opener-text" on-tap="_toggleFilterDropdown">{{localize('filtering.filter')}}</span>
					<d2l-dropdown id="filterDropdown">
						<button
							id="filterDropdownOpener"
							class="d2l-dropdown-opener dropdown-button"
							on-focus="_focusFilterText"
							on-blur="_blurFilterText"
							on-mouseenter="_focusFilterText"
							on-mouseleave="_blurFilterText"
							aria-labelledby="filterText">
							<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
						</button>
						<d2l-dropdown-content id="filterDropdownContent" no-padding min-width="350">
							<div class="dropdown-content-header">
								<span class="dropdown-content-header-text">{{localize('filtering.filterBy')}}</span>
								<template is="dom-if" if="[[_isFiltered]]">
									<button class="clear-button" on-tap="_clearFilters">{{localize('filtering.clear')}}</button>
								</template>
							</div>
							<div class="dropdown-content-tabs dropdown-content-gradient" role="tablist">
								<div class="dropdown-content-tab" role="tab" aria-controls="semesterList">
									<div class="dropdown-content-tab-highlight" id="semesterListHighlight"></div>
									<button
										id="semesterListButton"
										class="dropdown-content-tab-button"
										on-tap="_selectSemesterList"
										aria-pressed="true">
										{{localize('filtering.semester')}}
									</button>
								</div>
								<div class="dropdown-content-tab" role="tab" aria-controls="departmentList">
									<div class="dropdown-content-tab-highlight" id="departmentListHighlight"></div>
									<button
										id="departmentListButton"
										class="dropdown-content-tab-button"
										on-tap="_selectDepartmentList"
										aria-pressed="false">
										{{localize('filtering.department')}}
									</button>
								</div>
							</div>
							<div id="semesterList" aria-labelledby="semesterListButton" role="tabpanel">
								<d2l-search-widget
									id="semesterSearchWidget"
									placeholder-text="{{localize('filtering.searchSemesters')}}"
									search-action="[[_searchSemestersAction]]"
									search-field-name="search"
									cache-responses></d2l-search-widget>
								<d2l-menu label="{{localize('filtering.semester')}}">
									<template is="dom-repeat" items="[[_semesterOrganizations]]">
										<d2l-list-item-filter
											value="[[getEntityIdentifier(item)]]"
											text="[[item.properties.name]]"
											selected="[[item.properties.selected]]">
										</d2l-list-item-filter>
									</template>
								</d2l-menu>
							</div>
							<div id="departmentList" aria-labelledby="departmentListButton" role="tabpanel">
								<d2l-search-widget
									id="departmentSearchWidget"
									placeholder-text="{{localize('filtering.searchDepartments')}}"
									search-action="[[_searchDepartmentsAction]]"
									search-field-name="search"
									cache-responses></d2l-search-widget>
								<d2l-menu label="{{localize('filtering.department')}}">
									<template is="dom-repeat" items="[[_departmentOrganizations]]">
										<d2l-list-item-filter
											value="[[getEntityIdentifier(item)]]"
											text="[[item.properties.name]]"
											selected="[[item.properties.selected]]">
										</d2l-list-item-filter>
									</template>
								</d2l-menu>
							</div>
							<iron-scroll-threshold
								id="scrollThreshold"
								on-lower-threshold="_loadMore">
							</iron-scroll-threshold>
						</d2l-dropdown-content>
					</d2l-dropdown>
				</div>

				<d2l-dropdown id="sortDropdown">
					<button
						class="d2l-dropdown-opener dropdown-button"
						aria-labelledby="sortText">
						<span id="sortText" class="dropdown-opener-text">{{localize('sorting.sortDatePinned')}}</span>
						<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
					</button>
					<d2l-dropdown-menu no-padding min-width="350">
						<d2l-menu label="{{localize('sorting.sortBy')}}">
							<div class="dropdown-content-header">
								<span class="dropdown-content-header-text">{{localize('sorting.sortBy')}}</span>
							</div>
							<d2l-menu-item-radio class="dropdown-content-gradient" value="courseCode" text="{{localize('sorting.courseCode')}}"></d2l-menu-item-radio>
							<d2l-menu-item-radio value="courseName" text="{{localize('sorting.courseName')}}"></d2l-menu-item-radio>
							<d2l-menu-item-radio value="pinDate" text="{{localize('sorting.datePinned')}}" selected></d2l-menu-item-radio>
							<d2l-menu-item-radio value="lastAccessed" text="{{localize('sorting.lastAccessed')}}"></d2l-menu-item-radio>
						</d2l-menu>
					</d2l-dropdown-menu>
				</d2l-dropdown>
			</div>
		</div>

		<h2 class="d2l-heading-3">{{localize('pinnedCourses')}}</h2>

		<template is="dom-repeat" items="{{_alerts}}">
			<d2l-alert alert-type="[[item.alertType]]">
				{{item.alertMessage}}
			</d2l-alert>
		</template>

		<d2l-course-tile-grid
			id="all-courses-pinned"
			enrollments="{{pinnedEnrollments}}"
			enrollments-queue="{{pinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]"
			tile-sizes="[[_tileSizes]]">
		</d2l-course-tile-grid>

		<h2 class="d2l-heading-3">{{localize('unpinnedCourses')}}</h2>

		<d2l-course-tile-grid
			id="all-courses-unpinned"
			enrollments="{{unpinnedEnrollments}}"
			enrollments-queue="{{unpinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]"
			tile-sizes="[[_tileSizes]]">
		</d2l-course-tile-grid>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-all-courses',
			properties: {
				// Sets the delay-load property on the course tile grid
				delayCourseTileLoad: {
					type: Boolean,
					value: true
				},
				// URL for search widget; should have search-my-enrollments Action
				searchUrl: {
					type: String,
					value: ''
				},
				_departmentOrganizations: {
					type: Array,
					value: function() {
						return [];
					}
				},
				_isFiltered: {
					type: Boolean,
					value: false
				},
				_hasMoreDepartments: {
					type: Boolean,
					value: false
				},
				_hasMoreSemesters: {
					type: Boolean,
					value: false
				},
				_moreDepartmentsUrl: {
					type: String,
					value: ''
				},
				_moreSemestersUrl: {
					type: String,
					value: ''
				},
				_organizationsUrl: {
					type: String,
					value: '/d2l/api/hm/organizations',
					readOnly: true
				},
				_searchSemestersAction: {
					type: Object,
					value: {
						'name':'search-course-collection',
						'method':'GET',
						'href': '/d2l/api/hm/organizations',
						'fields':[
							{'name':'search', 'type':'search', 'value':''},
							{'name':'page', 'type':'number', 'value':'1'},
							{'name':'pageSize', 'type':'number', 'value':'20'},
							{'name':'embedDepth', 'type':'number', 'value':'1'},
							// 5 is the default type ID for semesters
							// organizationTypeIds is updated by organizationsRequest
							{'name':'organizationTypeIds', 'type':'hidden', 'value':'5'}]
					}
				},
				_searchDepartmentsAction: {
					type: Object,
					value: {
						'name':'search-course-collection',
						'method':'GET',
						'href':'/d2l/api/hm/organizations',
						'fields':[
							{'name':'search', 'type':'search', 'value':''},
							{'name':'page', 'type':'number', 'value':'1'},
							{'name':'pageSize', 'type':'number', 'value':'20'},
							{'name':'embedDepth', 'type':'number', 'value':'1'},
							// 203 is the default type ID for departments
							// organizationTypeIds is updated by organizationsRequest
							{'name':'organizationTypeIds', 'type':'hidden', 'value':'203'}]
					}
				},
				_semesterOrganizations: {
					type: Array,
					value: function() {
						return [];
					}
				},
				_sortField: {
					type: String,
					value: 'pinDate'
				},
				_tileSizes: Object,
				_parentOrganizations: {
					type: Array,
					value: function() {
						return [];
					}
				},
				_alerts: {
					type: Array,
					value: function() { return []; }
				}
			},
			behaviors: [
				window.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				window.D2L.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.CourseManagementBehavior,
				window.D2L.MyCourses.UtilityBehavior
			],
			listeners: {
				'd2l-simple-overlay-opening': '_onSimpleOverlayOpening'
			},
			observers: [
				'_updateEnrollmentAlerts(_hasPinnedEnrollments)'
			],
			ready: function() {
				this.usePendingLists = true;
				this._updateEnrollmentAlerts(this._hasPinnedEnrollments);

				// Both course tile grids in this view should have the same number of columns, so use a custom getter
				var courseTileGrids = Polymer.dom(this.root).querySelectorAll('d2l-course-tile-grid');
				for (var i = 0; i < courseTileGrids.length; i++) {
					courseTileGrids[i].getCourseTileItemCount = this.getCourseTileItemCount.bind(this);
				}
				this._updateTileSizes();
			},
			attached: function() {
				this.listen(this.$.sortDropdown, 'd2l-menu-item-change', '_updateSortBy');
				this.listen(this.$.filterDropdown, 'd2l-menu-item-change', '_updateFilter');

				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-open', '_onFilterDropdownOpen');
				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');

				this.listen(this.$.semesterSearchWidget, 'd2l-search-widget-results-changed', '_onSemesterSearchResults');
				this.listen(this.$.departmentSearchWidget, 'd2l-search-widget-results-changed', '_onDepartmentSearchResults');

				this.$.scrollThreshold.scrollTarget = this.$.filterDropdownContent.querySelector('.d2l-dropdown-content-container');

				window.addEventListener('resize', this._onResize.bind(this));
			},
			detached: function() {
				this.unlisten(this.$.sortDropdown, 'd2l-menu-item-change', '_updateSortBy');
				this.unlisten(this.$.filterDropdown, 'd2l-menu-item-change', '_updateFilter');

				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-open', '_onFilterDropdownOpen');
				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');

				this.unlisten(this.$.semesterSearchWidget, 'd2l-search-widget-results-changed', '_onSemesterSearchResults');
				this.unlisten(this.$.departmentSearchWidget, 'd2l-search-widget-results-changed', '_onDepartmentSearchResults');
			},
			getCourseTileItemCount: function() {
				var itemCount = Math.max(this.pinnedEnrollments.length, this.unpinnedEnrollments.length);
				return itemCount;
			},
			loadCourseTiles: function() {
				this.delayCourseTileLoad = false;
			},
			setCourseImage: function(details) {
				this._removeAlert('setCourseImageFailure');
				if (details && details.detail) {
					if (details.detail.status === 'failure') {
						this._addAlert('warning', 'setCourseImageFailure', this.localize('error.settingImage'));
					}
				}
				this.$$('#all-courses-pinned').setCourseImage(details);
				this.$$('#all-courses-unpinned').setCourseImage(details);
			},
			_filterDropdownOpen: false,
			_numSemesterFilters: 0,
			_numDepartmentFilters: 0,
			_sortTextOptions: {
				'courseCode': 'sorting.sortCourseCode',
				'courseName': 'sorting.sortCourseName',
				'pinDate': 'sorting.sortDatePinned',
				'lastAccessed': 'sorting.sortLastAccessed'
			},
			_checkFilterEntities: function(entities) {
				entities.forEach(function(entity) {
					var id = this.getEntityIdentifier(entity);
					entity.properties.selected = this._parentOrganizations.indexOf(id) > -1;
				}.bind(this));
			},
			_clearFilters: function() {
				Polymer.dom(this.$.filterDropdown).querySelectorAll('d2l-menu-item-checkbox').forEach(function(item) {
					item.selected = false;
				});
				this._isFiltered = false;
				// Clear button is removed via dom-if, so need to manually set focus to next element
				this.$.semesterListButton.focus();
				this._parentOrganizations = [];
				this.$.filterText.textContent = this.localize('filtering.filter');
				this.$.semesterListButton.textContent = this.localize('filtering.semester');
				this.$.departmentListButton.textContent = this.localize('filtering.department');
				this._numSemesterFilters = 0;
				this._numDepartmentFilters = 0;
			},
			_loadMore: function() {
				// Generate the request based off of which tab is selected, and whether there are more to load or not
				if (this.$.semesterList.classList.contains('hidden')) {
					if (this._hasMoreDepartments) {
						this.$.moreDepartmentsRequest.generateRequest();
					}
				} else {
					if (this._hasMoreSemesters) {
						this.$.moreSemestersRequest.generateRequest();
					}
				}
				this.$.scrollThreshold.clearTriggers();
			},
			_blurFilterText: function() {
				// Only de-highlight text if focus has moved AND we're not hovering over the opener button anymore
				// Without this check, the text de-highlights once the dropdown is opened as focus moves to the tabs
				if (this.$$('#filterDropdownOpener:focus') === null && this.$$('#filterDropdownOpener:hover') === null) {
					this.toggleClass('focus', false, this.$.filterText);
				}
			},
			_focusFilterText: function() {
				this.toggleClass('focus', true, this.$.filterText);
			},
			_updateMoreParameters: function(entity, moreUrlPath, hasMorePath) {
				this._checkFilterEntities(entity.entities);

				this.set(hasMorePath, entity.hasLinkByRel('next'));
				this.set(moreUrlPath, this[hasMorePath] ? entity.getLinkByRel('next').href : '');
			},
			_onFilterDropdownClose: function() {
				// If the dropdown is closed by clicking elsewhere, we need to manually update _filterDropdownOpen
				// since _toggleFilterDropdown doesn't run.
				// Timeout is to ensure this runs after _toggleFilterDropdown when it's clicked closed
				setTimeout(function() {
					this.set('_filterDropdownOpen', false);
				}.bind(this), 100);
			},
			_onFilterDropdownOpen: function() {
				this._selectSemesterList();
			},
			_onDepartmentSearchResults: function(e) {
				this.set('_departmentOrganizations', e.detail.entities);
				this._updateMoreParameters(e.detail, '_moreDepartmentsUrl', '_hasMoreDepartments');
			},
			_onSemesterSearchResults: function(e) {
				this.set('_semesterOrganizations', e.detail.entities);
				this._updateMoreParameters(e.detail, '_moreSemestersUrl', '_hasMoreSemesters');
			},
			_onMoreResponse: function(response, organizationsPath, moreUrlPath, hasMorePath) {
				if (response.detail.status === 200 || response.detail.status === 304) {
					var parser = document.createElement('d2l-siren-parser');
					var responseEntity = parser.parse(response.detail.xhr.response);

					responseEntity.entities.forEach(function(entity) {
						this.push(organizationsPath, entity);
					}.bind(this));

					this._updateMoreParameters(responseEntity, moreUrlPath, hasMorePath);
				}
			},
			_onMoreDepartmentsResponse: function(response) {
				this._onMoreResponse(response, '_departmentOrganizations', '_moreDepartmentsUrl', '_hasMoreDepartments');
			},
			_onMoreSemestersResponse: function(response) {
				this._onMoreResponse(response, '_semesterOrganizations', '_moreSemestersUrl', '_hasMoreSemesters');
			},
			_onOrganizationsResponse: function(response) {
				if (this.pinnedEnrollments.length + this.unpinnedEnrollments.length <= 20) {
					// Small optimization - hide filter menu and don't fetch contents if user doesn't have a lot of enrollments
					this.toggleClass('hidden', true, this.$.filterAndSort);
					return;
				}

				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var responseEntity = parser.parse(response.detail.xhr.response);

					var departmentId = responseEntity.getActionByName('add-department-filter').getFieldByName('organizationTypeIds').value;
					var departmentAction = {
						name: 'search-course-collection',
						method: 'GET',
						href: this._organizationsUrl,
						fields: [
							{ name: 'organizationTypeIds', type: 'hidden', value: departmentId },
							{ name: 'search', type: 'search', value: '' },
							{ name: 'page', type: 'number', value: '1' },
							{ name: 'pageSize', type: 'number', value: '20' },
							{ name: 'embedDepth', type: 'number', value: '1' }
						]
					};
					this.set('_searchDepartmentsAction', departmentAction);

					var semesterId = responseEntity.getActionByName('add-semester-filter').getFieldByName('organizationTypeIds').value;
					var semesterAction = {
						name: 'search-course-collection',
						method: 'GET',
						href: this._organizationsUrl,
						fields: [
							{ name: 'organizationTypeIds', type: 'hidden', value: semesterId },
							{ name: 'search', type: 'search', value: '' },
							{ name: 'page', type: 'number', value: '1' },
							{ name: 'pageSize', type: 'number', value: '20' },
							{ name: 'embedDepth', type: 'number', value: '1' }
						]
					};
					this.set('_searchSemestersAction', semesterAction);

					// This calls .clear() on both search widgets (which searches with an empty query),
					// so this needs to run after we have both search Actions updated
					this._selectSemesterList();
				}
			},
			_onResize: function() {
				this._updateTileSizes();
			},
			_selectSemesterList: function() {
				this._toggleSelectedList(this.$.semesterList, this.$.semesterListButton, this.$.semesterListHighlight, true);
				this._toggleSelectedList(this.$.departmentList, this.$.departmentListButton, this.$.departmentListHighlight, false);
				this.$.semesterSearchWidget.clear();
				this.$.departmentSearchWidget.clear();
				this.$.semesterList.querySelector('d2l-menu').resize();
			},
			_selectDepartmentList: function() {
				this._toggleSelectedList(this.$.departmentList, this.$.departmentListButton, this.$.departmentListHighlight, true);
				this._toggleSelectedList(this.$.semesterList, this.$.semesterListButton, this.$.semesterListHighlight, false);
				this.$.semesterSearchWidget.clear();
				this.$.departmentSearchWidget.clear();
				this.$.departmentList.querySelector('d2l-menu').resize();
			},
			_updateTileSizes: function() {
				this._rescaleCourseTileRegions();
				this._tileSizes = Math.floor(100 / this._numColsOverlay) + 'vw';
			},
			_toggleSelectedList: function(list, button, highlight, selected) {
				this.toggleClass('hidden', !selected, list);
				this.toggleClass('invisible', !selected, highlight);
				button.setAttribute('aria-pressed', selected);
			},
			_toggleFilterDropdown: function() {
				// This is somewhat gross, but is a side effect of using the filter text span as a secondary opener
				if (this._filterDropdownOpen) {
					this.$.filterDropdownContent.close();
					this.$.filterDropdownOpener.focus();
				} else {
					this.$.filterDropdownContent.open();
				}
				this.set('_filterDropdownOpen', !this._filterDropdownOpen);
			},
			_updateFilter: function(e) {
				var isSemester = this.$.semesterList.contains(e.target);

				if (e.detail.selected) {
					this.push('_parentOrganizations', e.detail.value);
					isSemester ? this._numSemesterFilters++ : this._numDepartmentFilters++;
				} else {
					var index = this._parentOrganizations.indexOf(e.detail.value);
					this.splice('_parentOrganizations', index, 1);
					isSemester ? this._numSemesterFilters-- : this._numDepartmentFilters--;
				}

				if (this._parentOrganizations.length === 0) {
					this.$.filterText.textContent = this.localize('filtering.filter');
				} else if (this._parentOrganizations.length === 1) {
					this.$.filterText.textContent = this.localize('filtering.filterSingle');
				} else {
					this.$.filterText.textContent = this.localize('filtering.filterMultiple', 'num', this._parentOrganizations.length);
				}

				this._isFiltered = this._parentOrganizations.length > 0;
				this.$.semesterListButton.textContent = this._numSemesterFilters > 0
					? this.localize('filtering.semesterMultiple', 'num', this._numSemesterFilters)
					: this.localize('filtering.semester');
				this.$.departmentListButton.textContent = this._numDepartmentFilters > 0
					? this.localize('filtering.departmentMultiple', 'num', this._numDepartmentFilters)
					: this.localize('filtering.department');
			},
			_updateSortBy: function(e) {
				this.set('_sortField', e.detail.value);

				this.$.sortText.textContent = this.localize(this._sortTextOptions[this._sortField] || '');

				this.$.sortDropdown.toggleOpen();
			},
			_updateEnrollmentAlerts: function(hasPinnedEnrollments) {
				this._alerts = [];

				if (!hasPinnedEnrollments) {
					this._addAlert('call-to-action', 'noPinnedCourses', this.localize('noPinnedCoursesMessage'));
				}
			},
			_addAlert: function(type, name, message) {
				if (this._alerts) {
					this.push('_alerts', {
						alertType: type,
						alertName: name,
						alertMessage: message
					});
				}
			},
			_hasAlert: function(name) {
				if (!this._alerts || this._alerts.length <= 0) {
					return false;
				}
				return this._alerts.some(function(alert) {
					return alert.alertName === name;
				});
			},
			_removeAlert: function(name) {
				if (this._alerts && this._alerts.length > 0 && this._hasAlert(name)) {
					this.splice('_alerts', this._alerts.map(function(alert) { return alert.name; }).indexOf(name), 1);
				}
			},
			_onSimpleOverlayOpening: function() {
				this._removeAlert('setCourseImageFailure');
			}
		});
	</script>
</dom-module>
