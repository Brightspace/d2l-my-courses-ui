<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-all-courses-styles.html">
<link rel="import" href="d2l-simple-overlay.html">
<link rel="import" href="d2l-course-tile.html">
<link rel="import" href="d2l-course-tile-region-behavior.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-interaction-detection-behavior.html">

<dom-module id="d2l-all-courses">
	<template>
		<style include="d2l-all-courses-styles"></style>

		<d2l-ajax
			id="allEnrollmentsRequest"
			url="{{effectiveEnrollmentsUrl()}}"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-response="allEnrollmentsOnResponse">
		</d2l-ajax>

		<d2l-simple-overlay
			id='all-courses-overlay'
			title="{{localize('allCourses')}}"
			locale="[[locale]]"
			with-backdrop>

			<div class="dialog-content">
				<h3 class="d2l-heading-3">{{localize('pinnedCourses')}}</h3>
				<d2l-alert visible="{{!_hasPinnedCourses}}">
					{{localize('noPinnedCoursesMessage')}}
				</d2l-alert>
				<div class="my-courses-container" role="region">
					<template is="dom-repeat" filter="isActive" items="[[pinnedCoursesEntities]]">
						<d2l-course-tile
							enrollment="[[item]]"
							hover-enabled="[[_hoverInteractionEnabled]]"
							touch-enabled="[[_touchInteractionEnabled]]"></d2l-course-tile>
					</template>
				</div>

				<h3 class="d2l-heading-3">{{localize('unpinnedCourses')}}</h3>
				<div class="my-courses-container" role="region">
					<template is="dom-repeat" items="[[unpinnedCoursesEntities]]">
						<d2l-course-tile
							enrollment="[[item]]"
							hover-enabled="[[_hoverInteractionEnabled]]"
							touch-enabled="[[_touchInteractionEnabled]]"></d2l-course-tile>
					</template>
				</div>
			</div>
		</d2l-simple-overlay>
	</template>

	<script>
		Polymer({
			is: 'd2l-all-courses',
			properties: {
				pinnedCoursesEntities: {
					type: Array,
					notify: true
				},
				unpinnedCoursesEntities: {
					type: Array,
					notify: true
				},
				testEnrollmentsUrl: {
					type: String
				},
				enrollmentsUrl: {
					type: String
				},
				_hasPinnedCourses: {
					type: Boolean
				},
				_windowResizeHandler: {
					type: Object,
					readOnly: true,
					value: function() {
						return this._handleWindowResize.bind(this);
					}
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileRegionBehavior,
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.InteractionDetectionBehavior
			],
			observers: [
				'_onPinnedCoursesEntitiesChanged(pinnedCoursesEntities.*)'
			],
			ready : function() {
				this.$$('d2l-simple-overlay').focusableNodesOverride = this.focusableNodesOverride;
			},
			allEnrollmentsOnResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var allCoursesEntities = parser.parse(response.detail.xhr.response).getSubEntitiesByClass('course-offering');

					// Get unpinned courses
					var unpinnedCourseFilter = function(parser) {
						return function(element) {
							return !parser.parse(element).hasEntityByClass('pinned');
						}
					};

					this.set(
						'unpinnedCoursesEntities',
						allCoursesEntities.filter(unpinnedCourseFilter(parser))
					);

					this._rescaleCourseTileRegions(this._getOverlayWidth());
				}
			},
			isActive: function(item) {
				return item.class.indexOf('inactive') === -1;
			},
			open: function() {
				this.$.allEnrollmentsRequest.url = this.effectiveEnrollmentsUrl();
				this.$.allEnrollmentsRequest.generateRequest();
				this.$$('d2l-simple-overlay').open();
				this._rescaleCourseTileRegions(this._getOverlayWidth());
			},
			_getOverlayWidth: function() {
				return this._getAvailableWidth(this.$$('d2l-simple-overlay'));
			},
			attached: function() {
				this._addThrottledEventListener('resize', this._windowResizeHandler);
			},
			detached: function() {
				window.removeEventListener('resize', this._windowResizeHandler);
			},
			get courseTileItemCount() {
				var pinnedCoursesEntityCount = this.pinnedCoursesEntities
					? this.pinnedCoursesEntities.filter(function(item) {
						return item.class.indexOf('inactive') === -1;
					}).length : 0;
				var unpinnedCoursesEntityCount = this.unpinnedCoursesEntities
					? this.unpinnedCoursesEntities.filter(function(item) {
						return item.class.indexOf('inactive') === -1;
					}).length : 0;
				var itemCount = Math.max(pinnedCoursesEntityCount, unpinnedCoursesEntityCount);

				return itemCount;
			},
			focusableNodesOverride: function() {
				var courseTileFocusables = [];

				this.getContentChildren().forEach(function(contentChild) {
					var courseTiles = Polymer.dom(contentChild).querySelectorAll('d2l-course-tile');

					[].forEach.call(courseTiles, function(courseTile) {
						Array.prototype.push.apply(courseTileFocusables, Polymer.dom(courseTile.root).querySelectorAll('a'));
					});
				});

				return courseTileFocusables;
			},
			_isEmpty: function(list) {
				return !list || list.length === 0;
			},
			effectiveEnrollmentsUrl: function() {
				if (!this.testEnrollmentsUrl) {
					return this.enrollmentsUrl;
				} else {
					return this.testEnrollmentsUrl;
				}
			},
			_onPinnedCoursesEntitiesChanged: function(newArray) {
				this._hasPinnedCourses = !newArray.base || newArray.base.length > 0;
			}
		});
	</script>
</dom-module>
