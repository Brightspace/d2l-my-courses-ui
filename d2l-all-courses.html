<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-content.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-search-widget/d2l-search-widget.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-search-widget-custom.html">

<!--
`<d2l-all-courses>` displays both pinned and unpinned courses

@demo demo/d2l-all-courses-demo.html
-->
<dom-module id="d2l-all-courses">
	<template>
		<style>
			:host {
				display: block;
			}
			h2 {
				/* overrides to d2l-heading-3 */
				margin: 20px 0 10px 0;
				font-size: 20px;
				/* end overrides */
			}
			d2l-alert {
				margin-bottom: 20px;
			}
			.hidden {
				display: none;
			}
			.invisible {
				visibility: hidden;
			}
			.search-and-filter {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 60px;
			}
			.search-and-filter > d2l-search-widget-custom {
				flex: 1
			}
			.dropdown-text {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				font-size: 1rem;
				font-weight: 300;
				color: var(--d2l-color-tungsten);
				/* end overrides */
				cursor: pointer;
				padding: 0;
				margin-left: 1rem;
				padding-right: 0.3rem;
			}
			.dropdown-text:hover,
			.dropdown-text:focus {
				color: var(--d2l-color-celestine);
				text-decoration: underline;
			}
			.dropdown-text:hover + d2l-dropdown button,
			.dropdown-text:focus + d2l-dropdown button {
				color: var(--d2l-color-celestine);
			}
			d2l-dropdown > button:hover,
			d2l-dropdown > button:focus {
				color: var(--d2l-color-celestine);
			}
			.dropdown-button {
				background: none;
				border: none;
				cursor: pointer;
				padding: 0;
				color: var(--d2l-color-tungsten);
			}
			iron-icon {
				--iron-icon-height: 15px;
				--iron-icon-width: 15px;
				margin-top: -0.35rem;
			}
			.clear-button {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				color: var(--d2l-color-celestine);
				/* end overrides */
				background: none;
				border: none;
				cursor: pointer;
				margin: 0;
				padding: 0;
			}
			.dropdown-content-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				border-bottom: 1px solid var(--d2l-color-gypsum);
				width: 100%;
				padding: 20px;
			}
			.dropdown-content-header-text {
				font-weight: bold;
			}
			.dropdown-content-gradient {
				background: linear-gradient(to top, white, var(--d2l-color-regolith));
			}
			.dropdown-content-tabs {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-left: 20px;
				margin-right: 20px;
			}
			.dropdown-content-tab {
				flex: 1;
			}
			d2l-search-widget {
				margin-left: 20px;
				margin-right: 20px;
				margin-top: 10px;
				margin-bottom: 10px;
			}
			.dropdown-content-tab-button {
				@apply(--d2l-small-text);
				background: none;
				border: none;
				padding: 10px;
				cursor: pointer;
				display: inherit;
			}
			.dropdown-content-tab-highlight {
				background-color: var(--d2l-color-celestine);
				border-bottom-left-radius: 4px;
				border-bottom-right-radius: 4px;
				height: 4px;
				width: 100%;
			}
			.dropdown-content-item {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				font-weight: lighter;
				/* end overrides */
				display: block;
				background: none;
				border: none;
				cursor: pointer;
				margin: 0;
				padding-top: 20px;
				padding-bottom: 20px;
				padding-left: 20px;
				width: 100%;
				text-align: left;
			}
			.dropdown-content-item input[type=checkbox] {
				margin-right: 15px;
			}
			.dropdown-content-item input[type=checkbox]:after {
				content: '';
				display: inline-block;
				visibility: visible;
				width: 1rem;
				height: 1rem;
				margin-left: -0.2rem;
				border-radius: 0.3rem;
				border-style: solid;
				border-color: var(--d2l-color-titanius);
				border-width: 1px;
				background-color: var(--d2l-color-woolonardo);
				box-sizing: border-box;
			}
			.dropdown-content-item input[type=checkbox]:focus::after {
				border-color: var(--d2l-color-celestine);
				border-width: 2px;
			}
			.dropdown-content-item input[type=checkbox]:checked::after {
				background-image: url('../images/tier1/check.svg');
				background-position: center center;
				background-repeat: no-repeat;
				background-size: 13px;
			}
			.dropdown-content-item > iron-icon {
				visibility: hidden;
				margin-right: 20px;
				margin-top: -5px;
				--iron-icon-height: 20px;
				--iron-icon-width: 20px;
			}
			#sortDropdown d2l-dropdown-content button {
				border-bottom: 1px solid var(--d2l-color-gypsum);
				font-size: 1rem;
			}
			.selected {
				color: var(--d2l-color-celestine);
			}
			.selected > iron-icon {
				visibility: visible;
			}
			.highlight {
				text-decoration: underline;
			}
		</style>

		<d2l-ajax
			id="moreDepartmentsRequest"
			url="[[_moreDepartmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onMoreDepartmentsResponse">
		</d2l-ajax>

		<d2l-ajax
			id="moreSemestersRequest"
			url="[[_moreSemestersUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onMoreSemestersResponse">
		</d2l-ajax>

		<div class="search-and-filter">
			<d2l-search-widget-custom
				hidden$="[[_hasEnrollments]]"
				search-root-url="[[searchUrl]]"
				parent-organization-ids="[[_parentOrganizationIds]]"
				sort-field="[[_sortField]]">
			</d2l-search-widget-custom>

			<div id="filterAndSort">
				<span id="filterText" class="dropdown-text" on-tap="_toggleFilterDropdown">{{localize('filtering.filter')}}</span>
				<d2l-dropdown id="filterDropdown">
					<button
						id="filterButton"
						on-mouseenter="_onFocusFilterText"
						on-mouseout="_onBlurFilterText"
						class="d2l-dropdown-opener dropdown-button">
						<iron-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></iron-icon>
					</button>
					<d2l-dropdown-content id="filterDropdownContent" no-padding min-width="350">
						<div class="dropdown-content-header">
							<span class="dropdown-content-header-text">{{localize('filtering.filterBy')}}</span>
							<template is="dom-if" if="[[_isFiltered]]">
								<button class="clear-button" on-tap="_clearFilters">{{localize('filtering.clear')}}</button>
							</template>
						</div>
						<div class="dropdown-content-gradient">
							<div class="dropdown-content-tabs">
								<div class="dropdown-content-tab">
									<div class="dropdown-content-tab-highlight" id="semesterListHighlight"></div>
									<button
										id="semesterListButton"
										class="dropdown-content-tab-button selected"
										on-tap="_selectSemesterList"
										aria-pressed="true">
										{{localize('filtering.semester')}}
									</button>
								</div>
								<div class="dropdown-content-tab">
									<div class="dropdown-content-tab-highlight invisible" id="departmentListHighlight"></div>
									<button
										id="departmentListButton"
										class="dropdown-content-tab-button"
										on-tap="_selectDepartmentList"
										aria-pressed="false">
										{{localize('filtering.department')}}
									</button>
								</div>
							</div>
						</div>
						<div id="semesterList">
							<d2l-search-widget
								id="semesterSearchWidget"
								search-action="[[_searchSemestersAction]]"
								search-field-name="search"></d2l-search-widget>
							<template is="dom-repeat" items="[[_semesterOrganizations]]">
								<div class="dropdown-content-item">
									<label>
										<input
											type="checkbox"
											value="[[item.properties.id]]"
											checked="[[item.properties.checked]]"
											on-tap="_updateFilter" />
										[[item.properties.name]]
									</label>
								</div>
							</template>
						</div>
						<div id="departmentList" class="hidden">
							<d2l-search-widget
								id="departmentSearchWidget"
								search-action="[[_searchDepartmentsAction]]"
								search-field-name="search"></d2l-search-widget>
							<template is="dom-repeat" items="[[_departmentOrganizations]]">
								<div class="dropdown-content-item">
									<label>
										<input
											type="checkbox"
											value="[[item.properties.id]]"
											checked="[[item.properties.checked]]"
											on-tap="_updateFilter" />
										[[item.properties.name]]
									</label>
								</div>
							</template>
						</div>
						<iron-scroll-threshold
							id="scrollThreshold"
							on-lower-threshold="_loadMore">
						</iron-scroll-threshold>
					</d2l-dropdown-content>
				</d2l-dropdown>

				<span id="sortText" class="dropdown-text" on-tap="_toggleSortDropdown">{{localize('sorting.sortDatePinned')}}</span>
				<d2l-dropdown id="sortDropdown">
					<button
						id="sortButton"
						on-mouseenter="_onFocusSortText"
						on-mouseout="_onBlurSortText"
						class="d2l-dropdown-opener dropdown-button">
						<iron-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></iron-icon>
					</button>
					<d2l-dropdown-content no-padding min-width="350">
						<div class="dropdown-content-header">
							<span class="dropdown-content-header-text">{{localize('sorting.sortBy')}}</span>
						</div>
						<div class="dropdown-content-gradient">
							<button class="dropdown-content-item" value="courseCode" on-tap="_updateSortBy">
								<iron-icon icon="d2l-tier1:check" aria-hidden="true"></iron-icon>
								{{localize('sorting.courseCode')}}
							</button>
							<button class="dropdown-content-item" value="courseName" on-tap="_updateSortBy">
								<iron-icon icon="d2l-tier1:check" aria-hidden="true"></iron-icon>
								{{localize('sorting.courseName')}}
							</button>
							<button class="dropdown-content-item selected" value="pinDate" on-tap="_updateSortBy">
								<iron-icon icon="d2l-tier1:check" aria-hidden="true"></iron-icon>
								{{localize('sorting.datePinned')}}
							</button>
							<button class="dropdown-content-item" value="department" on-tap="_updateSortBy">
								<iron-icon icon="d2l-tier1:check" aria-hidden="true"></iron-icon>
								{{localize('sorting.department')}}
							</button>
							<button class="dropdown-content-item" value="lastAccessed" on-tap="_updateSortBy">
								<iron-icon icon="d2l-tier1:check" aria-hidden="true"></iron-icon>
								{{localize('sorting.lastAccessed')}}
							</button>
						</div>
					</d2l-dropdown-content>
				</d2l-dropdown>
			</div>
		</div>

		<h2 class="d2l-heading-3">{{localize('pinnedCourses')}}</h2>

		<template is="dom-if" if="[[!_hasPinnedEnrollments]]">
			<d2l-alert visible="[[!_hasPinnedEnrollments]]">
				{{localize('noPinnedCoursesMessage')}}
			</d2l-alert>
		</template>

		<d2l-course-tile-grid
			enrollments="{{pinnedEnrollments}}"
			enrollments-queue="{{pinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]">
		</d2l-course-tile-grid>

		<h2 class="d2l-heading-3">{{localize('unpinnedCourses')}}</h2>

		<d2l-course-tile-grid
			enrollments="{{unpinnedEnrollments}}"
			enrollments-queue="{{unpinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]">
		</d2l-course-tile-grid>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-all-courses',
			properties: {
				/*
				* Sets the delay-load property on the course tile grid
				* @type {Boolean}
				*/
				delayCourseTileLoad: {
					type: Boolean,
					value: true
				},
				/*
				* URL for search widget; should have search-my-enrollments Action
				*/
				searchUrl: {
					type: String,
					value: ''
				},
				_departmentOrganizations: Object,
				_isFiltered: {
					type: Boolean,
					value: false
				},
				_hasMoreDepartments: {
					type: Boolean,
					value: false
				},
				_hasMoreSemesters: {
					type: Boolean,
					value: false
				},
				_moreDepartmentsUrl: {
					type: String,
					value: ''
				},
				_moreSemestersUrl: {
					type: String,
					value: ''
				},
				_searchSemestersAction: {
					type: Object,
					value: {
						'name':'search-course-collection',
						'method':'GET',
						'href':'/d2l/api/hm/organizations',
						'fields':[
							{'name':'search', 'type':'search', 'value':''},
							{'name':'page', 'type':'number', 'value':'1'},
							{'name':'pageSize', 'type':'number', 'value':'20'},
							{'name':'embedDepth', 'type':'number', 'value':'1'},
							{'name':'organizationTypeIds', 'type':'hidden', 'value':'5'}]
					}
				},
				_searchDepartmentsAction: {
					type: Object,
					value: {
						'name':'search-course-collection',
						'method':'GET',
						'href':'/d2l/api/hm/organizations',
						'fields':[
							{'name':'search', 'type':'search', 'value':''},
							{'name':'page', 'type':'number', 'value':'1'},
							{'name':'pageSize', 'type':'number', 'value':'20'},
							{'name':'embedDepth', 'type':'number', 'value':'1'},
							{'name':'organizationTypeIds', 'type':'hidden', 'value':'203'}]
					}
				},
				_semesterOrganizations: Object,
				_sortField: String,
				_parentOrganizationIds: {
					type: Array,
					value: function() {
						return [];
					}
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.CourseManagementBehavior
			],
			ready: function() {
				this.usePendingLists = true;

				// Both course tile grids in this view should have the same number of columns, so use a custom getter
				var courseTileGrids = Polymer.dom(this.root).querySelectorAll('d2l-course-tile-grid');
				for (var i = 0; i < courseTileGrids.length; i++) {
					courseTileGrids[i].getCourseTileItemCount = this.getCourseTileItemCount.bind(this);
				}
			},
			attached: function() {
				this._onResize();
				window.addEventListener('resize', this._onResize);

				this.listen(this.$.semesterSearchWidget, 'search-results-changed', '_onSemesterSearchResults');
				this.listen(this.$.departmentSearchWidget, 'search-results-changed', '_onDepartmentSearchResults');
				this.$.semesterSearchWidget.search();
				this.$.departmentSearchWidget.search();

				this.$.scrollThreshold.scrollTarget = this.$.filterDropdownContent.querySelector('.d2l-dropdown-content-container');
			},
			detached: function() {
				window.removeEventListener('resize', this._onResize);

				this.unlisten(this.$.semesterSearchWidget, 'search-results-changed', '_onSemesterSearchResults');
				this.unlisten(this.$.departmentSearchWidget, 'search-results-changed', '_onDepartmentSearchResults');
			},
			/*
			* Fetches set of focusable elements (all `<d2l-course-tile>`s)
			*
			* Required for accessibility, this specifies which elements within the element are intended to be
			* keyboard-focusable. This is because we're using `<iron-overlay with-backdrop>`. See
			* [those docs](https://github.com/PolymerElements/iron-overlay-behavior#backdrop) for more information.
			*
			* @return {Array<HTMLElement>} `<d2l-course-tile` HTMLElements
			*/
			focusableNodesOverride: function() {
				var courseTileFocusables = [];

				Polymer.dom(this.root).querySelectorAll('d2l-course-tile').forEach(function(courseTile) {
					Array.prototype.push.apply(courseTileFocusables, Polymer.dom(courseTile.root).querySelectorAll('a'));
				});

				return courseTileFocusables;
			},
			/*
			* Fetches the max value between the pinned and unpinned enrollments
			* @return {Number} Max(number of pinned enrollments, number of unpinned enrollments)
			*/
			getCourseTileItemCount: function() {
				var itemCount = Math.max(this.pinnedEnrollments.length, this.unpinnedEnrollments.length);

				return itemCount;
			},
			loadCourseTiles: function() {
				this.delayCourseTileLoad = false;
			},
			_numSemesterFilters: 0,
			_numDepartmentFilters: 0,
			_sortTextOptions: {
				'courseCode': 'sorting.sortCourseCode',
				'courseName': 'sorting.sortCourseName',
				'pinDate': 'sorting.sortDatePinned',
				'department': 'sorting.sortDepartment',
				'lastAccessed': 'sorting.sortLastAccessed'
			},
			_checkFilterEntities: function(entities) {
				entities.forEach(function(entity) {
					entity.properties.checked = this._parentOrganizationIds.indexOf(entity.properties.id.toString()) > -1;
				}.bind(this));
			},
			_clearFilters: function() {
				Polymer.dom(this.root).querySelectorAll('.dropdown-content-item input').forEach(function(checkbox) {
					checkbox.checked = false;
				});
				this._isFiltered = false;
				this._parentOrganizationIds = [];
				this.$.filterText.textContent = this.localize('filtering.filter');
				this.$.semesterListButton.textContent = this.localize('filtering.semester');
				this.$.departmentListButton.textContent = this.localize('filtering.department');
				this._numSemesterFilters = 0;
				this._numDepartmentFilters = 0;
			},
			_loadMore: function() {
				// Generate the request based off of which tab is selected, and whether there are more to load or not
				if (this.$.semesterList.classList.contains('hidden')) {
					if (this._hasMoreDepartments) {
						this.$.moreDepartmentsRequest.generateRequest();
					}
				} else {
					if (this._hasMoreSemesters) {
						this.$.moreSemesters.generateRequest();
					}
				}
				this.$.scrollThreshold.clearTriggers();
			},
			_onBlurFilterText: function() {
				this.toggleClass('highlight', false, this.$.filterText);
				this.toggleClass('selected', false, this.$.filterText);
			},
			_onBlurSortText: function() {
				this.toggleClass('highlight', false, this.$.sortText);
				this.toggleClass('selected', false, this.$.sortText);
			},
			_onFocusFilterText: function() {
				this.toggleClass('highlight', true, this.$.filterText);
				this.toggleClass('selected', true, this.$.filterText);
			},
			_onFocusSortText: function() {
				this.toggleClass('highlight', true, this.$.sortText);
				this.toggleClass('selected', true, this.$.sortText);
			},
			_onDepartmentSearchResults: function(e) {
				var entity = e.detail.value;

				this._checkFilterEntities(entity.entities);
				this.set('_departmentOrganizations', entity.entities);

				this.set('_moreDepartmentsUrl', entity.hasLinkByRel('next') ? entity.getLinkByRel('next').href : '');
				this.set('_hasMoreDepartments', this._moreDepartmentsUrl.length > 0);
			},
			_onSemesterSearchResults: function(e) {
				var entity = e.detail.value;

				this._checkFilterEntities(entity.entities);
				this.set('_semesterOrganizations', entity.entities);

				this.set('_moreSemestersUrl', entity.hasLinkByRel('next') ? entity.getLinkByRel('next').href : '');
				this.set('_hasMoreSemesters', this._moreSemestersUrl.length > 0);
			},
			_onMoreDepartmentsResponse: function(response) {
				if (response.detail.status === 200 || response.detail.status === 304) {
					var parser = document.createElement('d2l-siren-parser');
					var moreDepartments = parser.parse(response.detail.xhr.response);
					moreDepartments.entities.forEach(function(department) {
						this.push('_departmentOrganizations', department);
					}.bind(this));

					this.set('_moreDepartmentsUrl', moreDepartments.hasLinkByRel('next') ? moreDepartments.getLinkByRel('next').href : '');
					this.set('_hasMoreDepartments', this._moreDepartmentsUrl.length > 0);
				}
			},
			_onMoreSemestersResponse: function(response) {
				if (response.detail.status === 200 || response.detail.status === 304) {
					var parser = document.createElement('d2l-siren-parser');
					var moreSemesters = parser.parse(response.detail.xhr.response);
					moreSemesters.entities.forEach(function(semester) {
						this.push('_semesterOrganizations', semester);
					}.bind(this));

					this.set('_moreSemestersUrl', moreSemesters.hasLinkByRel('next') ? moreSemesters.getLinkByRel('next').href : '');
					this.set('_hasMoreSemesters', this._moreSemestersUrl.length > 0);
				}
			},
			_onResize: function() {
				this.toggleClass('hidden', window.innerWidth < 768, this.$.filterAndSort);
			},
			_selectSemesterList: function() {
				this._toggleSelectedList(this.$.semesterList, this.$.semesterListButton, this.$.semesterListHighlight, true);
				this._toggleSelectedList(this.$.departmentList, this.$.departmentListButton, this.$.departmentListHighlight, false);
				this.$.semesterSearchWidget.clear();
				this.$.departmentSearchWidget.clear();
			},
			_selectDepartmentList: function() {
				this._toggleSelectedList(this.$.departmentList, this.$.departmentListButton, this.$.departmentListHighlight, true);
				this._toggleSelectedList(this.$.semesterList, this.$.semesterListButton, this.$.semesterListHighlight, false);
				this.$.semesterSearchWidget.clear();
				this.$.departmentSearchWidget.clear();
			},
			_toggleSelectedList: function(list, button, highlight, selected) {
				this.toggleClass('hidden', !selected, list);
				this.toggleClass('selected', selected, button);
				this.toggleClass('invisible', !selected, highlight);
				button.setAttribute('aria-pressed', selected);
			},
			_toggleFilterDropdown: function() {
				this.$.filterDropdown.toggleOpen();
			},
			_toggleSortDropdown: function() {
				this.$.sortDropdown.toggleOpen();
			},
			_updateFilter: function(e) {
				var isSemester = this.$.semesterList.contains(e.target);

				if (e.target.checked) {
					this.push('_parentOrganizationIds', e.target.value);
					isSemester ? this._numSemesterFilters++ : this._numDepartmentFilters++;
				} else {
					var index = this._parentOrganizationIds.indexOf(e.target.value);
					this.splice('_parentOrganizationIds', index, 1);
					isSemester ? this._numSemesterFilters-- : this._numDepartmentFilters--;
				}

				if (this._parentOrganizationIds.length === 0) {
					this.$.filterText.textContent = this.localize('filtering.filter');
				} else if (this._parentOrganizationIds.length === 1) {
					this.$.filterText.textContent = this.localize('filtering.filterSingle');
				} else {
					this.$.filterText.textContent = this.localize('filtering.filterMultiple', 'num', this._parentOrganizationIds.length);
				}

				this._isFiltered = this._parentOrganizationIds.length > 0;
				this.$.semesterListButton.textContent = this._numSemesterFilters > 0
					? this.localize('filtering.semesterMultiple', 'num', this._numSemesterFilters)
					: this.localize('filtering.semester');
				this.$.departmentListButton.textContent = this._numDepartmentFilters > 0
					? this.localize('filtering.departmentMultiple', 'num', this._numDepartmentFilters)
					: this.localize('filtering.department');
			},
			_updateSortBy: function(e) {
				this._sortField = e.target.value;

				var buttons = Polymer.dom(this.root).querySelectorAll('#sortDropdown .dropdown-content-item');
				buttons.forEach(function(button) {
					this.toggleClass('selected', button.value === e.target.value, button);
				}.bind(this));

				var sortText = this.localize(this._sortTextOptions[this._sortField] || '');

				this.$.sortText.textContent = sortText;
			}
		});
	</script>
</dom-module>
