<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-content.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-menu/d2l-menu-item-radio.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-alert-behavior.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="d2l-filter-menu-content/d2l-filter-menu-content.html">
<link rel="import" href="d2l-search-widget-custom.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-simple-overlay.html">


<dom-module id="d2l-all-courses">
	<template>
		<style>
			:host {
				display: block;
			}
			h2 {
				/* overrides to d2l-heading-3 */
				margin: 20px 0 10px 0;
				font-size: 20px;
				/* end overrides */
			}
			d2l-alert {
				display: block;
				margin-bottom: 20px;
			}
			d2l-icon {
				--d2l-icon-height: 15px;
				--d2l-icon-width: 15px;
				margin-top: -0.35rem;
			}
			.d2l-all-courses-hidden {
				display: none !important;
			}
			.search-and-filter {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 50px;
			}
			.search-and-filter > d2l-search-widget-custom {
				flex: calc(5 / 12);
			}
			@media screen and (max-width: 767px) {
				.search-and-filter > d2l-search-widget-custom {
					flex: 1;
				}
				#filterAndSort {
					display: none;
				}
			}
			.search-and-filter > div {
				flex: calc(7 / 12);
				display: flex;
				justify-content: flex-end;
			}
			.dropdown-opener-text {
				@apply(--d2l-body-small-text);
				/* overrides to d2l-body-small-text */
				font-size: 0.95rem;
				color: var(--d2l-color-tungsten);
				/* end overrides */
				cursor: pointer;
				padding: 0;
				margin-left: 1rem;
			}
			.dropdown-button {
				background: none;
				border: none;
				cursor: pointer;
				padding: 0;
				color: var(--d2l-color-tungsten);
			}
			.dropdown-content-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				border-bottom: 1px solid var(--d2l-color-gypsum);
				width: 100%;
				padding: 20px;
			}
			@media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {
				#filterText {
					padding-top: 4px;
				}
			}
			#filterSection {
				display: flex;
			}
			#filterText {
				padding-right: 4px;
			}
			button[aria-pressed="true"] {
				color: var(--d2l-color-celestine);
			}
			button:focus > d2l-icon,
			button:hover > d2l-icon,
			button:focus > span,
			button:hover > span,
			#filterText:hover,
			#filterText:focus,
			#filterText:hover + d2l-dropdown button d2l-icon,
			#filterText:focus + d2l-dropdown button d2l-icon,
			.focus {
				text-decoration: underline;
				color: var(--d2l-color-celestine);
			}
			#lazyLoadSpinner {
				margin-bottom: 30px;
				padding-bottom: 30px;
				display: block;
				margin: auto;
			}

		</style>
		<d2l-ajax
			id="enrollmentsSearchRequest"
			url="[[_enrollmentsSearchUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_enrollmentsSearchResponse"
			last-response="{{lastEnrollmentsSearchResponse}}">
		</d2l-ajax>
		<d2l-simple-overlay
			id="all-courses"
			title-name="{{localize('allCourses')}}"
			locale="[[locale]]"
			with-backdrop>


		<iron-scroll-threshold
			id="all-courses-scroll-threshold"
			on-lower-threshold="_loadNextEnrollmentsPage">
		</iron-scroll-threshold>

		<div class="search-and-filter">
			<d2l-search-widget-custom
				id="search-widget"
				my-enrollments-entity="[[myEnrollmentsEntity]]"
				parent-organizations="[[_parentOrganizations]]"
				sort-field="[[_sortField]]">
			</d2l-search-widget-custom>

			<div id="filterAndSort" class="d2l-all-courses-hidden">
				<div id="filterSection" class="d2l-all-courses-hidden">
					<span id="filterText" class="dropdown-opener-text" on-tap="_toggleFilterDropdown">[[_filterText]]</span>
					<d2l-dropdown id="filterDropdown">
						<button
							id="filterDropdownOpener"
							class="d2l-dropdown-opener dropdown-button"
							on-focus="_focusFilterText"
							on-blur="_blurFilterText"
							on-mouseenter="_focusFilterText"
							on-mouseleave="_blurFilterText"
							aria-labelledby="filterText">
							<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
						</button>
						<d2l-dropdown-content id="filterDropdownContent" no-padding min-width="350" render-content>
							<d2l-filter-menu-content
								id="filterMenuContent"
								my-enrollments-entity="[[myEnrollmentsEntity]]">
							</d2l-filter-menu-content>
							<iron-scroll-threshold
								id="scrollThreshold"
								on-lower-threshold="_onLowerThreshold">
							</iron-scroll-threshold>
						</d2l-dropdown-content>
					</d2l-dropdown>
				</div>

				<d2l-dropdown id="sortDropdown">
					<button
						class="d2l-dropdown-opener dropdown-button"
						aria-labelledby="sortText">
						<span id="sortText" class="dropdown-opener-text">{{localize('sorting.sortDatePinned')}}</span>
						<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
					</button>
					<d2l-dropdown-menu no-padding min-width="350">
						<d2l-menu label="{{localize('sorting.sortBy')}}">
							<div class="dropdown-content-header">
								<span class="dropdown-content-header-text">{{localize('sorting.sortBy')}}</span>
							</div>
							<d2l-menu-item-radio class="dropdown-content-gradient" value="courseCode" text="{{localize('sorting.courseCode')}}"></d2l-menu-item-radio>
							<d2l-menu-item-radio value="courseName" text="{{localize('sorting.courseName')}}"></d2l-menu-item-radio>
							<d2l-menu-item-radio value="pinDate" text="{{localize('sorting.datePinned')}}" selected></d2l-menu-item-radio>
							<d2l-menu-item-radio value="lastAccessed" text="{{localize('sorting.lastAccessed')}}"></d2l-menu-item-radio>
						</d2l-menu>
					</d2l-dropdown-menu>
				</d2l-dropdown>
			</div>
		</div>

		<h2 class="d2l-heading-3">{{localize('pinnedCourses')}}</h2>

		<template is="dom-repeat" items="{{_alerts}}">
			<d2l-alert type="[[item.alertType]]">
				{{item.alertMessage}}
			</d2l-alert>
		</template>

		<d2l-course-tile-grid
			id="all-courses-pinned"
			enrollments="{{filteredPinnedEnrollments}}"
			enrollments-queue="{{filteredPinnedEnrollmentsQueue}}"
			delay-load="[[delayLoad]]"
			tile-sizes="[[_tileSizes]]"
			show-course-code="[[showCourseCode]]">
		</d2l-course-tile-grid>

		<h2 class="d2l-heading-3">{{localize('unpinnedCourses')}}</h2>

		<d2l-course-tile-grid
			id="all-courses-unpinned"
			enrollments="{{filteredUnpinnedEnrollments}}"
			enrollments-queue="{{filteredUnpinnedEnrollmentsQueue}}"
			delay-load="[[delayLoad]]"
			tile-sizes="[[_tileSizes]]"
			show-course-code="[[showCourseCode]]">
		</d2l-course-tile-grid>
			<d2l-loading-spinner
				id="lazyLoadSpinner"
				class="d2l-all-courses-hidden"
				size="100">
			</d2l-loading-spinner>
		</d2l-simple-overlay>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-all-courses',
			properties: {
				// URL constructed to fetch a user's enrollments with the enrollments search Action
				_enrollmentsSearchUrl: String,
					// Set of pinned enrollment Entities
				pinnedEnrollments: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true,
					observer: '_setFilteredPinnedEnrollments'
				},
				// filtered pinned enrollment entities
				filteredPinnedEnrollments: {
					type: Array,
					value: function() {
						return [];
					}
				},
				// Set of unpinned enrollment Entities
				unpinnedEnrollments: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true,
					observer: '_setFilteredUnpinnedEnrollments'
				},
				filteredUnpinnedEnrollments: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				// Set of enrollments Entities that are being transferred from unpinned to pinned state
				// Only used by `d2l-all-courses`
				pinnedEnrollmentsQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				filteredPinnedEnrollmentsQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				// Set of enrollments that are being transferred from pinned to unpinned state
				// Only used by `d2l-all-courses`
				unpinnedEnrollmentsQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				filteredUnpinnedEnrollmentsQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				// Object containing the IDs of previously loaded pinned enrollments, to avoid duplicates
				_pinnedCoursesMap: {
					type: Object,
					value: function() {
						return {};
					}
				},
				// Object containing the IDs of previously loaded unpinned enrollments, to avoid duplicates
				_unpinnedCoursesMap: {
					type: Object,
					value: function() {
						return {};
					}
				},

				// True when there are filtered pinned enrollments (i.e. `filteredPinnedEnrollments.length > 0`)
				_hasFilteredPinnedEnrollments: {
					type: Boolean,
					value: false
				},

				// True when there are any filtered enrollments (pinned or unpinned)
				_hasFilteredEnrollments: {
					type: Boolean,
					value: false
				},
				// Sets the delay-load property on the course tile grid
				delayLoad: {
					type: Boolean,
					value: true
				},
				myEnrollmentsEntity: {
					type: Object,
					value: function() {
						return {};
					}
				},
				// Object containing the last response from an enrollments search request
				lastEnrollmentsSearchResponse: Object,
				_filterText: String,
				_sortField: {
					type: String,
					value: 'pinDate'
				},
				_tileSizes: Object,
				_parentOrganizations: {
					type: Array,
					value: function() {
						return [];
					}
				}
			},
			behaviors: [
				window.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				window.D2L.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.UtilityBehavior,
				window.D2L.MyCourses.AlertBehavior
			],
			listeners: {
				'd2l-simple-overlay-opening': '_onSimpleOverlayOpening',
				'tile-remove-complete': '_onTileRemoveComplete',
				'enrollment-pin-complete': '_onEnrollmentPinComplete',
				'enrollment-unpin-complete': '_onEnrollmentUnpinComplete',
				'd2l-search-enrollment-response': '_updateFilteredEnrollmentsEvent'
			},
			observers: [
				'_updateEnrollmentAlerts(_hasFilteredPinnedEnrollments)',
				'_enrollmentsChanged(filteredPinnedEnrollments.length, filteredPinnedEnrollmentsQueue.length, filteredUnpinnedEnrollments.length, filteredUnpinnedEnrollmentsQueue.length)'
			],
			created: function() {
				this._tilesInPinStateTransition = [];
			},
			_loadNextEnrollmentsPage: function() {
				if (this.$['all-courses'].opened && this.lastEnrollmentsSearchResponse) {
					var parser = document.createElement('d2l-siren-parser');
					var lastResponseEntity = parser.parse(this.lastEnrollmentsSearchResponse);

					if (lastResponseEntity && lastResponseEntity.hasLink('next')) {
						this._enrollmentsSearchUrl = lastResponseEntity.getLinkByRel('next').href;
						this.toggleClass('d2l-all-courses-hidden', false, this.$.lazyLoadSpinner);
						this.$.lazyLoadSpinner.scrollIntoView();
						this.$.enrollmentsSearchRequest.generateRequest();
					}
				}
			},
			_enrollmentsChanged: function() {
				this._hasFilteredPinnedEnrollments =
					this.filteredPinnedEnrollments.length > 0 ||
					this.filteredPinnedEnrollmentsQueue.length > 0;
				// Need to factor in queues here - if user has 1 enrollment, it will briefly
				// disappear from both enrollments arrays when pinned/unpinned
				this._hasFilteredEnrollments =
					this._hasFilteredPinnedEnrollments ||
					this.filteredUnpinnedEnrollments.length > 0 ||
					this.filteredUnpinnedEnrollmentsQueue.length > 0;
				this.$['all-courses-scroll-threshold'].clearTriggers();
			},
			_moveEnrollmentToPinnedList: function(enrollment) {
				// Remove enrollment from unpinned list, add to pinned
				var enrollmentId = this.getEntityIdentifier(enrollment);

				for (var index = 0; index < this.filteredUnpinnedEnrollments.length; index++) {
					var pinnedEnrollmentId = this.getEntityIdentifier(this.filteredUnpinnedEnrollments[index]);
					if (pinnedEnrollmentId === enrollmentId) {
						var foundEnrollment = this.filteredUnpinnedEnrollments[index];
						this._setEnrollmentPinData(foundEnrollment, true);
						this.push('pinnedEnrollments', foundEnrollment);
						this.push('filteredPinnedEnrollmentsQueue', foundEnrollment);
						this.splice('unpinnedEnrollments', index, 1);
						this.splice('filteredUnpinnedEnrollments', index, 1);
						break;
					}
				}
			},
			_moveEnrollmentToUnpinnedList: function(enrollment) {
				// Remove enrollment from pinned list, add to unpinned
				var enrollmentId = this.getEntityIdentifier(enrollment);

				for (var index = 0; index < this.filteredPinnedEnrollments.length; index++) {
					var unpinnedEnrollmentId = this.getEntityIdentifier(this.filteredPinnedEnrollments[index]);
					if (unpinnedEnrollmentId === enrollmentId) {
						var foundEnrollment = this.filteredPinnedEnrollments[index];
						this._setEnrollmentPinData(foundEnrollment, false);
						this.push('unpinnedEnrollments', foundEnrollment);
						this.push('filteredUnpinnedEnrollmentsQueue', foundEnrollment);
						this.splice('pinnedEnrollments', index, 1);
						this.splice('filteredPinnedEnrollments', index, 1);
						break;
					}
				}
			},
			_onTileRemoveComplete: function(e) {
				e.stopPropagation();
				if (e.detail.pinned) {
					this._moveEnrollmentToPinnedList(e.detail.enrollment);
				} else {
					this._moveEnrollmentToUnpinnedList(e.detail.enrollment);
				}
			},
			_setEnrollmentPinData: function(entity, isPinned) {
				// HACK: Because the course tiles are being removed and re-created in the DOM, we have to effectively
				// manually update them, rather than updating them with the received enrollment from the API call.
				if (isPinned) {
					entity.class.splice(entity.class.indexOf('unpinned'));
					entity.class.push('pinned');
					entity.actions[0].name = 'unpin-course';
					entity.actions[0].fields[0].value = false;
					entity._actionsByName['unpin-course'] = entity.actions[0];
				} else {
					entity.class.splice(entity.class.indexOf('pinned'));
					entity.class.push('unpinned');
					entity.actions[0].name = 'pin-course';
					entity.actions[0].fields[0].value = true;
					entity._actionsByName['pin-course'] = entity.actions[0];
				}
			},
			_updateFilteredEnrollmentsEvent: function(e, detail) {
				this._pinnedCoursesMap = {};
				this._unpinnedCoursesMap = {};
				this._updateFilteredEnrollments(detail, false);
			},
			_enrollmentsSearchResponse: function(response) {
				this._updateFilteredEnrollments(response, true);
			},
			_updateFilteredEnrollments: function(response, append) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var enrollments = parser.parse(response.detail.xhr.response);
					var enrollmentEntities = enrollments.getSubEntitiesByClass('enrollment');
					var newPinnedEnrollments = [];
					var newUnpinnedEnrollments = [];
					enrollmentEntities.forEach(function(enrollment) {
						var enrollmentId = this.getEntityIdentifier(enrollment);
						if (enrollment.hasClass('pinned')) {
							if (!this._pinnedCoursesMap.hasOwnProperty(enrollmentId)) {
								newPinnedEnrollments.push(enrollment);
								this._pinnedCoursesMap[enrollmentId] = true;
							}
						} else {
							if (!this._unpinnedCoursesMap.hasOwnProperty(enrollmentId)) {
								newUnpinnedEnrollments.push(enrollment);
								this._unpinnedCoursesMap[enrollmentId] = true;
							}
						}
					}, this);

					if (append) {
						this.filteredPinnedEnrollments = this.filteredPinnedEnrollments.concat(newPinnedEnrollments);
						this.filteredUnpinnedEnrollments = this.filteredUnpinnedEnrollments.concat(newUnpinnedEnrollments);
					} else {
						this.filteredPinnedEnrollments = newPinnedEnrollments;
						this.filteredUnpinnedEnrollments = newUnpinnedEnrollments;
					}
					var colNum = this._calcNumColumns(this._getAvailableWidth(Polymer.dom(this.root).node.host), this.filteredPinnedEnrollments.length);
					this._tileSizes = (colNum === 2) ?
						{ mobile: { maxwidth: 767, size: 50 }, tablet: { maxwidth: 1243, size: 33 }, desktop: { size: 20 } } :
						{ mobile: { maxwidth: 767, size: 100 }, tablet: { maxwidth: 1243, size: 67 }, desktop: { size: 25 } };

					this.fire('recalculate-columns');
					this.toggleClass('d2l-all-courses-hidden', true, this.$.lazyLoadSpinner);
					this.$['all-courses-scroll-threshold'].clearTriggers();
					this.lastEnrollmentsSearchResponse = enrollments;
				}
			},
			ready: function() {
				this._updateEnrollmentAlerts(this._hasFilteredPinnedEnrollments);

				// Both course tile grids in this view should have the same number of columns, so use a custom getter
				var courseTileGrids = Polymer.dom(this.root).querySelectorAll('d2l-course-tile-grid');
				for (var i = 0; i < courseTileGrids.length; i++) {
					courseTileGrids[i].getCourseTileItemCount = this.getCourseTileItemCount.bind(this);
				}
				this._updateTileSizes();

				this._filterText = this.localize('filtering.filter');
			},
			attached: function() {
				this.listen(this.$.sortDropdown, 'd2l-menu-item-change', '_updateSortBy');
				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.listen(this.$.filterMenuContent, 'd2l-filter-menu-content-change', '_onFilterChanged');
				this.listen(this.$.filterMenuContent, 'd2l-filter-menu-content-hide', '_onFilterHideChanged');

				this.$.scrollThreshold.scrollTarget = this.$.filterDropdownContent.querySelector('.d2l-dropdown-content-container');

				window.addEventListener('resize', this._onResize.bind(this));
			},
			detached: function() {
				this.unlisten(this.$.sortDropdown, 'd2l-menu-item-change', '_updateSortBy');
				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.unlisten(this.$.filterMenuContent, 'd2l-filter-menu-content-change', '_onFilterChanged');
				this.unlisten(this.$.filterMenuContent, 'd2l-filter-menu-content-hide', '_onFilterHideChanged');
			},
			getCourseTileItemCount: function() {
				var itemCount = Math.max(this.pinnedEnrollments.length, this.unpinnedEnrollments.length);
				return itemCount;
			},
			_setFilteredPinnedEnrollments: function() {
				this.filteredPinnedEnrollments = [];
				this.filteredPinnedEnrollments = this.pinnedEnrollments;
			},
			_setFilteredUnpinnedEnrollments: function() {
				this.filteredUnpinnedEnrollments = [];
				this.filteredUnpinnedEnrollments = this.unpinnedEnrollments;
			},
			load: function() {
				// Load course tile and filter contents. Called from d2l-my-courses.
				this.$$('#all-courses').open();
				this.$['all-courses-scroll-threshold'].scrollTarget = this.$['all-courses'].scrollRegion;
				this.$['all-courses-scroll-threshold'].clearTriggers();
				this.$['search-widget']._searchString = '';
				this._pinnedCouresMap = {};
				this._unpinnedCoursesMap = {};
				this.filteredPinnedEnrollments = this.pinnedEnrollments;
				this.filteredUnpinnedEnrollments = this.unpinnedEnrollments;
				this.filteredPinnedEnrollments.forEach(function(enrollment) {
					this._pinnedCoursesMap[this.getEntityIdentifier(enrollment)] = true;
				}, this);
				this.filteredPinnedEnrollments.forEach(function(enrollment) {
					this._unpinnedCoursesMap[this.getEntityIdentifier(enrollment)] = true;
				}, this);
				this.set('delayLoad', false);

				// Only make the call to load the filter menu contents if user has a
				// substantial number of enrollments - otherwise, hide the filter menu
				if (this.pinnedEnrollments.length + this.unpinnedEnrollments.length >= 20) {
					this.$.filterMenuContent.load();
					this.toggleClass('d2l-all-courses-hidden', false, this.$.filterAndSort);
				}
			},
			setCourseImage: function(details) {
				this._removeAlert('setCourseImageFailure');
				if (details && details.detail) {
					if (details.detail.status === 'failure') {
						setTimeout(function() {
							this._addAlert('warning', 'setCourseImageFailure', this.localize('error.settingImage'));
						}.bind(this), 1000); // delay until the tile fail icon animation begins to kick in (1 sec delay)
					}
				}
				this.$$('#all-courses-pinned').setCourseImage(details);
				this.$$('#all-courses-unpinned').setCourseImage(details);
			},
			_filterDropdownOpen: false,
			_sortTextOptions: {
				'courseCode': 'sorting.sortCourseCode',
				'courseName': 'sorting.sortCourseName',
				'pinDate': 'sorting.sortDatePinned',
				'lastAccessed': 'sorting.sortLastAccessed'
			},
			_blurFilterText: function() {
				// Only de-highlight text if focus has moved AND we're not hovering over the opener button anymore
				// Without this check, the text de-highlights once the dropdown is opened as focus moves to the tabs
				if (this.$$('#filterDropdownOpener:focus') === null && this.$$('#filterDropdownOpener:hover') === null) {
					this.toggleClass('focus', false, this.$.filterText);
				}
			},
			_focusFilterText: function() {
				this.toggleClass('focus', true, this.$.filterText);
			},
			_onFilterChanged: function(e) {
				this.set('_parentOrganizations', e.detail.filters);
				this.set('_filterText', e.detail.text);
			},
			_onFilterDropdownClose: function() {
				// If the dropdown is closed by clicking elsewhere, we need to manually update _filterDropdownOpen
				// since _toggleFilterDropdown doesn't run.
				// Timeout is to ensure this runs after _toggleFilterDropdown when it's clicked closed
				setTimeout(function() {
					this.set('_filterDropdownOpen', false);
				}.bind(this), 100);
			},
			_onFilterHideChanged: function(e) {
				this.toggleClass('d2l-all-courses-hidden', e.detail.hide, this.$.filterSection);
			},
			_onLowerThreshold: function() {
				this.$.scrollThreshold.clearTriggers();
				this.$.filterMenuContent.loadMore();
			},
			_onResize: function() {
				this._updateTileSizes();
			},
			_onSimpleOverlayOpening: function() {
				this._removeAlert('setCourseImageFailure');
			},
			_toggleFilterDropdown: function() {
				// This is somewhat gross, but is a side effect of using the filter text span as a secondary opener
				if (this._filterDropdownOpen) {
					this.$.filterDropdownContent.close();
					this.$.filterDropdownOpener.focus();
				} else {
					this.$.filterDropdownContent.open();
					this.$.filterMenuContent.load();
				}
				this.set('_filterDropdownOpen', !this._filterDropdownOpen);
			},
			_updateSortBy: function(e) {
				this.set('_sortField', e.detail.value);
				this.$.sortText.textContent = this.localize(this._sortTextOptions[this._sortField] || '');
				this.$.sortDropdown.toggleOpen();
			},
			_updateEnrollmentAlerts: function(hasPinnedEnrollments) {
				this._clearAlerts();

				if (!hasPinnedEnrollments) {
					this._addAlert('call-to-action', 'noPinnedCourses', this.localize('noPinnedCoursesMessage'));
				}
			},
			_updateTileSizes: function() {
				this._rescaleCourseTileRegions();
				this._tileSizes = Math.floor(100 / this._numColsOverlay) + 'vw';
			}
		});
	</script>
</dom-module>
