<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-alert/d2l-alert.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-content.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="../d2l-menu/d2l-menu-item-radio.html">
<link rel="import" href="../d2l-organization-hm-behavior/d2l-organization-hm-behavior.html">
<link rel="import" href="../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="d2l-alert-behavior.html">
<link rel="import" href="d2l-all-courses-styles.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="d2l-filter-menu/d2l-filter-menu.html">
<link rel="import" href="d2l-search-widget-custom.html">
<link rel="import" href="d2l-utility-behavior.html">
<link rel="import" href="localize-behavior.html">

<dom-module id="d2l-all-courses">
	<template>
		<style include="d2l-all-courses-styles"></style>

		<d2l-simple-overlay
			id="all-courses"
			title-name="{{localize('allCourses')}}"
			close-simple-overlay-alt-text="{{localize('closeSimpleOverlayAltText')}}"
			with-backdrop
			restore-focus-on-close>

			<div hidden$="[[!_showContent]]">
				<iron-scroll-threshold
					id="all-courses-scroll-threshold"
					on-lower-threshold="_onAllCoursesLowerThreshold">
				</iron-scroll-threshold>

				<div id="search-and-filter">
					<div class="search-and-filter-row">
						<d2l-search-widget-custom
							id="search-widget"
							search-button-label="{{localize('search')}}"
							clear-button-label="{{localize('search.clearSearch')}}"
							search-action="[[_enrollmentsSearchAction]]"
							search-url="[[_searchUrl]]">
						</d2l-search-widget-custom>

						<div id="filterAndSort">
							<d2l-dropdown id="filterDropdown">
								<button
									class="d2l-dropdown-opener dropdown-button"
									aria-labelledby="filterText">
									<span id="filterText" class="dropdown-opener-text">[[_filterText]]</span>
									<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
								</button>
								<d2l-dropdown-content id="filterDropdownContent" no-padding min-width="350" render-content>
									<d2l-filter-menu
										id="filterMenu"
										my-enrollments-entity="[[myEnrollmentsEntity]]",
										filter-standard-semester-name="[[filterStandardSemesterName]]",
										filter-standard-department-name="[[filterStandardDepartmentName]]">
									</d2l-filter-menu>
								</d2l-dropdown-content>
							</d2l-dropdown>

							<d2l-dropdown id="sortDropdown">
								<button
									class="d2l-dropdown-opener dropdown-button"
									aria-labelledby="sortText">
									<span id="sortText" class="dropdown-opener-text">{{localize('sorting.sortCourseName')}}</span>
									<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
								</button>
								<d2l-dropdown-menu no-padding min-width="350">
									<d2l-menu id="sortDropdownMenu" label="{{localize('sorting.sortBy')}}">
										<div class="dropdown-content-header">
											<span>{{localize('sorting.sortBy')}}</span>
										</div>
										<d2l-menu-item-radio class="dropdown-content-gradient" value="OrgUnitName" text="{{localize('sorting.sortCourseName')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="OrgUnitCode" text="{{localize('sorting.sortCourseCode')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="PinDate" text="{{localize('sorting.sortDatePinned')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="LastAccessed" text="{{localize('sorting.sortLastAccessed')}}"></d2l-menu-item-radio>
									</d2l-menu>
								</d2l-dropdown-menu>
							</d2l-dropdown>
						</div>
					</div>
					<div class="search-and-filter-row advanced-search-link" hidden$="[[!_showAdvancedSearchLink]]" >
						<a is="d2l-link" href$="[[advancedSearchUrl]]">{{localize('advancedSearch')}}</a>
					</div>
				</div>

				<h2>{{localize('pinnedCourses')}}</h2>

				<span hidden$="[[!_noPinnedCoursesInSearch]]">
					{{localize('noPinnedCoursesInSearch')}}
				</span>
				<span hidden$="[[!_noPinnedCoursesInSelection]]">
					{{localize('noPinnedCoursesInSelection')}}
				</span>

				<template is="dom-repeat" items="{{_alerts}}">
					<d2l-alert type="[[item.alertType]]">
						{{item.alertMessage}}
					</d2l-alert>
				</template>

				<d2l-course-tile-grid
					id="all-courses-pinned"
					enrollments="[[_filteredPinnedEnrollments]]"
					enrollments-to-animate="[[_pinnedEnrollmentsToAnimate]]"
					delay-load="[[delayLoad]]"
					tile-sizes="[[_tileSizes]]"
					locale="[[locale]]"
					show-course-code="[[showCourseCode]]"
					show-semester="[[showSemester]]"
					course-updates-config="[[courseUpdatesConfig]]">
				</d2l-course-tile-grid>

				<h2>{{localize('unpinnedCourses')}}</h2>

				<span class="bottom-pad" hidden$="[[!_noUnpinnedCoursesInSearch]]">
					{{localize('noUnpinnedCoursesInSearch')}}
				</span>
				<span class="bottom-pad" hidden$="[[!_noUnpinnedCoursesInSelection]]">
					{{localize('noUnpinnedCoursesInSelection')}}
				</span>
				<span class="bottom-pad" hidden$="[[!_noUnpinnedCourses]]">
					{{localize('noUnpinnedCoursesMessage')}}
				</span>

				<d2l-course-tile-grid
					id="all-courses-unpinned"
					enrollments="[[_filteredUnpinnedEnrollments]]"
					enrollments-to-animate="[[_unpinnedEnrollmentsToAnimate]]"
					delay-load="[[delayLoad]]"
					tile-sizes="[[_tileSizes]]"
					locale="[[locale]]"
					show-course-code="[[showCourseCode]]"
					show-semester="[[showSemester]]"
					course-updates-config="[[courseUpdatesConfig]]">
				</d2l-course-tile-grid>

				<d2l-loading-spinner
					id="lazyLoadSpinner"
					hidden$="[[!_hasMoreEnrollments]]"
					size="100">
				</d2l-loading-spinner>
			</div>
			<d2l-loading-spinner
				hidden$="[[_showContent]]"
				size="100">
			</d2l-loading-spinner>
		</d2l-simple-overlay>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-all-courses',
			properties: {
				/*
				* Public Polymer properties
				*/

				// URL that directs to the advanced search page
				advancedSearchUrl: String,
				// Types of notifications to include in update count in course tile
				courseUpdatesConfig: Object,
				// Default option in Sort menu
				defaultSortValue: {
					type: String,
					value: 'OrgUnitName'
				},
				// Sets the delay-load property on the course tile grid
				delayLoad: {
					type: Boolean,
					value: true
				},
				// Standard Department OU Type name to be displayed in the filter dropdown
				filterStandardDepartmentName: String,
				// Standard Semester OU Type name to be displayed in the filter dropdown
				filterStandardSemesterName: String,
				// Object containing the last response from an enrollments search request
				lastEnrollmentsSearchResponse: Object,
				// Entity returned from my-enrollments Link from the enrollments root
				myEnrollmentsEntity: {
					type: Object,
					value: function() { return {}; },
					observer: '_myEnrollmentsEntityChanged'
				},
				// Set of pinned enrollment Entities
				pinnedEnrollments: {
					type: Array,
					value: function() { return []; },
					observer: '_pinnedEnrollmentsChanged'
				},
				showCourseCode: Boolean,
				showSemester: Boolean,
				// Set of unpinned enrollment Entities
				unpinnedEnrollments: {
					type: Array,
					value: function() { return []; },
					observer: '_unpinnedEnrollmentsChanged'
				},

				/*
				* Private Polymer properties
				*/

				// search-my-enrollments Action
				_enrollmentsSearchAction: Object,
				// URL constructed to fetch a user's enrollments with the enrollments search Action
				_enrollmentsSearchUrl: String,
				// Filter dropdown opener text
				_filterText: String,
				// filtered pinned enrollment entities
				_filteredPinnedEnrollments: {
					type: Array,
					value: function() { return []; }
				},
				_filteredUnpinnedEnrollments: {
					type: Array,
					value: function() { return []; }
				},
				// True when there are any filtered enrollments (pinned or unpinned)
				_hasFilteredEnrollments: Boolean,
				// True when there are filtered pinned enrollments (i.e. `_filteredPinnedEnrollments.length > 0`)
				_hasFilteredPinnedEnrollments: Boolean,
				// True when there are filtered unpinned enrollments (i.e. `_filteredUnpinnedEnrollments.length > 0`)
				_hasFilteredUnpinnedEnrollments: Boolean,
				// True when there are more enrollments to fetch (i.e. current page of enrollments has a `next` link)
				_hasMoreEnrollments: {
					type: Boolean,
					computed: '_computeHasMoreEnrollments(lastEnrollmentsSearchResponse)'
				},
				_noPinnedCoursesInSearch: Boolean,
				_noPinnedCoursesInSelection: Boolean,
				_noUnpinnedCoursesInSearch: Boolean,
				_noUnpinnedCoursesInSelection: Boolean,
				_noUnpinnedCourses: Boolean,
				// Object containing the IDs of previously loaded pinned enrollments, to avoid duplicates
				_pinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				_pinnedEnrollmentsToAnimate: {
					type: Array,
					value: function() { return []; }
				},
				// URL passed to search widget, called for searching
				_searchUrl: String,
				_showAdvancedSearchLink: {
					type: Boolean,
					value: false,
					computed: '_computeShowAdvancedSearchLink(advancedSearchUrl)'
				},
				_showContent: {
					type: Boolean,
					value: false
				},
				_tileSizes: Object,
				// Object containing the IDs of previously loaded unpinned enrollments, to avoid duplicates
				_unpinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				_unpinnedEnrollmentsToAnimate: {
					type: Array,
					value: function() { return []; }
				},
				// Number of filters currently selected; used to change opener text when menu closes
				_filterCount: {
					type: Number,
					value: 0
				}
			},
			behaviors: [
				window.D2L.Hypermedia.HMConstantsBehavior,
				window.D2L.Hypermedia.OrganizationHMBehavior,
				window.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				window.D2L.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.CourseManagementBehavior,
				window.D2L.MyCourses.UtilityBehavior,
				window.D2L.MyCourses.AlertBehavior
			],
			listeners: {
				'd2l-simple-overlay-opening': '_onSimpleOverlayOpening',
				'tile-remove-complete': '_onTileRemoveComplete'
			},
			observers: [
				'_updateEnrollmentAlerts(_hasFilteredPinnedEnrollments, _hasFilteredUnpinnedEnrollments)',
				'_enrollmentsChanged(_filteredPinnedEnrollments.length, _filteredUnpinnedEnrollments.length)'
			],
			ready: function() {
				this._updateEnrollmentAlerts(this._hasFilteredPinnedEnrollments, this._hasFilteredUnpinnedEnrollments);

				// Both course tile grids in this view should have the same number of columns, so use a custom getter
				var courseTileGrids = Polymer.dom(this.root).querySelectorAll('d2l-course-tile-grid');
				for (var i = 0; i < courseTileGrids.length; i++) {
					courseTileGrids[i].getCourseTileItemCount = this.getCourseTileItemCount.bind(this);
				}
				this._updateTileSizes();

				this._filterText = this.localize('filtering.filter');
				this.$.sortDropdownMenu.querySelector('d2l-menu-item-radio[value=' + this.defaultSortValue + ']').selected = true;
			},
			attached: function() {
				this.listen(this.$.sortDropdown, 'd2l-menu-item-change', '_onSortOrderChanged');
				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-open', '_onFilterDropdownOpen');
				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.listen(this.$.filterMenu, 'd2l-filter-menu-change', '_onFilterChanged');
				this.listen(this.$['search-widget'], 'd2l-search-widget-results-changed', '_onSearchResultsChanged');

				window.addEventListener('resize', this._onResize.bind(this));
			},
			detached: function() {
				this.unlisten(this.$.sortDropdown, 'd2l-menu-item-change', '_onSortOrderChanged');
				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-open', '_onFilterDropdownOpen');
				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.unlisten(this.$.filterMenu, 'd2l-filter-menu-change', '_onFilterChanged');
				this.unlisten(this.$['search-widget'], 'd2l-search-widget-results-changed', '_onSearchResultsChanged');
			},

			/*
			* Public API methods
			*/

			getCourseTileItemCount: function() {
				var itemCount = Math.max(this.pinnedEnrollments ? this.pinnedEnrollments.length : 0,
					this.unpinnedEnrollments ? this.unpinnedEnrollments.length : 0);
				return itemCount;
			},
			load: function() {
				// Load course tile and filter contents. Called from d2l-my-courses.
				this.$['all-courses-scroll-threshold'].scrollTarget = this.$['all-courses'].scrollRegion;
				this.$['all-courses-scroll-threshold'].clearTriggers();
				this._filteredPinnedEnrollments.forEach(function(enrollment) {
					this._pinnedCoursesMap[this.getEntityIdentifier(enrollment)] = true;
				}, this);
				this._filteredPinnedEnrollments.forEach(function(enrollment) {
					this._unpinnedCoursesMap[this.getEntityIdentifier(enrollment)] = true;
				}, this);
				this.set('delayLoad', false);

				requestAnimationFrame(function() {
					this.fire('recalculate-columns');
					this._showContent = true;
				}.bind(this));
			},
			open: function() {
				this.$$('#all-courses').open();
			},
			setCourseImage: function(details) {
				this._removeAlert('setCourseImageFailure');
				if (details && details.detail) {
					if (details.detail.status === 'failure') {
						setTimeout(function() {
							this._addAlert('warning', 'setCourseImageFailure', this.localize('error.settingImage'));
						}.bind(this), 1000); // delay until the tile fail icon animation begins to kick in (1 sec delay)
					}
				}
				this.$$('#all-courses-pinned').setCourseImage(details);
				this.$$('#all-courses-unpinned').setCourseImage(details);
			},

			/*
			* Listeners
			*/

			_onAllCoursesLowerThreshold: function() {
				if (this.$['all-courses'].opened && this.lastEnrollmentsSearchResponse) {
					var lastResponseEntity = this.parseEntity(this.lastEnrollmentsSearchResponse);

					if (lastResponseEntity && lastResponseEntity.hasLinkByRel('next')) {
						this._enrollmentsSearchUrl = lastResponseEntity.getLinkByRel('next').href;
						this.$.lazyLoadSpinner.scrollIntoView();

						return this.fetchSirenEntity(this._enrollmentsSearchUrl)
							.then(function(enrollmentsEntity) {
								this._updateFilteredEnrollments(enrollmentsEntity, true);
							}.bind(this));
					}
				}
			},
			_onFilterChanged: function(e) {
				this._searchUrl = e.detail.url;
				this._filterCount = e.detail.filterCount;
			},
			_onFilterDropdownClose: function() {
				var text;
				if (this._filterCount === 0) {
					text = this.localize('filtering.filter');
				} else if (this._filterCount === 1) {
					text = this.localize('filtering.filterSingle');
				} else {
					text = this.localize('filtering.filterMultiple', 'num', this._filterCount);
				}
				this.set('_filterText', text);
			},
			_onFilterDropdownOpen: function() {
				this.set('_filterText', this.localize('filtering.filter'));
				return this.$.filterMenu.open();
			},
			_onResize: function() {
				this._updateTileSizes();
			},
			_onSortOrderChanged: function(e) {
				var queryParameter, langterm;

				switch (e.detail.value) {
					case 'OrgUnitCode':
						langterm = 'sorting.sortCourseCode';
						queryParameter = '-PinDate,OrgUnitCode,OrgUnitId';
						break;
					case 'PinDate':
						langterm = 'sorting.sortDatePinned';
						queryParameter = '-PinDate,OrgUnitId';
						break;
					case 'LastAccessed':
						langterm = 'sorting.sortLastAccessed';
						// Note: Sorting by LastAccessed is done differently LMS-side, hence this being different
						queryParameter = 'LastAccessed';
						break;
					default: // Includes 'OrgUnitName', which is the default sort order
						langterm = 'sorting.sortCourseName';
						queryParameter = '-PinDate,OrgUnitName,OrgUnitId';
						break;
				}

				this._searchUrl = this.createActionUrl(this._enrollmentsSearchAction, {
					sort: queryParameter
				});

				this.$.sortText.textContent = this.localize(langterm || '');
				this.$.sortDropdown.toggleOpen();
			},
			_onSearchResultsChanged: function(e) {
				this._pinnedCoursesMap = {};
				this._unpinnedCoursesMap = {};
				this._updateFilteredEnrollments(e.detail, false);
				this.myEnrollmentsEntity = e.detail;
			},
			_onSimpleOverlayOpening: function() {
				this._removeAlert('setCourseImageFailure');
				this._clearSearchWidget();
				this.$.filterMenu.clearFilters();
				this._filterText = this.localize('filtering.filter');
				this._resetSortDropdown();
			},
			_onTileRemoveComplete: function(e) {
				if (e.detail.pinned) {
					this._moveEnrollmentToPinnedList(e.detail.enrollment);
				} else {
					this._moveEnrollmentToUnpinnedList(e.detail.enrollment);
				}
			},

			/*
			* Observers
			*/

			_enrollmentsChanged: function() {
				this._hasFilteredPinnedEnrollments = this._filteredPinnedEnrollments.length > 0;
				this._hasFilteredUnpinnedEnrollments = this._filteredUnpinnedEnrollments.length > 0;
				this._hasFilteredEnrollments = this._hasFilteredPinnedEnrollments || this._hasFilteredUnpinnedEnrollments;
				this.$['all-courses-scroll-threshold'].clearTriggers();
			},
			_myEnrollmentsEntityChanged: function(entity) {
				if (entity) {
					var myEnrollmentsEntity = this.parseEntity(entity);

					if (myEnrollmentsEntity.hasActionByName(this.HypermediaActions.enrollments.searchMyEnrollments)) {
						this._enrollmentsSearchAction = myEnrollmentsEntity.getActionByName(this.HypermediaActions.enrollments.searchMyEnrollments);
					}
				}
			},
			_pinnedEnrollmentsChanged: function() {
				this._updateTileSizes();
				this._setFilteredPinnedEnrollments();
			},
			_unpinnedEnrollmentsChanged: function() {
				this._updateTileSizes();
				this._setFilteredUnpinnedEnrollments();
			},
			_updateEnrollmentAlerts: function(hasPinnedEnrollments, hasUnpinnedEnrollments) {
				this._noPinnedCoursesInSearch = false;
				this._noPinnedCoursesInSelection = false;
				this._noUnpinnedCoursesInSearch = false;
				this._noUnpinnedCoursesInSelection = false;
				this._noUnpinnedCourses = false;
				var isSearched = this.$['search-widget']._showClearIcon,
					hasAlert = this._hasAlert('noPinnedCourses'),
					isFiltered = this._filterCount > 0;
				this._clearAlerts();
				if (!hasPinnedEnrollments) {
					if (!hasAlert && isSearched) {
						this._noPinnedCoursesInSearch = true;
					} else if (!hasAlert && isFiltered) {
						this._noPinnedCoursesInSelection = true;
					} else {
						this._addAlert('call-to-action', 'noPinnedCourses', this.localize('noPinnedCoursesMessage'));
					}
				}
				if (!hasUnpinnedEnrollments && isSearched) {
					this._noUnpinnedCoursesInSearch = true;
				} else if (!hasUnpinnedEnrollments && isFiltered) {
					this._noUnpinnedCoursesInSelection = true;
				}
				if (!hasUnpinnedEnrollments && !isSearched && !isFiltered) {
					this._noUnpinnedCourses = true;
				}
			},

			/*
			* Utility/helper functions
			*/

			_clearFilteredCourses: function() {
				this._pinnedCoursesMap = {};
				this._unpinnedCoursesMap = {};
				this._filteredPinnedEnrollments = this.pinnedEnrollments.slice();
				this._filteredUnpinnedEnrollments = this.unpinnedEnrollments.slice();
			},
			_clearSearchWidget: function() {
				this.$['search-widget'].clear();
				this._clearFilteredCourses();
			},
			_computeHasMoreEnrollments: function(lastResponse) {
				lastResponse = this.parseEntity(lastResponse);
				return lastResponse.hasLinkByRel('next');
			},
			_computeShowAdvancedSearchLink: function(link) {
				return !!link;
			},
			_moveEnrollmentToPinnedList: function(enrollment) {
				// Remove enrollment from unpinned list, add to pinned
				var enrollmentId = this.getEntityIdentifier(enrollment);

				for (var index = 0; index < this._filteredUnpinnedEnrollments.length; index++) {
					var pinnedEnrollmentId = this.getEntityIdentifier(this._filteredUnpinnedEnrollments[index]);
					if (pinnedEnrollmentId === enrollmentId) {
						var foundEnrollment = this._filteredUnpinnedEnrollments[index];
						this._setEnrollmentPinData(foundEnrollment, true);
						this._pinnedEnrollmentsToAnimate.push(enrollmentId);
						this.unshift('_filteredPinnedEnrollments', foundEnrollment);
						this.splice('_filteredUnpinnedEnrollments', index, 1);
						break;
					}
				}
			},
			_moveEnrollmentToUnpinnedList: function(enrollment) {
				// Remove enrollment from pinned list, add to unpinned
				var enrollmentId = this.getEntityIdentifier(enrollment);

				for (var index = 0; index < this._filteredPinnedEnrollments.length; index++) {
					var unpinnedEnrollmentId = this.getEntityIdentifier(this._filteredPinnedEnrollments[index]);
					if (unpinnedEnrollmentId === enrollmentId) {
						var foundEnrollment = this._filteredPinnedEnrollments[index];
						this._setEnrollmentPinData(foundEnrollment, false);
						this._unpinnedEnrollmentsToAnimate.push(enrollmentId);
						this.unshift('_filteredUnpinnedEnrollments', foundEnrollment);
						this.splice('_filteredPinnedEnrollments', index, 1);
						break;
					}
				}
			},
			_resetSortDropdown: function() {
				this.$.sortDropdownMenu.querySelector('d2l-menu-item-radio[value=' + this.defaultSortValue + ']').click();

				var content = this.$.sortDropdown.queryEffectiveChildren('[d2l-dropdown-content]');
				if (content) {
					content.close();
				}
			},
			_setFilteredPinnedEnrollments: function() {
				this._filteredPinnedEnrollments = this.pinnedEnrollments.slice();
			},
			_setFilteredUnpinnedEnrollments: function() {
				this._filteredUnpinnedEnrollments = this.unpinnedEnrollments.slice();
			},
			_updateFilteredEnrollments: function(enrollments, append) {
				var enrollmentEntities = enrollments.getSubEntitiesByClass(this.HypermediaClasses.enrollments.enrollment);
				var newPinnedEnrollments = [];
				var newUnpinnedEnrollments = [];
				enrollmentEntities.forEach(function(enrollment) {
					var enrollmentId = this.getEntityIdentifier(enrollment);

					if (enrollment.hasClass(this.HypermediaClasses.enrollments.pinned)) {
						if (!this._pinnedCoursesMap.hasOwnProperty(enrollmentId)) {
							newPinnedEnrollments.push(enrollment);
							this._pinnedCoursesMap[enrollmentId] = true;
						}
					} else {
						if (!this._unpinnedCoursesMap.hasOwnProperty(enrollmentId)) {
							newUnpinnedEnrollments.push(enrollment);
							this._unpinnedCoursesMap[enrollmentId] = true;
						}
					}
				}, this);

				if (append) {
					this._filteredPinnedEnrollments = this._filteredPinnedEnrollments.concat(newPinnedEnrollments);
					this._filteredUnpinnedEnrollments = this._filteredUnpinnedEnrollments.concat(newUnpinnedEnrollments);
				} else {
					this._filteredPinnedEnrollments = newPinnedEnrollments;
					this._filteredUnpinnedEnrollments = newUnpinnedEnrollments;
				}

				this.$['all-courses-scroll-threshold'].clearTriggers();
				this.lastEnrollmentsSearchResponse = enrollments;
			},
			_updateTileSizes: function() {
				this._rescaleCourseTileRegions();
				this._tileSizes = Math.floor(100 / this._numColsOverlay) + 'vw';
			}
		});
	</script>
</dom-module>
