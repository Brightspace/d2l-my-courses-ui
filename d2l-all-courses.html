<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-button.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-content.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-menu/d2l-menu.html">
<link rel="import" href="../d2l-menu/d2l-menu-item.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-search-widget.html">

<!--
`<d2l-all-courses>` displays both pinned and unpinned courses

@demo demo/d2l-all-courses-demo.html
-->
<dom-module id="d2l-all-courses">
	<template>
		<style>
			:host {
				display: block;
			}
			h2 {
				/* overrides to d2l-heading-3 */
				margin: 20px 0 10px 0;
				font-size: 20px;
				/* end overrides */
				clear: both;
			}
			d2l-alert {
				margin-bottom: 20px;
			}
			.dropdown-text {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				font-size: 1rem;
				/* end overrides */
				cursor: pointer;
				margin-left: 30px;
				padding: 0;
			}
			.dropdown-button {
				background: none;
				border: none;
				cursor: pointer;
				margin-left: 12px;
				padding: 0;
			}
			.filter-item {
				display: block;
				padding: 10px;
			}
			.search-and-filter {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 60px;
			}
			.search-and-filter > d2l-search-widget {
				width: 50%;
			}
			.view-button {
				@apply(--d2l-small-text);
				background: none;
				border: none;
				padding: 10px;
				cursor: pointer;
			}
			.view-button-selected {
				color: var(--d2l-color-celestine);
				border-top-width: 2px;
				border-top-style: solid;
			}
			.hidden {
				display: none;
			}
			.clear-button {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				color: var(--d2l-color-celestine);
				/* end overrides */
				background: none;
				border: none;
				cursor: pointer;
				margin: 0;
				padding: 0;
			}
			.filter-and-clear, .button-bar {
				display: flex;
				align-items: center;
				justify-content: space-between;
			}
			.sort-button {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				font-size: 1rem;
				/* end overrides */
				display: block;
				background: none;
				border: none;
				cursor: pointer;
			}
			.sort-button-selected {
				color: var(--d2l-color-celestine);
			}
		</style>

		<d2l-ajax
			id="semestersRequest"
			url="[[_semestersUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onSemestersResponse">
		</d2l-ajax>

		<d2l-ajax
			id="departmentsRequest"
			url="[[_departmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onDepartmentsResponse">
		</d2l-ajax>

		<div class="search-and-filter">
			<d2l-search-widget
				hidden$="[[_hasEnrollments]]"
				search-root-url="[[searchUrl]]"
				parent-organization-ids="[[_parentOrganizationIds]]"
				sort-field="[[_sortField]]">
			</d2l-search-widget>

			<div>
				<span id="filterText" class="dropdown-text" on-tap="_toggleFilterDropdown">{{localize('filtering.filter')}}</span>
				<d2l-dropdown id="filterDropdown">
					<button class="d2l-dropdown-opener dropdown-button">
						<iron-icon class="dropdown-icon" icon="d2l-tier1:chevron-down" aria-hidden="true"></iron-icon>
					</button>
					<d2l-dropdown-content>
						<div class="filter-and-clear">
							<span>{{localize('filtering.filterBy')}}</span>
							<template is="dom-if" if="[[_isFiltered]]">
								<button class="clear-button" on-tap="_clearFilters">{{localize('filtering.clear')}}</button>
							</template>
						</div>
						<div class="button-bar">
							<button
								id="semesterListButton"
								class="view-button view-button-selected"
								on-tap="_selectSemesterList"
								aria-pressed="true">
								{{localize('filtering.semester')}}
							</button>
							<button
								id="departmentListButton"
								class="view-button"
								on-tap="_selectDepartmentList"
								aria-pressed="false">
								{{localize('filtering.department')}}
							</button>
						</div>
						<div id="semesterList">
							<template is="dom-repeat" items="[[_semesterOrganizations]]">
								<div class="filter-item">
									<label>
										<input
											type="checkbox"
											value="[[item.properties.id]]"
											on-click="_updateFilter" />
										[[item.properties.name]]
									</label>
								</div>
							</template>
						</div>
						<div id="departmentList" class="hidden">
							<template is="dom-repeat" items="[[_departmentOrganizations]]">
								<div class="filter-item">
									<label>
										<input
											type="checkbox"
											value="[[item.properties.id]]"
											on-click="_updateFilter" />
										[[item.properties.name]]
									</label>
								</div>
							</template>
						</div>
					</d2l-dropdown-content>
				</d2l-dropdown>

				<span id="sortText" class="dropdown-text" on-tap="_toggleSortDropdown">{{localize('sorting.sortDatePinned')}}</span>
				<d2l-dropdown id="sortDropdown">
					<button class="d2l-dropdown-opener dropdown-button">
						<iron-icon class="dropdown-icon" icon="d2l-tier1:chevron-down" aria-hidden="true"></iron-icon>
					</button>
					<d2l-dropdown-content>
						{{localize('sorting.sortBy')}}
						<button class="sort-button sort-button-selected" value="pinDate" on-tap="_updateSortBy">{{localize('sorting.datePinned')}}</a>
						<button class="sort-button" value="lastAccessed" on-tap="_updateSortBy">{{localize('sorting.lastAccessed')}}</a>
					</d2l-dropdown-content>
				</d2l-dropdown>
			</div>
		</div>

		<h2 class="d2l-heading-3">{{localize('pinnedCourses')}}</h2>

		<template is="dom-if" if="[[!_hasPinnedEnrollments]]">
			<d2l-alert visible="[[!_hasPinnedEnrollments]]">
				{{localize('noPinnedCoursesMessage')}}
			</d2l-alert>
		</template>

		<d2l-course-tile-grid
			enrollments="{{pinnedEnrollments}}"
			enrollments-queue="{{pinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]">
		</d2l-course-tile-grid>

		<h2 class="d2l-heading-3">{{localize('unpinnedCourses')}}</h2>

		<d2l-course-tile-grid
			enrollments="{{unpinnedEnrollments}}"
			enrollments-queue="{{unpinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]">
		</d2l-course-tile-grid>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-all-courses',
			properties: {
				/*
				* Sets the delay-load property on the course tile grid
				* @type {Boolean}
				*/
				delayCourseTileLoad: {
					type: Boolean,
					value: true
				},
				/*
				* URL for search widget; should have search-my-enrollments Action
				*/
				searchUrl: {
					type: String,
					value: ''
				},
				_departmentOrganizations: Object,
				_departmentsUrl: {
					type: String,
					value: '/d2l/api/hm/organizations?embedDepth=1&organizationTypeIds=203'
				},
				_isFiltered: {
					type: Boolean,
					value: false
				},
				_semesterOrganizations: Object,
				_semestersUrl: {
					type: String,
					value: '/d2l/api/hm/organizations?embedDepth=1&organizationTypeIds=5'
				},
				_sortField: String,
				_parentOrganizationIds: {
					type: Array,
					value: function() {
						return [];
					}
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.CourseManagementBehavior
			],
			ready: function() {
				this.usePendingLists = true;

				// Both course tile grids in this view should have the same number of columns, so use a custom getter
				var courseTileGrids = Polymer.dom(this.root).querySelectorAll('d2l-course-tile-grid');
				for (var i = 0; i < courseTileGrids.length; i++) {
					courseTileGrids[i].getCourseTileItemCount = this.getCourseTileItemCount.bind(this);
				}

				this.$.semestersRequest.generateRequest();
				this.$.departmentsRequest.generateRequest();
			},
			/*
			* Fetches set of focusable elements (all `<d2l-course-tile>`s)
			*
			* Required for accessibility, this specifies which elements within the element are intended to be
			* keyboard-focusable. This is because we're using `<iron-overlay with-backdrop>`. See
			* [those docs](https://github.com/PolymerElements/iron-overlay-behavior#backdrop) for more information.
			*
			* @return {Array<HTMLElement>} `<d2l-course-tile` HTMLElements
			*/
			focusableNodesOverride: function() {
				var courseTileFocusables = [];

				Polymer.dom(this.root).querySelectorAll('d2l-course-tile').forEach(function(courseTile) {
					Array.prototype.push.apply(courseTileFocusables, Polymer.dom(courseTile.root).querySelectorAll('a'));
				});

				return courseTileFocusables;
			},
			/*
			* Fetches the max value between the pinned and unpinned enrollments
			* @return {Number} Max(number of pinned enrollments, number of unpinned enrollments)
			*/
			getCourseTileItemCount: function() {
				var itemCount = Math.max(this.pinnedEnrollments.length, this.unpinnedEnrollments.length);

				return itemCount;
			},
			loadCourseTiles: function() {
				this.delayCourseTileLoad = false;
			},
			_clearFilters: function() {
				Polymer.dom(this.root).querySelectorAll('.filter-item input').forEach(function(checkbox) {
					checkbox.checked = false;
				});
				this._isFiltered = false;
				this._parentOrganizationIds = [];
				this.$.filterText.textContent = this.localize('filtering.filter');
			},
			_onDepartmentsResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var departments = parser.parse(response.detail.xhr.response);
					this._departmentOrganizations = departments.entities;
				}
			},
			_onSemestersResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var semesters = parser.parse(response.detail.xhr.response);
					this._semesterOrganizations = semesters.entities;
				}
			},
			_selectSemesterList: function() {
				this.toggleClass('hidden', false, this.$.semesterList);
				this.toggleClass('hidden', true, this.$.departmentList);
				this.toggleClass('view-button-selected', true, this.$.semesterListButton);
				this.toggleClass('view-button-selected', false, this.$.departmentListButton);
				this.$.semesterListButton.setAttribute('aria-pressed', true);
				this.$.departmentListButton.setAttribute('aria-pressed', false);
			},
			_selectDepartmentList: function() {
				this.toggleClass('hidden', true, this.$.semesterList);
				this.toggleClass('hidden', false, this.$.departmentList);
				this.toggleClass('view-button-selected', false, this.$.semesterListButton);
				this.toggleClass('view-button-selected', true, this.$.departmentListButton);
				this.$.semesterListButton.setAttribute('aria-pressed', false);
				this.$.departmentListButton.setAttribute('aria-pressed', true);
			},
			_toggleFilterDropdown: function() {
				this.$.filterDropdown.toggleOpen();
			},
			_toggleSortDropdown: function() {
				this.$.sortDropdown.toggleOpen();
			},
			_updateFilter: function(e) {
				if (e.target.checked) {
					this.push('_parentOrganizationIds', e.target.value);
					this._isFiltered = true;
				} else {
					var index = this._parentOrganizationIds.indexOf(e.target.value);
					this.splice('_parentOrganizationIds', index, 1);
				}

				if (this._parentOrganizationIds.length === 0) {
					this.$.filterText.textContent = this.localize('filtering.filter')
				} else if (this._parentOrganizationIds.length === 1) {
					this.$.filterText.textContent = this.localize('filtering.filterSingle')
				} else {
					this.$.filterText.textContent = this.localize('filtering.filterMultiple', 'numFilters', this._parentOrganizationIds.length);
				}
			},
			_updateSortBy: function(e) {
				this._sortField = e.target.value;

				var buttons = Polymer.dom(this.root).querySelectorAll('#sortDropdown .sort-button');
				buttons.forEach(function(button) {
					this.toggleClass('sort-button-selected', button.value === e.target.value, button);
				}.bind(this));

				var sortText;
				switch(this._sortField) {
					case 'pinDate':
						sortText = this.localize('sorting.sortDatePinned');
					case 'lastAccessed':
						sortText = this.localize('sorting.sortLastAccessed');
				}

				this.$.sortText.textContent = sortText;
			}
		});
	</script>
</dom-module>
