<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="d2l-utility-behavior.html">

<script>
	(function() {
		'use strict';

		Polymer.D2L = Polymer.D2L || {};
		Polymer.D2L.MyCourses = Polymer.D2L.MyCourses || {};

		Polymer.D2L.MyCourses.CourseManagementBehavior = {
			properties: {
				pinnedCoursesEntities: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				unpinnedCoursesEntities: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				pinnedCoursesEntitiesQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				unpinnedCoursesEntitiesQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				_hasPinnedCourses: {
					type: Boolean,
					value: false
				},
				_hasCourses: {
					type: Boolean,
					value: false
				},
				usePendingLists: {
					type: Boolean,
					value: false
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.UtilityBehavior
			],
			listeners: {
				'course-pinned': '_onCoursePinned',
				'course-unpinned': '_onCourseUnpinned',
				'tile-remove-complete': '_onTileRemoveComplete',
				'course-pin-complete': '_onCoursePinComplete',
				'course-unpin-complete': '_onCourseUnpinComplete'
			},
			observers: [
				'_onPinnedCoursesEntitiesChanged(pinnedCoursesEntities.*)'
			],
			created: function() {
				this._tilesInPinStateTransition = [];
			},
			ready: function() {
				this._announceElement = document.createElement('d2l-offscreen');
				this._announceElement.setAttribute('aria-live', 'polite');
			},
			_onCoursePinned: function(e) {
				this._ariaAnnounce(this.localize('pinActionResult', 'course', e.detail.course.properties.name));
			},
			_onCourseUnpinned: function(e) {
				this._ariaAnnounce(this.localize('unpinActionResult', 'course', e.detail.course.properties.name));
			},
			_onTileRemoveComplete: function(e) {
				if (e.detail.pinned) {
					this._moveCourseToPinnedList(e.detail.course);
				} else {
					this._moveCourseToUnpinnedList(e.detail.course);
				}

				e.stopPropagation();
			},
			_moveCourseToPinnedList: function(course) {
				// Remove course from unpinned list, add to pinned
				var enrollmentId = this._getEnrollmentIdentifier(course);

				for (var index = 0; index < this.unpinnedCoursesEntities.length; index++) {
					var pinnedEnrollmentId = this._getEnrollmentIdentifier(this.unpinnedCoursesEntities[index]);
					if (pinnedEnrollmentId === enrollmentId) {
						var foundCourse = this.unpinnedCoursesEntities[index];
						this._setEnrollmentPinData(foundCourse, true);

						// If enabled, add to list of "to be added" pinned entities, and let consumer move to pinned list when desired
						if (this.usePendingLists) {
							this.push('pinnedCoursesEntitiesQueue', foundCourse);
						} else {
							this._tilesInPinStateTransition.push(enrollmentId);
							this.unshift('pinnedCoursesEntities', foundCourse);
						}

						this.splice('unpinnedCoursesEntities', index, 1);
						break;
					}
				}
			},
			_moveCourseToUnpinnedList: function(course) {
				// Remove course from pinned list, add to unpinned
				var enrollmentId = this._getEnrollmentIdentifier(course);

				for (var index = 0; index < this.pinnedCoursesEntities.length; index++) {
					var unpinnedEnrollmentId = this._getEnrollmentIdentifier(this.pinnedCoursesEntities[index]);
					if (unpinnedEnrollmentId === enrollmentId) {
						var foundCourse = this.pinnedCoursesEntities[index];
						this._setEnrollmentPinData(foundCourse, false);

						// If enabled, add to list of "to be added" unpinned entities, and let consumer move to unpinned list when desired
						if (this.usePendingLists) {
							this.push('unpinnedCoursesEntitiesQueue', foundCourse);
						} else {
							this._tilesInPinStateTransition.push(enrollmentId);
							this.unshift('unpinnedCoursesEntities', foundCourse);
						}

						this.splice('pinnedCoursesEntities', index, 1);
						break;
					}
				}
			},
			_setEnrollmentPinData: function(entity, isPinned) {
				// HACK: Because the course tiles are being removed and re-created in the DOM, we have to effectively
				// manually update them, rather than updating them with the received enrollment from the API call.
				if (isPinned) {
					entity.class.splice(entity.class.indexOf('unpinned'));
					entity.class.push('pinned');
					entity.actions[0].name = 'unpin-course';
					entity.actions[0].fields[0].value = false;
					entity._actionsByName['unpin-course'] = entity.actions[0];
				} else {
					entity.class.splice(entity.class.indexOf('pinned'));
					entity.class.push('unpinned');
					entity.actions[0].name = 'pin-course';
					entity.actions[0].fields[0].value = true;
					entity._actionsByName['pin-course'] = entity.actions[0];
				}
			},
			_announceElement: null,
			_ariaAnnounce: function(message) {
				this._announceElement.textContent = '';
				this._announceElement.textContent = message;
			},
			get ariaMessage() {
				return this._announceElement.textContent;
			},
			_onPinnedCoursesEntitiesChanged: function(newArray) {
				this._hasPinnedCourses = !newArray.base || newArray.base.length > 0;
			}
		};
	})();
</script>
