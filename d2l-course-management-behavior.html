<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="d2l-utility-behavior.html">

<script>
	'use strict';

	(function() {
		Polymer.D2L = Polymer.D2L || {};
		Polymer.D2L.MyCourses = Polymer.D2L.MyCourses || {};

		/*
		* Behavior that allows for course management
		*
		* "Management" in this case means having a pinned and unpinned list, and supporting switching an enrollment between the
		* two. This also contains some A11Y functionality to aria-announce when an enrollment changes between pinned and
		* unpinned.
		*
		* @polymerBehavior Polymer.D2L.MyCourses.CourseManagementBehavior
		*/
		Polymer.D2L.MyCourses.CourseManagementBehaviorImpl = {
			properties: {
				/*
				* Set of pinned enrollment entities
				* @type {Array<Entity>}
				*/
				pinnedEnrollments: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				/*
				* Set of unpinned enrollment entities
				* @type {Array<Entity>}
				*/
				unpinnedEnrollments: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				/*
				* Set of enrollments that are being transferred from unpinned to pinned state
				*
				* Only used by `d2l-all-courses`
				*
				* @type {Array<Entity>}
				*/
				pinnedEnrollmentsQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				/*
				* Set of enrollments that are being transferred from pinned to unpinned state
				*
				* Only used by `d2l-all-courses`
				*
				* @type Array{Entity}
				*/
				unpinnedEnrollmentsQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				/*
				* If enabled, the component will use the pinned/unpinned enrollment queues
				*
				* In the case of `d2l-all-courses`, the enrollments are switching lists, so this is required.
				*
				* @type {Boolean}
				*/
				usePendingLists: {
					type: Boolean,
					value: false
				},
				/*
				* True when there are pinned enrollments (i.e. `pinnedEnrollments.length > 0`)
				* @type {Boolean}
				*/
				_hasPinnedEnrollments: {
					type: Boolean,
					value: false
				},
				/*
				* True when there are any enrollments (pinned or unpinned)
				* @type {Boolean}
				*/
				_hasEnrollments: {
					type: Boolean,
					value: false
				},
				/*
				* True when user has "a lot" of enrollments.
				*
				* Used to determine whether to show recent courses list as well as tile view.
				*
				* @type {Boolean}
				*/
				_hasManyEnrollments: {
					type: Boolean,
					value: false
				}
			},
			listeners: {
				'enrollment-pinned': '_onEnrollmentPinned',
				'enrollment-unpinned': '_onEnrollmentUnpinned',
				'tile-remove-complete': '_onTileRemoveComplete',
				'enrollment-pin-complete': '_onEnrollmentPinComplete',
				'enrollment-unpin-complete': '_onEnrollmentUnpinComplete'
			},
			observers: [
				'_onPinnedEnrollmentsChanged(pinnedEnrollments.*)'
			],
			created: function() {
				this._tilesInPinStateTransition = [];
			},
			ready: function() {
				this._announceElement = document.createElement('d2l-offscreen');
				this._announceElement.setAttribute('aria-live', 'polite');
			},
			/*
			* A11Y `d2l-offscreen` announcement text
			* @type {String}
			*/
			get ariaMessage() {
				return this._announceElement.textContent;
			},
			_announceElement: null,
			_ariaAnnounce: function(message) {
				this._announceElement.textContent = '';
				this._announceElement.textContent = message;
			},
			_moveEnrollmentToPinnedList: function(enrollment) {
				// Remove enrollment from unpinned list, add to pinned
				var enrollmentId = this.getEnrollmentIdentifier(enrollment);

				for (var index = 0; index < this.unpinnedEnrollments.length; index++) {
					var pinnedEnrollmentId = this.getEnrollmentIdentifier(this.unpinnedEnrollments[index]);
					if (pinnedEnrollmentId === enrollmentId) {
						var foundEnrollment = this.unpinnedEnrollments[index];
						this._setEnrollmentPinData(foundEnrollment, true);

						// If enabled, add to list of "to be added" pinned entities, and let consumer move to pinned list when desired
						if (this.usePendingLists) {
							this.push('pinnedEnrollmentsQueue', foundEnrollment);
						} else {
							this._tilesInPinStateTransition.push(enrollmentId);
							this.unshift('pinnedEnrollments', foundEnrollment);
						}

						this.splice('unpinnedEnrollments', index, 1);
						break;
					}
				}
			},
			_moveEnrollmentToUnpinnedList: function(enrollment) {
				// Remove enrollment from pinned list, add to unpinned
				var enrollmentId = this.getEnrollmentIdentifier(enrollment);

				for (var index = 0; index < this.pinnedEnrollments.length; index++) {
					var unpinnedEnrollmentId = this.getEnrollmentIdentifier(this.pinnedEnrollments[index]);
					if (unpinnedEnrollmentId === enrollmentId) {
						var foundEnrollment = this.pinnedEnrollments[index];
						this._setEnrollmentPinData(foundEnrollment, false);

						// If enabled, add to list of "to be added" unpinned entities, and let consumer move to unpinned list when desired
						if (this.usePendingLists) {
							this.push('unpinnedEnrollmentsQueue', foundEnrollment);
						} else {
							this._tilesInPinStateTransition.push(enrollmentId);
							this.unshift('unpinnedEnrollments', foundEnrollment);
						}

						this.splice('pinnedEnrollments', index, 1);
						break;
					}
				}
			},
			_onEnrollmentPinned: function(e) {
				this._ariaAnnounce(this.localize('pinActionResult', 'course', e.detail.organization.properties.name));
			},
			_onEnrollmentUnpinned: function(e) {
				this._ariaAnnounce(this.localize('unpinActionResult', 'course', e.detail.organization.properties.name));
			},
			_onPinnedEnrollmentsChanged: function(newArray) {
				this._hasPinnedEnrollments = !newArray.base || newArray.base.length > 0;
			},
			_onTileRemoveComplete: function(e) {
				if (e.detail.pinned) {
					this._moveEnrollmentToPinnedList(e.detail.enrollment);
				} else {
					this._moveEnrollmentToUnpinnedList(e.detail.enrollment);
				}

				e.stopPropagation();
			},
			_setEnrollmentPinData: function(entity, isPinned) {
				// HACK: Because the course tiles are being removed and re-created in the DOM, we have to effectively
				// manually update them, rather than updating them with the received enrollment from the API call.
				if (isPinned) {
					entity.class.splice(entity.class.indexOf('unpinned'));
					entity.class.push('pinned');
					entity.actions[0].name = 'unpin-course';
					entity.actions[0].fields[0].value = false;
					entity._actionsByName['unpin-course'] = entity.actions[0];
				} else {
					entity.class.splice(entity.class.indexOf('pinned'));
					entity.class.push('unpinned');
					entity.actions[0].name = 'pin-course';
					entity.actions[0].fields[0].value = true;
					entity._actionsByName['pin-course'] = entity.actions[0];
				}
			}
		};

		Polymer.D2L.MyCourses.CourseManagementBehavior = [
			Polymer.D2L.MyCourses.CourseManagementBehaviorImpl,
			Polymer.D2L.MyCourses.UtilityBehavior
		];
	})();
</script>
