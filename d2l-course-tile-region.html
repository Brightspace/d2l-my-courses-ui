<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="d2l-my-courses-styles.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-course-tile.html">
<link rel="import" href="d2l-course-tile-region-behavior.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-interaction-detection-behavior.html">

<dom-module id="d2l-course-tile-grid">
	<template>
		<style include="d2l-my-courses-styles"></style>
		<d2l-alert visible="[[alertVisible]]">
			{{alertMessage}}
		</d2l-alert>

		<div class="my-courses-container">
			<template is="dom-repeat" items="[[courseEntities]]">
				<d2l-course-tile
					enrollment="[[item]]"
					hover-enabled="[[_hoverInteractionEnabled]]"
					touch-enabled="[[_touchInteractionEnabled]]"
					animate-insertion="[[removeCourseFromTransitionList(item.properties.id)]]">
				</d2l-course-tile>
			</template>
		</div>
	</template>

	<script>
		Polymer({
			is: 'd2l-course-tile-grid',
			properties: {
				courseEntities: {
					type: Array,
					notify: true,
					value: function() {
						return [];
					}
				},
				_newCourseEntities: {
					type: Array
				},
				alertVisible: {
					type: Boolean
				},
				alertMessage: {
					type: String
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileRegionBehavior,
				Polymer.D2L.MyCourses.InteractionDetectionBehavior
			],
			observers: [
				'_onNewCourseEntitiesChanged(_newCourseEntities)'
			],
			created: function() {
				this._tilesInPinStateTransition = [];
				this._courseTileBoundingRects = [];
			},
			_onNewCourseEntitiesChanged: function(newCourseEntities) {
				// For now, assume there will only be one entity being added at a time before being removed - might not affect implementation,
				// but for simplicity, that's how's I'm writin' it.
				var newCourse = newCourseEntities[0];

				//*******************************
				// Set up pre-animation stuff:
				// 	*Save all of the existing tile/container positions, for intitial positioning
				//  *Set all initial positions/sizes/whatever on elements
				// 	*Set absolute positioning/etc on elements, so that new course tile won't break anything when we insert it
				//   	* May have to have a "pre-animation" CSS class
				//******************************
				// Get all course tiles in container
				var container = this.querySelector('.my-courses-container');
				var courseTiles = container.getElementsByTagName('d2l-course-tile');
				// We need to get the parent element to subtract its offset for absolute positioning, since other methods seem to fail
				var parentRect = container.getBoundingClientRect();
				// We need to know course tile properties prior to any animation taking place
  				var courseTileRects = this._getItemPositions(courseTiles);
				var containerWidth = container.offsetWidth;
				var containerHeight = container.offsetHeight;

				// Set initial values for container
				this.customStyle['--container-width'] = '500px';
				this.customStyle['--container-height'] = containerHeight + 'px';
				this.updateStyles();

				// Set intial values for course tiles
				for(var i = 0; i < courseTiles.length; i++) {
					var courseTile = courseTiles[i];
					var courseTileRect = courseTileRects[i];

					courseTile.customStyle['--col'] = Math.floor(courseTileRect.left - parentRect.left); + 'px';
					courseTile.customStyle['--row'] = (courseTileRect.top - parentRect.top) + 'px';
					courseTile.updateStyles();
				};

				//*******************************
				// Add new course tile:
				// 	*Ensure course tile info is set in "in-transition" list(s), including delay
				// 	*Prepend to course entities list - delay until now as it affects the DOM
				//*******************************
				this._tilesInPinStateTransition.push(newCourse.properties.id);
				this._nextCourseInsertionDelaySecs = 1.0;
				this.unshift('coursesEntities', newCourse);

				// Calculate new row/container heights, now that we have the height of the new tile
				// @NOTE: Do we have to listen for a dom-change event first, to make sure the tile's been inserted?
				// Maybe instead of having a separate list of course entities, there can be a list of course IDs that were added to
				// the actual courses list (eg. pinnedCoursesEntities), so that the new tiles can just be hidden until necessary and this doesn't need
				// to be done in two phases (because all of the tiles should exist). In fact, maybe we could just listen for the dom-change event only.
				courseTiles = container.getElementsByTagName('d2l-course-tile');
				var rowOffsets = this._getNewRowOffsets(container, courseTiles, columns);

				// Set new positions for course tiles
				for(var i = 0; i < courseTiles.length; i++) {
					var leftMarginPct = [
						[0], //1 column
						[0, .01666], //2 columns
						[0, .0112, .0224], //3 columns
						[0, .009, .018, .027] //4 columns
					];

					var courseTile = courseTiles[i];
					var courseTileRect = courseTileRects[i];
					var containerWidth = container.offsetWidth;
					var nextCol = (i + 1) % columns;
					var newRow = rowOffsets[Math.floor((i + 1) / columns)];
					var newCol = courseTile.offsetWidth * nextCol;

					newCol = (newCol + leftMarginPct[columns - 1][nextCol] * containerWidth);

					if((i % columns) !== 0) {
						currCol -= 6;
					}

					courseTile.customStyle['--new-col'] = newCol + 'px';
					courseTile.customStyle['--new-row'] = newRow + 'px';
					courseTile.customStyle['--delay'] = ((courseTiles.length - i) * 0.2) + 's';
					courseTile.updateStyles();
				};

				// Set new container height
				this.customStyle['--container-height-new'] = (containerHeight + courseTiles[0].offsetHeight) + 'px';
				this.toggleClass('animate', true, container);

				// Let loose the dogs of war (that is, start animation)
				this.toggle('animate', true, this.$$('.my-courses-container'));
			},
			removeCourseFromTransitionList: function(courseID) {
				var index = this._tilesInPinStateTransition.indexOf(courseID);

				if (index !== -1) {
					this._tilesInPinStateTransition.splice(index, 1);
					return true;
				}

				return false;
			},
			get courseTileItemCount() {
				return this.courseEntities.length;
			}
		});
	</script>
</dom-module>
