<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="d2l-course-tile-styles.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-touch-menu.html">
<link rel="import" href="d2l-touch-menu-item.html">

<dom-module id="d2l-course-tile">
	<template>
		<style include="d2l-course-tile-styles"></style>

		<d2l-ajax
			id="organizationRequest"
			url="[[_organizationUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-response="onOrganizationResponse">
		</d2l-ajax>

		<d2l-ajax
			id="enrollmentPinRequest"
			url="[[_enrollmentPinUrl]]"
			method="[[_enrollmentPinMethod]]"
			body="[[_enrollmentPinBody]]"
			headers='{ "Accept": "application/vnd.siren+json", "Content-Type": "application/x-www-form-urlencoded" }'
			on-response="onEnrollmentPinResponse"
			on-error="onEnrollmentPinError">
		</d2l-ajax>

		<div class="tile-container"
			on-mouseover="hoverCourseTile"
			on-mouseout="onTileMouseOut">
			<a href="[[_organizationHomepageUrl]]" class="no-tap-interaction"
				on-focus="hoverCourseTile"
				on-blur="unhoverCourseTile">
				<div class="course-image-container">
					<div class="course-image">
						<img aria-hidden="true" />
					</div>
				</div>
				<div class="course-text d2l-heading-4">{{_organization.properties.name}}</div>
			</a>

			<div class="hover-menu no-tap-interaction">
				<button class="menu-item no-tap-interaction"
					on-click="hoverPinClickHandler"
					on-focus="hoverPinMenuItem"
					on-blur="unhoverPinMenuItem"
					on-mouseover="hoverPinMenuItem"
					on-mouseout="unhoverPinMenuItem">
					<iron-icon class="menu-icon" icon="d2l-tier1:pin-filled" aria-hidden="true"></iron-icon>
					<span class="menu-text pin"
						aria-label$="[[localize('pinCourse', 'course', _organization.properties.name)]]"
						>{{localize('pin')}}</span>
					<span class="menu-text unpin"
						aria-label$="[[localize('unpinCourse', 'course', _organization.properties.name)]]"
						>{{localize('unpin')}}</span>
				</button>
			</div>
		</div>
	</template>

	<script>
		Polymer({
			is: 'd2l-course-tile',
			properties: {
				enrollment: {
					type: Object,
					observer: '_enrollmentChanged'
				},
				hoverEnabled: {
					type: Boolean,
					value: true
				},
				touchEnabled: {
					type: Boolean,
					value: true
				},
				animateInsertion: {
					type: Boolean
				},
				courseId: {
					type: Number
				},
				_organization: {
					type: Object
				},
				_organizationUrl: {
					type: String
				},
				_organizationHomepageUrl: {
					type: String
				},
				_pinned: {
					type: Boolean,
					observer: '_pinnedChanged'
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.LocalizeBehavior
			],
			listeners: {
				'animationend': '_onAnimationComplete'
			},
			created: function() {
				this.setAttribute('role', 'link');
			},
			attached: function() {
				if (this.animateInsertion) {
					this.toggleClass('animate-insertion-pre', true, this);
				}
			},
			hoverPinClickHandler: function(e) {
				// Prevent the click from triggering navigation to the course
				e.preventDefault();

				this._pinClickHandler(false);
			},
			_pinClickHandler: function(isTouch) {
				var pinAction = this._pinned ? this.enrollment.getActionByName('unpin-course') : this.enrollment.getActionByName('pin-course');

				this._enrollmentPinMethod = pinAction.method;
				this._enrollmentPinUrl = pinAction.href;

				// This value is purely for UI responsiveness - if the request fails, this value will be set back to
				// the previous value in the error handler; if the request succeeds, we also set it in the response
				// handler (to this same value), but that could take a few hundred ms, so do it before the request too.
				this._pinned = !this._pinned;

				var body = {};
				var fields = pinAction.fields || [];
				fields.forEach(function(field) {
					body[field.name] = field.value;
				});
				this._enrollmentPinBody = body;

				this.$.enrollmentPinRequest.generateRequest();

				var eventName = this._pinned ? 'course-pinned' : 'course-unpinned';
				this.fire(eventName, {
					course: this.enrollment
				});

				this.pinAnimationInProgress = true;
				this.toggleClass('unpin-hovered', false, this);

				if (isTouch) {
					this.customStyle['--scale-fade-min-scale'] = '1.1';
					this.updateStyles();
				}

				this.toggleClass('unpin', true, this);

				this.pendingPinAction = this._pinned;
			},
			hoverCourseTile: function() {
				if (this.hoverEnabled) {
					this._setCourseTileHovered(true);
				}
			},
			unhoverCourseTile: function(force) {
				if ((force === true || Polymer.dom(this.root).querySelectorAll(':hover').length === 0) &&
					!this.pinAnimationInProgress) {
					this._setCourseTileHovered(false);
				}
			},
			_setCourseTileHovered: function(isHovered) {
				this.toggleClass('hover', isHovered, this.$$('.tile-container'));
				this.toggleClass('hover', isHovered, this.$$('.hover-menu'));
				this.toggleClass('hover', isHovered, this.$$('.course-image-container'));
			},
			hoverPinMenuItem: function() {
				this._onUnpinHover({detail: {hoverState: true}});
				this.hoverCourseTile();
			},
			unhoverPinMenuItem: function() {
				this._onUnpinHover({detail: {hoverState: false}});
				this.unhoverCourseTile();
			},
			onTileMouseOut: function() {
				this.unhoverCourseTile(true);
			},
			_enrollmentChanged: function(enrollment) {
				var parser = document.createElement('d2l-siren-parser');
				// Only in tests is this strictly required; in normal operation, it's (nearly) a no-op
				var enrollmentEntity = parser.parse(enrollment);

				// Need to no-op the observer (then set it back) so we avoid infinite loop when setting this.enrollment
				var observer = this._enrollmentChanged;
				this._enrollmentChanged = function() {};
				this.enrollment = enrollmentEntity;
				this._enrollmentChanged = observer;

				this._pinned = enrollmentEntity.hasClass('pinned');

				// The enrollment is updated (i.e. this handler is called) upon a pin/unpin response as well, but
				// there's no need to update the organization in that case
				if (!this._organization) {
					var organizationLink = enrollmentEntity.getLinkByRel('https://api.brightspace.com/rels/organization');
					this._organizationUrl = organizationLink.href + '?embedDepth=1';
					this.$.organizationRequest.generateRequest();
				}
			},
			onOrganizationResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var organization = parser.parse(response.detail.xhr.response);

					var courseImageEntity = organization.getSubEntityByClass('course-image');
					if (courseImageEntity) {
						var courseImageLink = courseImageEntity.getLinkByRel('alternate');
						var courseImage = this.$$('.course-image img');
						Polymer.dom(courseImage).setAttribute('src', courseImageLink.href);
					}

					this._organization = organization;
					this._organizationHomepageUrl = organization.getLinkByRel('https://api.brightspace.com/rels/organization-homepage').href;
				}
			},
			onEnrollmentPinResponse: function(response) {
				if (response.detail.status === 200) {
					// The pin action returns the updated enrollment, so update this.enrollment with the modified one
					var parser = document.createElement('d2l-siren-parser');
					this.enrollment = parser.parse(response.detail.xhr.response);
				}
			},
			onEnrollmentPinError: function() {
				// Just revert back to whatever pin state we already had stored
				this._pinned = this.enrollment.hasClass('pinned');
			},
			_pinnedChanged: function(pinned) {
				var pinIcon = this.$$('.menu-item iron-icon.menu-icon'),
					pinText = this.$$('.menu-item .menu-text.pin'),
					unpinText = this.$$('.menu-item .menu-text.unpin');

				if (pinned) {
					Polymer.dom(pinIcon).setAttribute('icon', 'd2l-tier1:pin-hollow');
					Polymer.dom(pinText).setAttribute('style', 'display: none');
					Polymer.dom(unpinText).setAttribute('style', 'display: inline');
				} else {
					Polymer.dom(pinIcon).setAttribute('icon', 'd2l-tier1:pin-filled');
					Polymer.dom(pinText).setAttribute('style', 'display: inline');
					Polymer.dom(unpinText).setAttribute('style', 'display: none');
				}
			},
			_onAnimationComplete: function(e) {
				var tileContainer = this.$$('.tile-container');

				if (e.animationName.includes('scale-and-fade-out')) {
					this.fire('tile-remove-complete', {course: this.enrollment, pinned: this.pendingPinAction});
				} else if (e.animationName.includes('scale-and-fade-in')) {
					this.toggleClass('animate-insertion', false, tileContainer);
					this.toggleClass('animate-insertion', false, this);
					this.toggleClass('animate-insertion', false, this.$$('.tile-container'));
					this.fire('tile-insert-complete', {course: this.enrollment, pinned: this.pendingPinAction});
				} else if (e.animationName.includes('tile-pre-insertion')) {
					this.toggleClass('animate-insertion-pre', false, this);
					this.toggleClass('animate-insertion', true, tileContainer);
					this.toggleClass('animate-insertion', true, this);
				}
			},
			_onUnpinHover: function(e) {
				this.toggleClass('unpin-hovered', e.detail.hoverState, this);
			},
			_setTouchMenuOpen: function(isOpen) {
				this.toggleClass('touch-menu-open', isOpen, this);
				this.toggleClass('hover', isOpen, this);
			},
			pendingPinAction: false,
			pinAnimationInProgress: false
		});
	</script>
</dom-module>
