<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="d2l-course-tile-styles.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-touch-menu.html">
<link rel="import" href="d2l-touch-menu-item.html">

<dom-module id="d2l-course-tile">
	<template>
		<style include="d2l-course-tile-styles"></style>

		<d2l-ajax
			url="[[_updatePreferencesUrl]]"
			method="[[_updatePreferencesMethod]]"
			body="[[_updatePreferencesBody]]"
			headers='{ "Accept": "application/vnd.siren+json", "Content-Type": "application/json" }'
			on-response="updatePreferencesOnResponse"
			on-error="updatePreferencesOnError"></d2l-ajax>

		<div class="tile-container"
			on-mouseover="hoverCourseTile"
			on-mouseout="onTileMouseOut">
			<a href="[[_courseUrl]]" class="no-tap-interaction"
				on-focus="hoverCourseTile"
				on-blur="unhoverCourseTile">
				<div class="course-image-container">
					<div class="course-image">
						<img aria-hidden="true" />
					</div>
				</div>
				<div class="course-text d2l-heading-4">{{_enrollmentEntity.properties.name}}</div>
			</a>

			<div class="hover-menu no-tap-interaction">
				<button class="menu-item no-tap-interaction"
					on-click="pinClickHandler"
					on-focus="hoverCourseTile"
					on-blur="unhoverCourseTile">
					<iron-icon class="menu-icon" icon="d2l-tier1:pin-filled" aria-hidden="true"></iron-icon>
					<span class="menu-text pin"
						aria-label$="[[localize('pinCourse', 'course', _enrollmentEntity.properties.name)]]"
						>{{localize('pin')}}</span>
					<span class="menu-text unpin"
						aria-label$="[[localize('unpinCourse', 'course', _enrollmentEntity.properties.name)]]"
						>{{localize('unpin')}}</span>
				</button>
			</div>
		</div>

		<d2l-touch-menu enabled="[[touchEnabled]]">
			<d2l-touch-menu-item
				text="{{localize('pin')}}"
				background-image="d2l-tier1:pin-filled"
				selection-handler="pinClickHandler"
				action-description="[[localize('pinCourse', 'course', _enrollmentEntity.properties.name)]]">
			</d2l-touch-menu-item>
		</d2l-touch-menu>
	</template>

	<script>
		Polymer({
			is: 'd2l-course-tile',
			properties: {
				enrollment: {
					type: Object,
					observer: '_enrollmentChanged'
				},
				hoverEnabled: {
					type: Boolean,
					value: true
				},
				touchEnabled: {
					type: Boolean,
					value: true
				},
				_enrollmentEntity: {
					type: Object,
					observer: '_enrollmentEntityChanged'
				},
				_courseUrl: {
					type: String
				},
				_pinned: {
					type: Boolean,
					observer: '_pinnedChanged'
				},
				_updatePreferencesUrl: {
					type: String
				},
				_updatePreferencesMethod: {
					type: String
				},
				_updatePreferencesFields: {
					type: String
				},
				_updatePreferencesBody: {
					type: String
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.LocalizeBehavior
			],
			created: function() {
				this.setAttribute('role', 'link');
			},
			updatePreferencesOnResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var preferencesEntity = parser.parse(response.detail.xhr.response);
					this._pinned = preferencesEntity.properties.hasOwnProperty('pinDate');
				} else {
					this._pinned = this._enrollmentEntity.getSubEntitiesByRel('preferences')[0].properties.hasOwnProperty('pinDate');
				}
			},
			updatePreferencesOnError: function(error) {
				error.preventDefault();
				error.stopPropagation();
				this._pinned = this._enrollmentEntity.getSubEntitiesByRel('preferences')[0].properties.hasOwnProperty('pinDate');
			},
			pinClickHandler: function(e) {
				// Prevent the click from triggering navigation to the course
				if (e) {
					e.preventDefault();
				}

				this._pinned = !this._pinned;

				var updatePreferences = this.$$('d2l-ajax');

				var updatePreferencesBody = {};
				this._updatePreferencesFields.forEach(function(field) {
					updatePreferencesBody[field.name] = field.value;
				});
				updatePreferencesBody.pinned = this._pinned;
				this._updatePreferencesBody = JSON.stringify(updatePreferencesBody);

				updatePreferences.generateRequest();

				var eventName = this._pinned ? 'course-pinned' : 'course-unpinned';
				this.fire(eventName, {
					course: this._enrollmentEntity
				});
			},
			hoverCourseTile: function() {
				if (this.hoverEnabled) {
					var hoverMenu = this.$$('.hover-menu');
					Polymer.dom(hoverMenu).classList.add('hover');

					var courseImage = this.$$('.course-image img');
					Polymer.dom(courseImage).classList.add('hover');
				}
			},
			unhoverCourseTile: function(force) {
				if (force === true || Polymer.dom(this.root).querySelectorAll(':hover').length === 0) {
					var hoverMenu = this.$$('.hover-menu');
					Polymer.dom(hoverMenu).classList.remove('hover');

					var courseImage = this.$$('.course-image img');
					Polymer.dom(courseImage).classList.remove('hover');
				}
			},
			onTileMouseOut: function() {
				this.unhoverCourseTile(true);
			},
			_enrollmentChanged: function(enrollment) {
				var parser = document.createElement('d2l-siren-parser');
				this._enrollmentEntity = parser.parse(enrollment);
			},
			_enrollmentEntityChanged: function(entity) {
				if (entity.hasLink('course-image')) {
					var courseImageLink = entity.getLinkByRel('course-image');
					var courseImage = this.$$('.course-image img');
					Polymer.dom(courseImage).setAttribute('src', courseImageLink.href);
				}

				this._courseUrl = '/d2l/home/' + entity.properties.id;

				var preferencesEntity = entity.getSubEntitiesByRel('preferences')[0];
				this._pinned = preferencesEntity.hasClass('pinned');

				var updatePreferencesAction = preferencesEntity.getActionByName('update');
				if (updatePreferencesAction) {
					this._updatePreferencesUrl = updatePreferencesAction.href;
					this._updatePreferencesMethod = updatePreferencesAction.method;
					this._updatePreferencesFields = updatePreferencesAction.fields;
				}
			},
			_pinnedChanged: function(pinned) {
				var pinIcon = this.$$('.menu-item iron-icon.menu-icon'),
					pinText = this.$$('.menu-item .menu-text.pin'),
					unpinText = this.$$('.menu-item .menu-text.unpin'),
					pinTouchMenuItem = this.$$('d2l-touch-menu-item');

				if (pinned) {
					Polymer.dom(pinIcon).setAttribute('icon', 'd2l-tier1:pin-hollow');
					Polymer.dom(pinText).setAttribute('style', 'display: none');
					Polymer.dom(unpinText).setAttribute('style', 'display: inline');
					Polymer.dom(pinTouchMenuItem).setAttribute('text', this.localize('unpin'));
					Polymer.dom(pinTouchMenuItem).setAttribute('background-image', 'd2l-tier1:pin-hollow');
					Polymer.dom(pinTouchMenuItem).setAttribute('action-description', this.localize('unpinCourse', 'course', this._enrollmentEntity.properties.name));
				} else {
					Polymer.dom(pinIcon).setAttribute('icon', 'd2l-tier1:pin-filled');
					Polymer.dom(pinText).setAttribute('style', 'display: inline');
					Polymer.dom(unpinText).setAttribute('style', 'display: none');
					Polymer.dom(pinTouchMenuItem).setAttribute('text', this.localize('pin'));
					Polymer.dom(pinTouchMenuItem).setAttribute('background-image', 'd2l-tier1:pin-filled');
					Polymer.dom(pinTouchMenuItem).setAttribute('action-description', this.localize('pinCourse', 'course', this._enrollmentEntity.properties.name));
				}
			}
		});
	</script>
</dom-module>
