<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="d2l-course-tile-styles.html">
<link rel="import" href="icons.html">

<dom-module id="d2l-course-tile">
	<template>
		<style include="d2l-course-tile-styles"></style>

		<a href="" on-mouseover="showHoverMenu" on-mouseout="hideHoverMenu">
			<div
				class="course-image-container">
				<div class="course-image">
					<img />
				</div>
				<div class="hover-menu">
					<div class="menu-item" on-click="changePinState">
						<iron-icon class="menu-icon" icon="actions:pin"></iron-icon>
						<span class="menu-text"></span>
					</div>
				</div>
			</div>
			<div class="course-text"></div>
		</a>
	</template>

	<script>
		Polymer({
			is: 'd2l-course-tile',
			properties: {
				enrollment: {
					type: Object,
					observer: '_enrollmentChanged'
				},
				pinned: {
					type: Boolean
				}
			},
			ready: function () {
				this.setAttribute('role', 'link');
			},
			changePinState: function(e) {
				// Prevent the click from triggering navigation to the course
				e.preventDefault();

				var pinIcon = this.$$('.menu-item iron-icon'),
					pinText = this.$$('.menu-item span');

				if (this.pinned) {
					this.pinned = false;
					Polymer.dom(pinIcon).setAttribute('icon', 'actions:unpin');
					Polymer.dom(pinText).textContent = 'Unpin';
				} else {
					this.pinned = true;
					Polymer.dom(pinIcon).setAttribute('icon', 'actions:pin');
					Polymer.dom(pinText).textContent = 'Pin';
				}
			},
			showHoverMenu: function() {
				var hoverMenu = this.$$('.hover-menu');
				Polymer.dom(hoverMenu).classList.add('hover');

				var courseImage = this.$$('.course-image img');
				Polymer.dom(courseImage).classList.add('hover');
			},
			hideHoverMenu: function() {
				var hoverMenu = this.$$('.hover-menu');
				Polymer.dom(hoverMenu).classList.remove('hover');

				var courseImage = this.$$('.course-image img');
				Polymer.dom(courseImage).classList.remove('hover');
			},
			_enrollmentChanged: function (enrollment) {
				var parser = document.createElement('d2l-siren-parser');
				var entity = parser.parse(enrollment);

				if (entity.hasLink('course-image')) {
					var courseImageLink = entity.getLinkByRel('course-image');
					var courseImage = this.$$('.course-image img');
					Polymer.dom(courseImage).setAttribute('src', courseImageLink.href);
				}

				var anchor = this.$$('a');
				Polymer.dom(anchor).setAttribute('href', '/d2l/home/' + enrollment.properties.id);

				var courseText = this.$$('.course-text');
				Polymer.dom(courseText).innerHTML = enrollment.properties.name;

				var pinIcon = this.$$('.menu-item iron-icon.menu-icon'),
					pinText = this.$$('.menu-item span.menu-text'),
					pinnedPrefs = entity.getSubEntitiesByClass('pinned');

				if (pinnedPrefs.length > 0) {
					Polymer.dom(pinIcon).setAttribute('icon', 'actions:unpin');
					Polymer.dom(pinText).textContent = 'Unpin';
					this.pinned = false;
				} else {
					Polymer.dom(pinIcon).setAttribute('icon', 'actions:pin');
					Polymer.dom(pinText).textContent = 'Pin';
					this.pinned = true;
				}
			}
		});
	</script>
</dom-module>
