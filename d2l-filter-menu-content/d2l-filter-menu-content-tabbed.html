<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="../../d2l-menu/d2l-menu.html">
<link rel="import" href="../../d2l-search-widget/d2l-search-widget.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="../d2l-utility-behavior.html">
<link rel="import" href="../localize-behavior.html">
<link rel="import" href="d2l-list-item-filter.html">

<dom-module id="d2l-filter-menu-content-tabbed">
	<template>
		<style>
			:host {
				display: flex;
				flex-direction: column;
			}
			:host([hidden]) {
				display: none !important;
			}
			button:hover,
			button:focus {
				text-decoration: underline;
				color: var(--d2l-color-celestine);
			}
			.dropdown-content-tabs {
				display: flex;
				align-items: center;
			}
			.dropdown-content-tab {
				flex: 1;
			}
			.dropdown-content-tab-button {
				@apply --d2l-body-small-text;
				color: var(--d2l-color-ferrite);
				background: none;
				border: none;
				padding: 10px;
				cursor: pointer;
				display: inherit;
				font-family: inherit;
			}
			.dropdown-content-tab-highlight {
				background-color: var(--d2l-color-celestine);
				border-bottom-left-radius: 4px;
				border-bottom-right-radius: 4px;
				height: 4px;
				width: 80%;
				margin: auto;
			}
			d2l-search-widget {
				--d2l-search-widget-height: 45px;
				margin: 10px 20px;
			}
			.no-items-text {
				@apply --d2l-body-compact-text;
				margin: 10px;
			}
			.clear-button {
				@apply --d2l-body-small-text;
				color: var(--d2l-color-celestine);
				background: none;
				border: none;
				cursor: pointer;
				margin: 0 !important;
				padding: 0;
			}
			.dropdown-content-header {
				box-sizing: border-box;
				display: flex;
				justify-content: space-between;
				border-bottom: 1px solid var(--d2l-color-titanius);
				width: 100%;
				padding: 20px;
			}
			#contentView {
				background: linear-gradient(to top, white, var(--d2l-color-regolith));
			}
		</style>

		<d2l-loading-spinner
			hidden=[[_showContent]]
			size="50">
		</d2l-loading-spinner>

		<div hidden="[[!_showContent]]" class="dropdown-content-header">
			<span>{{localize('filtering.filterBy')}}</span>
			<template is="dom-if" if="[[_showClearButton]]">
				<button class="clear-button" on-tap="_clearFilters">{{localize('filtering.clear')}}</button>
			</template>
		</div>

		<div hidden="[[!_showContent]]" id="contentView">
			<div class="dropdown-content-tabs" role="tablist">
				<div class="dropdown-content-tab" role="tab" aria-controls="semesterList">
					<div class="dropdown-content-tab-highlight" id="semesterListHighlight" hidden="[[!_semesterListVisible]]"></div>
					<button
						id="semesterListButton"
						class="dropdown-content-tab-button"
						on-tap="_selectSemesterList"
						aria-pressed="true">
						{{localize('filtering.semesterDefault')}}
					</button>
				</div>
				<div class="dropdown-content-tab" role="tab" aria-controls="departmentList">
					<div class="dropdown-content-tab-highlight" id="departmentListHighlight" hidden="[[!_departmentListVisible]]"></div>
					<button
						id="departmentListButton"
						class="dropdown-content-tab-button"
						on-tap="_selectDepartmentList"
						aria-pressed="false">
						{{localize('filtering.departmentDefault')}}
					</button>
				</div>
			</div>
			<div id="semesterList" hidden="[[!_semesterListVisible]]" aria-labelledby="semesterListButton" role="tabpanel">
				<d2l-search-widget
					id="semesterSearchWidget"
					hidden$="[[!_hasSemesters]]"
					placeholder-text="{{localize('filtering.searchSemesters')}}"
					search-button-label="{{localize('search')}}"
					clear-button-label="{{localize('search.clearSearch')}}"
					search-action="[[_searchSemestersAction]]"
					search-field-name="search"
					cache-responses></d2l-search-widget>
				<d2l-menu
					label="{{localize('filtering.semesterDefault')}}"
					hidden$="[[!_hasSemesters]]">
					<template is="dom-repeat" items="[[_semesters]]">
						<d2l-list-item-filter
							enrollment-entity="[[item]]"
							selected="[[_checkSelected(item)]]">
						</d2l-list-item-filter>
					</template>
				</d2l-menu>

				<div id="noSemestersText" class="no-items-text" hidden$="[[_hasSemesters]]">
					{{localize('filtering.noFilterItemsDefault')}}
				</div>
			</div>
			<div id="departmentList" hidden="[[!_departmentListVisible]]" aria-labelledby="departmentListButton" role="tabpanel">
				<d2l-search-widget
					id="departmentSearchWidget"
					hidden$="[[!_hasDepartments]]"
					placeholder-text="{{localize('filtering.searchDepartments')}}"
					search-button-label="{{localize('search')}}"
					clear-button-label="{{localize('search.clearSearch')}}"
					search-action="[[_searchDepartmentsAction]]"
					search-field-name="search"
					cache-responses></d2l-search-widget>
				<d2l-menu
					label="{{localize('filtering.departmentDefault')}}"
					hidden$="[[!_hasDepartments]]">
					<template is="dom-repeat" items="[[_departments]]">
						<d2l-list-item-filter
							enrollment-entity="[[item]]"
							selected="[[_checkSelected(item)]]">
						</d2l-list-item-filter>
					</template>
				</d2l-menu>

				<div id="noDepartmentsText" class="no-items-text" hidden$="[[_hasDepartments]]">
					{{localize('filtering.noFilterItemsDefault')}}
				</div>
			</div>
		</div>
	</template>

	<script>
		'use strict';

		/* global Promise */

		Polymer({
			is: 'd2l-filter-menu-content-tabbed',
			properties: {
				myEnrollmentsEntity: {
					type: Object,
					value: function() { return {}; },
					observer: '_myEnrollmentsEntityChanged'
				},
				// Standard Semester OU Type name to be displayed
				filterStandardSemesterName: String,
				// Standard Department OU Type name to be displayed
				filterStandardDepartmentName: String,
				_currentFilters: {
					type: Array,
					value: function() { return []; }
				},
				_departmentListVisible: {
					type: Boolean,
					value: false
				},
				_departments: {
					type: Array,
					value: function() { return []; }
				},
				_departmentsUrl: String,
				_hasDepartments: {
					type: Boolean,
					value: false
				},
				_hasSemesters: {
					type: Boolean,
					value: false
				},
				_numSemesterFilters: {
					type: Number,
					value: 0
				},
				_numDepartmentFilters: {
					type: Number,
					value: 0
				},
				_searchSemestersAction: Object,
				_searchDepartmentsAction: Object,
				_semesterListVisible: {
					type: Boolean,
					value: false
				},
				_semesters: {
					type: Array,
					value: function() { return []; }
				},
				_semestersUrl: String,
				_showClearButton: {
					type: Boolean,
					value: false
				},
				_showContent: {
					type: Boolean,
					value: false
				}
			},
			behaviors: [
				window.D2L.Hypermedia.HMConstantsBehavior,
				window.D2L.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.UtilityBehavior
			],
			observers: [
				'_updateEmptyStateMessages(filterStandardDepartmentName, filterStandardSemesterName)',
				'_updateSemesterFilterLabel(_numSemesterFilters, filterStandardSemesterName)',
				'_updateDepartmentFilterLabel(_numDepartmentFilters, filterStandardDepartmentName)'
			],
			attached: function() {
				this.listen(this.$.departmentSearchWidget, 'd2l-search-widget-results-changed', '_onDepartmentSearchResults');
				this.listen(this.$.semesterSearchWidget, 'd2l-search-widget-results-changed', '_onSemesterSearchResults');
				this.listen(this.$.departmentList, 'd2l-menu-item-change', '_updateDepartmentFilter');
				this.listen(this.$.semesterList, 'd2l-menu-item-change', '_updateSemesterFilter');
			},
			detached: function() {
				this.unlisten(this.$.departmentSearchWidget, 'd2l-search-widget-results-changed', '_onDepartmentSearchResults');
				this.unlisten(this.$.semesterSearchWidget, 'd2l-search-widget-results-changed', '_onSemesterSearchResults');
				this.unlisten(this.$.departmentList, 'd2l-menu-item-change', '_updateDepartmentFilter');
				this.unlisten(this.$.semesterList, 'd2l-menu-item-change', '_updateSemesterFilter');
			},
			ready: function() {
				this.filterStandardSemesterName = this.localize('filtering.semesterDefault');
				this.filterStandardDepartmentName = this.localize('filtering.departmentDefault');
			},
			load: function() {
				if (this._departments.length > 0 || this._semesters.length > 0) {
					// We've already loaded, don't load again
					this.$.departmentSearchWidget.search();
					this.$.semesterSearchWidget.search();
					return;
				}

				var self = this;
				var fetchDepartments = this.fetchSirenEntity(this._departmentsUrl)
					.then(function(departmentsEntity) {
						self.set('_departments', departmentsEntity.entities || []);
						self.$.departmentSearchWidget.search();
					});
				var fetchSemesters = this.fetchSirenEntity(this._semestersUrl)
					.then(function(semestersEntity) {
						self.set('_semesters', semestersEntity.entities || []);
						self.$.semesterSearchWidget.search();
					});

				return Promise
					.all([
						fetchDepartments,
						fetchSemesters
					])
					.then(function() {
						self._showContent = true;
					})
					.catch(function() {
						self._showContent = true;
					});
			},
			open: function() {
				this.load();
				if (this._searchSemestersAction) {
					this._selectSemesterList();
				} else {
					this._selectDepartmentList();
				}
			},
			_departmentsLoaded: false,
			_semestersLoaded: false,
			_checkSelected: function(entity) {
				// Checks if the given entity should be "selected" - used when semester/department search results change mostly
				var id = entity.href || entity.getLinkByRel(this.HypermediaRels.organization).href;
				return this._currentFilters.indexOf(id) > -1;
			},
			_clearFilters: function() {
				var items = this.$.departmentList.querySelectorAll('d2l-list-item-filter');
				var i;
				for (i = 0; i < items.length; i++) {
					items[i].selected = false;
				}
				items = this.$.semesterList.querySelectorAll('d2l-list-item-filter');
				for (i = 0; i < items.length; i++) {
					items[i].selected = false;
				}

				this._showClearButton = false;

				// Clear button is removed via dom-if, so need to manually set focus to next element
				if (this._departmentListVisible) {
					this.$.departmentListButton.focus();
				} else {
					this.$.semesterListButton.focus();
				}

				this.$.semesterSearchWidget.clear();
				this.$.departmentSearchWidget.clear();

				this.set('_currentFilters', []);
				this.set('_numSemesterFilters', 0);
				this.set('_numDepartmentFilters', 0);
			},
			_myEnrollmentsEntityChanged: function(entity) {
				// Set up search URLs and search Actions for filter dropdown
				if (entity) {
					var myEnrollmentsEntity = this.parseEntity(entity);

					this._searchSemestersAction = undefined;
					this._semestersUrl = undefined;
					if (myEnrollmentsEntity.hasActionByName(this.HypermediaActions.enrollments.searchMySemesters)) {
						this._searchSemestersAction = myEnrollmentsEntity.getActionByName(this.HypermediaActions.enrollments.searchMySemesters);
					} else if (myEnrollmentsEntity.hasActionByName(this.HypermediaActions.enrollments.addSemesterFilter)) {
						this._searchSemestersAction = myEnrollmentsEntity.getActionByName(this.HypermediaActions.enrollments.addSemesterFilter);
					}
					if (myEnrollmentsEntity.hasLinkByRel(this.HypermediaRels.semesters)) {
						this._semestersUrl = myEnrollmentsEntity.getLinkByRel(this.HypermediaRels.semesters).href;
					}

					this._searchDepartmentsAction = undefined;
					this._departmentsUrl = undefined;
					if (myEnrollmentsEntity.hasActionByName(this.HypermediaActions.enrollments.searchMyDepartments)) {
						this._searchDepartmentsAction = myEnrollmentsEntity.getActionByName(this.HypermediaActions.enrollments.searchMyDepartments);
					} else if (myEnrollmentsEntity.hasActionByName(this.HypermediaActions.enrollments.addDepartmentFilter)) {
						this._searchDepartmentsAction = myEnrollmentsEntity.getActionByName(this.HypermediaActions.enrollments.addDepartmentFilter);
					}
					if (myEnrollmentsEntity.hasLinkByRel(this.HypermediaRels.departments)) {
						this._departmentsUrl = myEnrollmentsEntity.getLinkByRel(this.HypermediaRels.departments).href;
					}
				}
			},
			_updateEmptyStateMessages: function(departmentFilterName, semesterFilterName) {
				this.$.noSemestersText.textContent = this.localize('filtering.noFilterItems', 'semester', semesterFilterName, 'department', departmentFilterName);
				this.$.noDepartmentsText.textContent = this.localize('filtering.noFilterItems', 'semester', semesterFilterName, 'department', departmentFilterName);
			},
			__updateFilterLabel: function(numFilters, filterName, button, searchWidget) {
				button.textContent = this.localize('filtering.filterLabel', 'filterLabel', filterName, 'num', numFilters);

				searchWidget.placeholderText = this.localize('filtering.searchBy', 'filter', filterName);
				searchWidget.searchButtonLabel = this.localize('filtering.searchBy', 'filter', filterName);

				this.set('currentFilters', this._currentFilters);
				this._showClearButton = this.currentFilters.length > 0;
				this.fire('d2l-filter-menu-content-change', {
					filters: this.currentFilters
				});
			},
			_updateDepartmentFilterLabel: function(numDepartmentFilters, departmentFilterName) {
				this.__updateFilterLabel(numDepartmentFilters, departmentFilterName, this.$.departmentListButton, this.$.departmentSearchWidget);
			},
			_updateSemesterFilterLabel: function(numSemesterFilters, semesterFilterName) {
				this.__updateFilterLabel(numSemesterFilters, semesterFilterName, this.$.semesterListButton, this.$.semesterSearchWidget);
			},
			__onSearchResults: function(entity, hasPath) {
				if (!entity.hasLinkByRel) {
					entity = this.parseEntity(entity);
				}

				this.set(hasPath, (entity.entities || []).length > 0);
			},
			_onDepartmentSearchResults: function(e) {
				if (!this._departmentsLoaded) {
					// If this is the first load, select the semester list after we've fetched the contents
					this._selectSemesterList();
					this._departmentsLoaded = true;

					// Hide loading spinner
					if (this._semestersLoaded) {
						this._showContent = true;
					}
				}
				this.set('_departments', e.detail.entities);
				this.__onSearchResults(e.detail, '_hasDepartments');
				this.$.departmentList.querySelector('d2l-menu').resize();

				setTimeout(function() {
					// DE24225 - force dropdown to resize after opening
					window.dispatchEvent(new Event('resize'));
				}.bind(this), 200);
			},
			_onSemesterSearchResults: function(e) {
				if (!this._semestersLoaded) {
					// If this is the first load, select the semester list after we've fetched the contents
					this._selectSemesterList();
					this._semestersLoaded = true;

					// Hide loading spinner
					if (this._departmentsLoaded) {
						this._showContent = true;
					}
				}
				this.set('_semesters', e.detail.entities);
				this.__onSearchResults(e.detail, '_hasSemesters');
				this.$.semesterList.querySelector('d2l-menu').resize();

				setTimeout(function() {
					// DE24225 - force dropdown to resize after opening
					window.dispatchEvent(new Event('resize'));
				}.bind(this), 200);
			},
			__selectList: function(semester, department) {
				this._semesterListVisible = semester;
				this._departmentListVisible = department;
				this.$.semesterListButton.setAttribute('aria-pressed', semester);
				this.$.departmentListButton.setAttribute('aria-pressed', department);

				semester && this.$.semesterSearchWidget.clear();
				semester && this.$.semesterList.querySelector('d2l-menu').resize();

				department && this.$.departmentSearchWidget.clear();
				department && this.$.departmentList.querySelector('d2l-menu').resize();

				setTimeout(function() {
					// DE24225 - force dropdown to resize after opening
					window.dispatchEvent(new Event('resize'));
				}.bind(this), 200);
			},
			_selectDepartmentList: function() {
				this.__selectList(false, true);
			},
			_selectSemesterList: function() {
				this.__selectList(true, false);
			},
			__updateFilter: function(e, path) {
				if (e.detail.selected) {
					this.push('_currentFilters', e.detail.value);
					this.set(path, this[path] + 1);
				} else {
					var index = this._currentFilters.indexOf(e.detail.value);
					this.splice('_currentFilters', index, 1);
					this.set(path, this[path] - 1);
				}
			},
			_updateDepartmentFilter: function(e) {
				this.__updateFilter(e, '_numDepartmentFilters');
			},
			_updateSemesterFilter: function(e) {
				this.__updateFilter(e, '_numSemesterFilters');
			}
		});
	</script>
</dom-module>
