<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../../d2l-menu/d2l-menu.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="../d2l-utility-behavior.html">
<link rel="import" href="d2l-filter-list-item-role.html">

<dom-module id="d2l-filter-menu-tab-roles">
	<template>
		<style>
			:host {
				display: flex;
				flex-direction: column;
			}
			.no-items-text {
				@apply --d2l-body-compact-text;
				margin: 10px;
			}
		</style>

		<div hidden$="[[!_showContent]]">
			<d2l-menu label="[[menuLabelText]]">
				<template is="dom-repeat" items="[[_filters]]">
					<d2l-filter-list-item-role
						text="[[item.title]]"
						value="[[item.filters]]">
					</d2l-filter-list-item-role>
				</template>
			</d2l-menu>
		</div>

		<div class="no-items-text" hidden$="[[_showContent]]">[[noFiltersText]]</div>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-filter-menu-tab-roles',
			properties: {
				myEnrollmentsEntity: {
					type: Object,
					observer: '_myEnrollmentsEntityChanged'
				},
				menuLabelText: String,
				noFiltersText: String,
				_roleFiltersEntity: Object,
				_filters: {
					type: Array,
					value: function() { return []; }
				},
				_filterEntities: {
					type: Array,
					value: function() { return []; }
				},
				_showContent: {
					type: Boolean,
					value: false
				}
			},
			behaviors: [
				window.D2L.Hypermedia.HMConstantsBehavior,
				window.D2L.MyCourses.UtilityBehavior
			],
			listeners: {
				'd2l-menu-item-change': '_onMenuItemChange'
			},

			clear: function() {
				var items = this.$$('d2l-menu').querySelectorAll('d2l-filter-list-item-role');
				for (var i = 0; i < items.length; i++) {
					items[i].selected = false;
				}

				// This should instead use a `clear-role-filters` action from the API
				// (which would do effectively the same thing), but it doesn't exist yet
				var myEnrollmentsEntity = this.parseEntity(this.myEnrollmentsEntity);
				var actionName = this.HypermediaActions.enrollments.setRoleFilters;
				if (!myEnrollmentsEntity.hasActionByName(actionName)) {
					return;
				}
				var setRoleFiltersAction = myEnrollmentsEntity.getActionByName(actionName);
				var clearRoleFiltersUrl = this.createActionUrl(setRoleFiltersAction, {
					include: ''
				});

				return this._fetchFilterItems(clearRoleFiltersUrl);
			},
			resize: function() {
				this.$$('d2l-menu').resize();

				setTimeout(function() {
					// DE24225 - force dropdown to resize after opening
					window.dispatchEvent(new Event('resize'));
				}.bind(this), 200);
			},

			_computeShowContent: function(filtersLength) {
				return filtersLength > 0;
			},
			_myEnrollmentsEntityChanged: function(myEnrollmentsEntity) {
				myEnrollmentsEntity = this.parseEntity(myEnrollmentsEntity);
				var actionName = this.HypermediaActions.enrollments.setRoleFilters;
				if (!myEnrollmentsEntity.hasActionByName(actionName)) {
					return;
				}

				var setRoleFiltersAction = myEnrollmentsEntity.getActionByName(actionName);
				var setRoleFiltersUrl = this.createActionUrl(setRoleFiltersAction);

				this._fetchFilterItems(setRoleFiltersUrl);
			},
			_onMenuItemChange: function(e) {
				var actionName;
				if (e.detail.selected) {
					actionName = this.HypermediaActions.enrollments.roleFilters.addFilter;
				} else {
					actionName = this.HypermediaActions.enrollments.roleFilters.removeFilter;
				}

				var filters = e.detail.value;

				// Create the URL to add/remove the (first) filter
				var changeFilterAction = filters[0].getActionByName(actionName);
				var addRemoveUrl = this.createActionUrl(changeFilterAction);
				var request = this.fetchSirenEntity(addRemoveUrl);

				for (var i = 1; i < filters.length; i++) {
					var filter = filters[i];
					request = request.then(function(newFiltersEntity) {
						// The first fetchSirenEntity will change the entities, so grab the updated
						// filter from the newly-updated role filters (based on role href)
						if (!filter.hasLinkByRel('related')) {
							return Promise.resolve();
						}
						var relatedHref = filter.getLinkByRel('related').href;

						var newFilter = newFiltersEntity.entities.find(function(entity) {
							var link = entity.getLinkByRel('related');
							return link ? link.href === relatedHref : false;
						});
						if (!newFilter || !newFilter.hasActionByName(actionName)) {
							// In the event the next filter from the event no longer appears, skip it
							return Promise.resolve();
						}

						var action = newFilter.getActionByName(actionName);
						var url = this.createActionUrl(action);
						return this.fetchSirenEntity(url);
					}.bind(this));
				}

				request = request.then(this._parseFilterItems.bind(this));

				return request.then(this._applyRoleFilters.bind(this));
			},
			_applyRoleFilters: function() {
				// Use the apply-role-filters action to create the new searchUrl
				var applyAction = this._roleFiltersEntity.getActionByName(
					this.HypermediaActions.enrollments.roleFilters.applyRoleFilters
				);
				var searchUrl = this.createActionUrl(applyAction);
				var roles = applyAction.getFieldByName('roles').value;
				this.fire('role-filters-changed', {
					url: searchUrl,
					filterCount: roles.length ? roles.split(',').length : 0
				});
			},
			_fetchFilterItems: function(url) {
				return this.fetchSirenEntity(url)
					.then(this._parseFilterItems.bind(this));
			},
			_parseFilterItems: function(roleFiltersEntity) {
				this._roleFiltersEntity = roleFiltersEntity;
				this._filterEntities = this._roleFiltersEntity.entities || [];

				var filters = [];
				// DE27982 - Filters with the same title should be combined into one item
				this._filterEntities.forEach(function(filterEntity) {
					var existingFilter = filters.find(function(filter) {
						return filter.title === filterEntity.title;
					});

					if (existingFilter) {
						existingFilter.filters.push(filterEntity);
					} else {
						filters.push({
							title: filterEntity.title,
							filters: [filterEntity]
						});
					}
				});
				this._filters = filters;

				this._showContent = this._filterEntities.length > 0;
			}
		});
	</script>
</dom-module>
