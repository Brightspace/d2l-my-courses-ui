<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="d2l-my-courses-styles.html">
<link rel="import" href="d2l-course-tile.html">
<link rel="import" href="d2l-all-courses.html">
<link rel="import" href="d2l-formatjs-behavior.html">
<link rel="import" href="d2l-lang-terms.html">
<link rel="import" href="d2l-course-tile-region-behavior.html">

<dom-module id="d2l-my-courses">
	<template>
		<style include="d2l-my-courses-styles"></style>

		<d2l-lang-terms></d2l-lang-terms>

		<d2l-ajax
			id="enrollmentsRequest"
			auto
			on-response="enrollmentsOnResponse"
			url="[[pinnedCoursesUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			last-response="{{enrollmentsResponse}}"></d2l-ajax>

		<div class="my-courses-container">
		<div class="my-courses-container">
			<template
				is="dom-repeat"
				items="[[enrollmentsResponse.entities]]">
					<d2l-course-tile
						target="/d2l/home/[[item.properties.id]]"
						name="[[item.properties.name]]"
						image-src="{{getCourseImageUrl(item.links)}}"
						pinned="{{getPinnedState(item.entities)}}"></d2l-course-tile>
			</template>
		</div>

		<button id="all-courses-button" on-tap="openAllCoursesView" aria-haspopup="true">{{viewAllCourses}}</button>

		<d2l-all-courses
			enrollments-url="[[enrollmentsUrl]]"
			pinned-courses-entities="{{enrollmentsResponse.entities}}"
			locale="[[locale]]">
		</d2l-all-courses>
	</template>

	<script>
		Polymer({
			is: 'd2l-my-courses',
			properties: {
				enrollmentsResponse: {
					type: Object,
					readOnly: true
				},
				enrollmentsUrl: {
					type: String
				},
				pinnedCoursesUrl: {
					computed: '_getPinnedCoursesUrl(enrollmentsUrl)'
				},
				windowResizeHandler: {
					type: Object,
					readOnly: true,
					value: function () {
						return this._handleWindowResize.bind(this);
					}
				}
			},
			observers: [
				'_updateData(messages, locale)'
			],
			behaviors: [
				Polymer.d2l.CourseTileRegionBehavior,
				Polymer.d2l.formatJSBehavior
			],
			ready: function () {
				this.messages = this.$$('d2l-lang-terms').langTerms;
				this._getTranslations();
			},
			attached: function () {
				this._addThrottledEventListener('resize', this.windowResizeHandler);
			},
			detached: function () {
				window.removeEventListener('resize', this.windowResizeHandler);
			},
			enrollmentsOnResponse: function (response) {
				if (response.detail.status === 200) {
					this._setupColumns(response.detail.xhr.response.entities.length);
					this._setEnrollmentsResponse(response.detail.xhr.response);
				}
			},
			openAllCoursesView: function () {
				this.$$('d2l-all-courses').open();
			},
			_updateData: function(messages, locale) {
				this.messages = messages;
				this.locale = locale;
				this._getTranslations();
			},
			_getTranslations: function() {
				if(this.messages) {
					this.viewAllCourses = this.format(this.getCultureTerm('viewAllCourses'), null);
				}
			},
			_getPinnedCoursesUrl: function (enrollmentsUrl) {
				return enrollmentsUrl + '?filter=pinned';
			},
			get courseTileItemCount() {
				var itemCount = this.enrollmentsResponse ? this.enrollmentsResponse.entities.length : 0;
				return itemCount;
			}
		});
	</script>
</dom-module>
