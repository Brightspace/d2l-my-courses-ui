<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-link/d2l-link.html">
<link rel="import" href="d2l-my-courses-styles.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-simple-overlay.html">
<link rel="import" href="d2l-all-courses.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-course-tile-grid.html">

<dom-module id="d2l-my-courses">
	<template>
		<style include="d2l-my-courses-styles"></style>

		<d2l-ajax
			id="enrollmentsRootRequest"
			url="[[enrollmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-response="onEnrollmentsRootResponse">
		</d2l-ajax>

		<d2l-ajax
			id="enrollmentsSearchRequest"
			url="[[_enrollmentsSearchUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-response="onEnrollmentsSearchResponse">
		</d2l-ajax>

		<d2l-alert visible="[[!_hasPinnedCourses]]">
			{{_alertMessage}}
			<a is="d2l-link"
				href="Javascript:void(0);"
				hidden$="[[_hasCourses]]"
				on-tap="refreshPage">{{localize('refresh')}}</a>
		</d2l-alert>

		<d2l-course-tile-grid
			course-entities="{{pinnedCoursesEntities}}">
		</d2l-course-tile-grid>

		<button class="all-courses-button"
			hidden$="{{!_hasCourses}}"
			on-tap="openAllCoursesView">
			{{localize('viewAllCourses')}}
		</button>

		<d2l-simple-overlay
			id="all-courses"
			title="{{localize('allCourses')}}"
			locale="[[locale]]"
			with-backdrop>

			<d2l-all-courses
				pinned-courses-entities="{{pinnedCoursesEntities}}"
				unpinned-courses-entities="{{unpinnedCoursesEntities}}"
				locale="[[locale]]">
			</d2l-all-courses>
		</d2l-simple-overlay>

	</template>

	<script>
		Polymer({
			is: 'd2l-my-courses',
			properties: {
				delayLoad: {
					type: Boolean,
					value: false
				},
				enrollmentsUrl: {
					type: String
				},
				_alertMessage: {
					type: String
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.InteractionDetectionBehavior,
				Polymer.D2L.MyCourses.CourseManagementBehavior
			],
			ready: function() {
				this._alertMessage = this.localize('noCoursesMessage');

				var overlay = this.$$('d2l-simple-overlay');
				var allCourses = this.$$('d2l-all-courses');
				overlay.focusableNodesOverride = allCourses.focusableNodesOverride.bind(allCourses);
			},
			attached: function() {
				if (!this.delayLoad) {
					// TODO: Remove this override once the LMS is updated
					this.enrollmentsUrl = '/d2l/api/hm/enrollments';
					this.$.enrollmentsRootRequest.generateRequest();
				}
			},
			onEnrollmentsRootResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var enrollmentsRoot = parser.parse(response.detail.xhr.response);

					if (!enrollmentsRoot.hasAction('search-my-enrollments')) {
						return;
					}

					var searchAction = enrollmentsRoot.getActionByName('search-my-enrollments');
					this._enrollmentsSearchUrl = searchAction.href + '?';

					var query = {};
					if (searchAction.hasFieldByName('pageSize')) {
						query.pageSize = 20;
					}
					if (searchAction.hasFieldByName('embedDepth')) {
						query.embedDepth = 1;
					}
					var queryString = Object.keys(query).map(function(key) {
						return key + '=' + query[key];
					}).join('&');

					this._enrollmentsSearchUrl += queryString;

					this.$.enrollmentsSearchRequest.generateRequest();
				}
			},
			onEnrollmentsSearchResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var enrollments = parser.parse(response.detail.xhr.response);
					var enrollmentEntities = enrollments.getSubEntitiesByClass('enrollment');

					var pinnedEnrollments = [];
					var unpinnedEnrollments = [];

					enrollmentEntities.forEach(function(enrollment) {
						if (enrollment.hasClass('pinned')) {
							pinnedEnrollments.push(enrollment);
						} else {
							unpinnedEnrollments.push(enrollment);
						}
					});

					this.set('pinnedCoursesEntities', pinnedEnrollments);
					this.set('unpinnedCoursesEntities', unpinnedEnrollments);

					this._hasPinnedCourses = this.pinnedCoursesEntities.length > 0;
					this._hasCourses = this._hasPinnedCourses || this.unpinnedCoursesEntities.length > 0;
				}
			},
			refreshPage: function() {
				document.location.reload(true);
			},
			openAllCoursesView: function(e) {
				e.preventDefault();
				e.stopPropagation();
				this.$$('d2l-simple-overlay').open();

				setTimeout(function() {
					var allCourses = this.$$('d2l-all-courses');
					allCourses._rescaleCourseTileRegions(allCourses._getOverlayWidth());
				}.bind(this), 50);
			},
			getCourseTileItemCount: function() {
				return this.pinnedCoursesEntities.length;
			}
		});
	</script>
</dom-module>
