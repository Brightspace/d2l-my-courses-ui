<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-link/d2l-link.html">
<link rel="import" href="d2l-my-courses-styles.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-course-tile.html">
<link rel="import" href="d2l-simple-overlay.html">
<link rel="import" href="d2l-course-tile-region-behavior.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-interaction-detection-behavior.html">
<link rel="import" href="d2l-course-management-behavior.html">

<dom-module id="d2l-my-courses">
	<template>
		<style include="d2l-my-courses-styles"></style>

		<d2l-ajax
			id="enrollmentsRequest"
			url="[[enrollmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-response="onEnrollmentsResponse">
		</d2l-ajax>

		<d2l-alert visible="[[!_hasPinnedCourses]]">
			{{_alertMessage}}
			<a is="d2l-link"
				href="Javascript:void(0);"
				hidden$="[[_hasPinnedCourses]]"
				on-tap="refreshPage">{{localize('refresh')}}</a>
		</d2l-alert>

		<div class="my-courses-container">
			<template is="dom-repeat" items="[[pinnedCoursesEntities]]">
				<d2l-course-tile
					enrollment="[[item]]"
					hover-enabled="[[_hoverInteractionEnabled]]"
					touch-enabled="[[_touchInteractionEnabled]]"
					animate-insertion="[[removeCourseFromTransitionList(item.properties.id)]]">
				</d2l-course-tile>
			</template>
		</div>

		<button class="all-courses-button"
			hidden$="{{!_hasCourses}}"
			on-tap="openAllCoursesView"
			aria-haspopup="true">
			{{localize('viewAllCourses')}}
		</button>

		<d2l-simple-overlay
			id="all-courses"
			title="{{localize('allCourses')}}"
			locale="[[locale]]"
			with-backdrop>

			<div class="all-courses">
				<h3 class="d2l-heading-3">{{localize('pinnedCourses')}}</h3>
				<d2l-alert visible="{{!_hasPinnedCourses}}">
					{{localize('noPinnedCoursesMessage')}}
				</d2l-alert>
				<div class="my-courses-container" role="region">
					<template is="dom-repeat" items="[[pinnedCoursesEntities]]">
						<d2l-course-tile
							enrollment="[[item]]"
							hover-enabled="[[_hoverInteractionEnabled]]"
							touch-enabled="[[_touchInteractionEnabled]]"
							animate-insertion="[[removeCourseFromTransitionList(item.properties.id)]]">
						</d2l-course-tile>
					</template>
				</div>

				<h3 class="d2l-heading-3">{{localize('unpinnedCourses')}}</h3>
				<div class="my-courses-container" role="region">
					<template is="dom-repeat" items="[[unpinnedCoursesEntities]]">
						<d2l-course-tile
							enrollment="[[item]]"
							hover-enabled="[[_hoverInteractionEnabled]]"
							touch-enabled="[[_touchInteractionEnabled]]"
							animate-insertion="[[removeCourseFromTransitionList(item.properties.id)]]">
						</d2l-course-tile>
					</template>
				</div>
			</div>
		</d2l-simple-overlay>

	</template>

	<script>
		Polymer({
			is: 'd2l-my-courses',
			properties: {
				delayLoad: {
					type: Boolean,
					value: false
				},
				enrollmentsUrl: {
					type: String
				},
				_alertMessage: {
					type: String
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileRegionBehavior,
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.InteractionDetectionBehavior,
				Polymer.D2L.MyCourses.CourseManagementBehavior
			],
			ready: function() {
				this._alertMessage = this.localize('noPinnedCoursesMessage');

				var overlay = this.$$('d2l-simple-overlay');
				var allCourses = this.$$('.all-courses');
				overlay.focusableNodesOverride = this.focusableNodesOverride.bind(allCourses);
			},
			attached: function() {
				if (!this.delayLoad) {
					this.$.enrollmentsRequest.generateRequest();
				}
			},
			focusableNodesOverride: function() {
				var courseTileFocusables = [];

				Polymer.dom(this).querySelectorAll('d2l-course-tile').forEach(function(courseTile) {
					Array.prototype.push.apply(courseTileFocusables, Polymer.dom(courseTile.root).querySelectorAll('a'));
				});

				return courseTileFocusables;
			},
			onEnrollmentsResponse: function(response) {
				if (response.detail.status === 200) {
					this.setAllCoursesFromSirenResponse(response.detail.xhr.response);

					if (!this._hasCourses) {
						this._alertMessage = this.localize('noCoursesMessage');
					}

					this._setupColumns();
				}
			},
			refreshPage: function() {
				document.location.reload(true);
			},
			openAllCoursesView: function(e) {
				e.preventDefault();
				e.stopPropagation();
				this.$$('d2l-simple-overlay').open();

				setTimeout(function() {
					var itemCount = Math.max(this.pinnedCoursesEntities.length, this.unpinnedCoursesEntities.length);
					this._setupColumns(itemCount, this.$$('.all-courses'));
				}.bind(this), 100);
			},
			get courseTileItemCount() {
				return this.pinnedCoursesEntities.length;
			}
		});
	</script>
</dom-module>
