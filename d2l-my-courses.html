<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-link/d2l-link.html">
<link rel="import" href="d2l-my-courses-styles.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-course-tile.html">
<link rel="import" href="d2l-all-courses.html">
<link rel="import" href="d2l-course-tile-region-behavior.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-interaction-detection-behavior.html">

<dom-module id="d2l-my-courses">
	<template>
		<style include="d2l-my-courses-styles"></style>

		<d2l-ajax
			id="pinnedCoursesRequest"
			url="[[_pinnedCoursesUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-response="onPinnedCoursesResponse"
			last-response="{{_pinnedCoursesResponse}}">
		</d2l-ajax>

		<d2l-ajax
			id="allCoursesRequest"
			url="[[_effectiveEnrollmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-response="onAllCoursesResponse">
		</d2l-ajax>

		<d2l-alert visible="{{_alertMessage}}">
			{{_alertMessage}}
			<a is="d2l-link"
				href="Javascript:void(0);"
				hidden$="{{_hasCourses}}"
				on-tap="refreshPage">{{localize('refresh')}}</a>
		</d2l-alert>

		<div class="my-courses-container">
			<template is="dom-repeat" items="[[pinnedCoursesEntities]]">
				<d2l-course-tile
					enrollment="[[item]]"
					hover-enabled="[[_hoverInteractionEnabled]]"
					touch-enabled="[[_touchInteractionEnabled]]">
				</d2l-course-tile>
			</template>
		</div>

		<d2l-offscreen aria-live="polite">{{ariaMessage}}</d2l-offscreen>

		<button class="all-courses-button"
			hidden$="{{!_hasCourses}}"
			on-tap="openAllCoursesView"
			aria-haspopup="true">
			{{localize('viewAllCourses')}}
		</button>

		<d2l-all-courses
			enrollments-url="[[enrollmentsUrl]]"
			test-enrollments-url=[[testEnrollmentsUrl]]
			pinned-courses-entities="{{pinnedCoursesEntities}}"
			unpinned-courses-entities="{{unpinnedCoursesEntities}}"
			locale="[[locale]]">
		</d2l-all-courses>
	</template>

	<script>
		Polymer({
			is: 'd2l-my-courses',
			properties: {
				ariaMessage: {
					type: String,
					readOnly: true
				},
				delayLoad: {
					type: Boolean,
					value: false
				},
				enrollmentsUrl: {
					type: String
				},
				testEnrollmentsUrl: {
					type: String
				},
				pinnedCoursesEntities: {
					type: Array,
					value: []
				},
				unpinnedCoursesEntities: {
					type: Array,
					value: []
				},
				_alertMessage: {
					type: String
				},
				_hasCourses: {
					type: Boolean,
					value: false
				},
				_pinnedCoursesUrl: {
					type: String,
					computed: '_getPinnedCoursesUrl(enrollmentsUrl)'
				},
				allEnrollmentsUrl: {
					type: String
				},
				_windowResizeHandler: {
					type: Object,
					readOnly: true,
					value: function() {
						return this._handleWindowResize.bind(this);
					}
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileRegionBehavior,
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.InteractionDetectionBehavior
			],
			listeners: {
				'course-pinned': '_onCoursePinned',
				'course-unpinned': '_onCourseUnpinned'
			},
			ready: function() {
				if (!this.testEnrollmentsUrl) {
					this._effectiveEnrollmentsUrl = this.enrollmentsUrl;
				} else {
					this._effectiveEnrollmentsUrl = this.testEnrollmentsUrl;
				}
			},
			attached: function() {
				this._addThrottledEventListener('resize', this._windowResizeHandler);
				if (!this.delayLoad) {
					this.$.pinnedCoursesRequest.generateRequest();
				}
			},
			detached: function() {
				window.removeEventListener('resize', this._windowResizeHandler);
			},
			isActive: function(item) {
				return item.class.indexOf('inactive') === -1;
			},
			onPinnedCoursesResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var allEnrollments = parser.parse(response.detail.xhr.response);
					var allCourses = allEnrollments.getSubEntitiesByClass('course-offering');
					this.pinnedCoursesEntities = allCourses.filter(function(item) {
						return item.class.indexOf('inactive') === -1;
					});
					this._updateCourses();
				}
			},
			onAllCoursesResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var allEnrollments = parser.parse(response.detail.xhr.response);
					var allCourses = allEnrollments.getSubEntitiesByClass('course-offering');

					var newPinnedCourses = [];
					var newUnpinnedCourses = [];

					for (var i = 0; i < allCourses.length; i++) {
						if (allCourses[i].class.indexOf('inactive') === -1) {
							if (allCourses[i].hasEntityByClass('pinned')) {
								newPinnedCourses.push(allCourses[i]);
							} else {
								newUnpinnedCourses.push(allCourses[i]);
							}
						}
					}

					this.set('pinnedCoursesEntities', newPinnedCourses);
					this.set('unpinnedCoursesEntities', newUnpinnedCourses);

					this._updateNoCoursesAlert();
					this._rescaleCourseTileRegions();
				}
			},
			refreshPage: function() {
				document.location.reload(true);
			},
			openAllCoursesView: function(e) {
				e.preventDefault();
				e.stopPropagation();
				this.$$('d2l-all-courses').open();
			},
			_getPinnedCoursesUrl: function(enrollmentsUrl) {
				return enrollmentsUrl + '?filter=pinned';
			},
			get courseTileItemCount() {
				var itemCount = this.pinnedCoursesEntities ? this.pinnedCoursesEntities.length : 0;
				return itemCount;
			},
			_onCoursePinned: function(e) {
				this._ariaAnnounce(this.localize('pinActionResult', 'course', e.detail.course.properties.name));

				this._pinCourse(e.detail.course);
			},
			_onCourseUnpinned: function(e) {
				this._ariaAnnounce(this.localize('unpinActionResult', 'course', e.detail.course.properties.name));

				this._unpinCourse(e.detail.course);
			},
			_pinCourse: function(course) {
				// Remove course from unpinned list, add to pinned
				var foundCourse = null;

				for (var index = 0; index < this.unpinnedCoursesEntities.length; index++) {
					if (this.unpinnedCoursesEntities[index].properties.id === course.properties.id) {
						foundCourse = this.unpinnedCoursesEntities[index];
						this._setCoursePinned(foundCourse, true);
						this.push('pinnedCoursesEntities', foundCourse);
						this.splice('unpinnedCoursesEntities', index, 1);
						break;
					}
				}

				this._updateNoCoursesAlert();
				this._rescaleCourseTileRegions();
			},
			_unpinCourse: function(course) {
				// Remove course from pinned list, add to unpinned
				var foundCourse = null;

				for (var index = 0; index < this.pinnedCoursesEntities.length; index++) {
					if (this.pinnedCoursesEntities[index].properties.id === course.properties.id) {
						foundCourse = this.pinnedCoursesEntities[index];
						this._setCoursePinned(foundCourse, false);
						this.splice('pinnedCoursesEntities', index, 1);
						this.push('unpinnedCoursesEntities', foundCourse);
						break;
					}
				}

				this._updateNoCoursesAlert();
				this._rescaleCourseTileRegions();
			},
			_ariaAnnounce: function(message) {
				this._setAriaMessage('');
				this._setAriaMessage(message);
			},
			_updateCourses: function() {
				this._rescaleCourseTileRegions();

				if (this.courseTileItemCount === 0) {
					this.$.allCoursesRequest.generateRequest();
				} else {
					this._hasCourses = true;
				}
			},
			_setCoursePinned: function(entity, isPinned) {
				var modEntity = entity.entities[0];

				if (isPinned) {
					modEntity.properties.pinDate = Date.now();
					modEntity.class.push('pinned');
				} else {
					modEntity.properties.pinDate = undefined;
					modEntity.class.splice(modEntity.class.indexOf('pinned'), 1);
				}
			},
			_updateNoCoursesAlert: function() {
				var hasCourses = true;
				this._alertMessage = null;

				if (this.pinnedCoursesEntities.length === 0) {
					if (this.unpinnedCoursesEntities) {
						hasCourses = this.unpinnedCoursesEntities.length > 0;
					}

					if (hasCourses) {
						this._alertMessage = this.localize('noPinnedCoursesMessage');
					} else {
						this._alertMessage = this.localize('noCoursesMessage');
					}
				}

				this._hasCourses = hasCourses;
			}
		});
	</script>
</dom-module>
