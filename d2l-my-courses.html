<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-link/d2l-link.html">
<link rel="import" href="../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-simple-overlay.html">
<link rel="import" href="d2l-all-courses.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-course-list.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-search-widget.html">

<!--
`<d2l-my-courses>` is the main component for My Courses widget

@demo demo/d2l-my-courses-demo.html
-->
<dom-module id="d2l-my-courses">
	<template>
		<style include="d2l-colors"></style>
		<style include="d2l-typography-shared-styles"></style>
		<style>
			:host {
				display: block;
			}
			@media not all and (hover: hover) {
				:host {
					-webkit-user-select: none;
					user-select: none;
				}
			}
			.all-courses-button {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				color: var(--d2l-color-celestine);
				margin: 1rem 0px 0px 0px;
				font-weight: 700;
				/* end overrides */
				display: block;
				background: none;
				border: none;
				padding: 0;
				cursor: pointer;
				position: relative;
			}
			.all-courses-button:hover {
				text-decoration: underline;
			}
			.hidden {
				display: none;
			}
			.button-bar {
				margin-bottom: 10px;
				overflow: auto;
			}
			.button-bar .view-button {
				margin-right: 25px;
				float: left;
				display: block;
				position: relative;
			}
			.view-button {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				font-size: 1rem;
				color: var(--d2l-color-galena);
				/* end overrides */
				background: none;
				border: none;
				padding: 0;
				cursor: pointer;
			}
			.view-button:hover, .view-button:focus {
				text-decoration: underline;
			}
			.view-button-selected {
				font-weight: 700;
				color: var(--d2l-color-ferrite);
			}
			d2l-alert {
				padding-bottom: 30px;
				clear: both;
			}
			d2l-loading-spinner {
				display: block;
				margin: auto;
			}

			d2l-search-widget {
				margin-bottom: 60px;
			}
		</style>

		<d2l-ajax
			id="enrollmentsRootRequest"
			url="[[enrollmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onEnrollmentsRootResponse">
		</d2l-ajax>

		<d2l-ajax
			id="enrollmentsSearchRequest"
			url="[[_enrollmentsSearchUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onEnrollmentsSearchResponse">
		</d2l-ajax>

		<d2l-loading-spinner size="100"></d2l-loading-spinner>

		<d2l-search-widget
			organizations-url="/d2l/api/hm/organizations">
		</d2l-search-widget>

		<div class="my-courses-content hidden">
			<div class="button-bar" hidden$="[[!_hasManyEnrollments]]">
				<button
					id="tileViewButton"
					class="view-button view-button-selected"
					on-tap="_selectTileView"
					aria-pressed="false">
					{{localize('pinnedCoursesTab')}}
				</button>
				<button
					id="recentViewButton"
					class="view-button"
					on-tap="_selectRecentView"
					aria-pressed="true">
					{{localize('lastAccessedTab')}}
				</button>
			</div>

			<div id="recentView">
				<d2l-course-list
					enrollments-url="[[_recentEnrollmentsSearchUrl]]">
				</d2l-course-list>
			</div>

			<div id="tileView">
				<d2l-alert visible="[[!_hasPinnedEnrollments]]">
					{{_alertMessage}}
					<a
						is="d2l-link"
						href="Javascript:void(0);"
						hidden$="[[_hasEnrollments]]"
						on-tap="_refreshPage">{{localize('refresh')}}</a>
				</d2l-alert>
				<d2l-course-tile-grid
					enrollments="{{pinnedEnrollments}}">
				</d2l-course-tile-grid>
				<button
					class="all-courses-button"
					hidden$="{{!_hasEnrollments}}"
					on-tap="_openAllCoursesView">
					{{localize('viewAllCourses')}}
				</button>
			</div>
		</div>

		<d2l-simple-overlay
			id="all-courses"
			title$="{{localize('allCourses')}}"
			locale="[[locale]]"
			with-backdrop>

			<d2l-all-courses
				pinned-enrollments="{{pinnedEnrollments}}"
				unpinned-enrollments="{{unpinnedEnrollments}}"
				locale="[[locale]]">
			</d2l-all-courses>
		</d2l-simple-overlay>

	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-my-courses',

			/*
			* Fired when enrollments are received, to trigger recalculation of the number of columns
			* @event recalculate-columns
			*/

			properties: {
				/*
				* Allows for delaying the call to `enrollmentsUrl` (required by tests)
				* TODO: Better way to do this?
				* @type {Boolean}
				*/
				delayLoad: {
					type: Boolean,
					value: false
				},
				/*
				* URL that is called by the widget to fetch enrollments
				* @type {String}
				*/
				enrollmentsUrl: String,
				/*
				* Message to display in alert if no enrollments are found
				* @type {String}
				*/
				_alertMessage: String,
				/*
				* URL constructed to fetch a user's enrollments with the enrollments search Action
				* @type {String}
				*/
				_enrollmentsSearchUrl: String,
				/*
				* URL constructed to fetch a user's recent enrollments with the enrollments search Action
				* @type {String}
				*/
				_recentEnrollmentsSearchUrl: String
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.InteractionDetectionBehavior,
				Polymer.D2L.MyCourses.CourseManagementBehavior
			],
			ready: function() {
				this._alertMessage = this.localize('noCoursesMessage');

				this.toggleClass('hidden', true, this.$.courseTiles);
				this.toggleClass('hidden', true, this.$.courseList);

				var overlay = this.$$('d2l-simple-overlay');
				var allCourses = this.$$('d2l-all-courses');
				overlay.focusableNodesOverride = allCourses.focusableNodesOverride.bind(allCourses);
			},
			attached: function() {
				if (!this.delayLoad) {
					this.$.enrollmentsRootRequest.generateRequest();
				}
			},
			/*
			* Count of `d2l-course-tile` elements in grid.
			* @return {Number}
			*/
			getCourseTileItemCount: function() {
				return this.pinnedEnrollments.length;
			},
			_onEnrollmentsRootResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var enrollmentsRoot = parser.parse(response.detail.xhr.response);

					if (!enrollmentsRoot.hasAction('search-my-enrollments')) {
						return;
					}

					var searchAction = enrollmentsRoot.getActionByName('search-my-enrollments');

					var query = {
						pageSize: 25,
						embedDepth: 1
					};
					this._enrollmentsSearchUrl = this.createActionUrl(searchAction, query);
					this.$.enrollmentsSearchRequest.generateRequest();

					query.pageSize = 5;
					query.sortField = 'lastAccessed';
					query.sortDescending = true;
					this._recentEnrollmentsSearchUrl = this.createActionUrl(searchAction, query);
				} else {
					this._showContent();
				}
			},
			_onEnrollmentsSearchResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var enrollments = parser.parse(response.detail.xhr.response);
					var enrollmentEntities = enrollments.getSubEntitiesByClass('enrollment');

					var pinnedEnrollments = [];
					var unpinnedEnrollments = [];

					enrollmentEntities.forEach(function(enrollment) {
						if (enrollment.hasClass('pinned')) {
							pinnedEnrollments.push(enrollment);
						} else {
							unpinnedEnrollments.push(enrollment);
						}
					});

					this.set('pinnedEnrollments', pinnedEnrollments);
					this.set('unpinnedEnrollments', unpinnedEnrollments);
					this.set('enrollments', enrollmentEntities);

					this._hasPinnedEnrollments = this.pinnedEnrollments.length > 0;
					this._hasEnrollments = this._hasPinnedEnrollments || this.unpinnedEnrollments.length > 0;

					// Only show Recent Courses view to users with >20 enrollments
					this._hasManyEnrollments = this.enrollments.length > 20;
					this._selectTileView();

					if (this._hasEnrollments) {
						this._alertMessage = this.localize('noPinnedCoursesMessage');
					}

					this.fire('recalculate-columns');
				}

				this._showContent();
			},
			_openAllCoursesView: function(e) {
				e.preventDefault();
				e.stopPropagation();
				this.$$('d2l-simple-overlay').open();

				setTimeout(function() {
					// Slight delay to allow for overlay to get a DOM width before triggering the recalculation
					this.fire('recalculate-columns');
				}.bind(this), 50);
			},
			_refreshPage: function() {
				document.location.reload(true);
			},
			_selectRecentView: function() {
				this.toggleClass('hidden', false, this.$.recentView);
				this.toggleClass('hidden', true, this.$.tileView);
				this.toggleClass('view-button-selected', true, this.$.recentViewButton);
				this.toggleClass('view-button-selected', false, this.$.tileViewButton);
				this.$.recentViewButton.setAttribute('aria-pressed', true);
				this.$.tileViewButton.setAttribute('aria-pressed', false);
			},
			_selectTileView: function() {
				this.toggleClass('hidden', true, this.$.recentView);
				this.toggleClass('hidden', false, this.$.tileView);
				this.toggleClass('view-button-selected', false, this.$.recentViewButton);
				this.toggleClass('view-button-selected', true, this.$.tileViewButton);
				this.$.recentViewButton.setAttribute('aria-pressed', false);
				this.$.tileViewButton.setAttribute('aria-pressed', true);
			},
			_showContent: function() {
				this.toggleClass('hidden', true, this.$$('d2l-loading-spinner'));
				this.toggleClass('hidden', false, this.$$('.my-courses-content'));
			}
		});
	</script>
</dom-module>
