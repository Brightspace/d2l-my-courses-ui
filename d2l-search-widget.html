<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-search-listbox.html">
<link rel="import" href="d2l-utility-behavior.html">
<link rel="import" href="d2l-search-dropdown.html">

<dom-module id="d2l-search-widget">
	<template>
		<style>
			:host {
				position: relative;
				display: block;
				min-width: 100px;
				min-height: 60px;
				padding: 0;
				margin: 0;
			}

			input {
				width: 100%;
				height: 60px;
				background-color: #fff;
				border-color: #d3d9e3;
				border-width: 1px;
				box-shadow: inset 0 2px 0 0 rgba(185,194,208,.2);
				padding: .4rem 1rem;
				border-radius: .3rem;
				border-style: solid;
				vertical-align: middle;
				font-size: 1rem;
				font-weight: 300;
				letter-spacing: .015rem;
				font-family: inherit;
				box-sizing: border-box;
				-webkit-transition-duration: .5s;
				transition-duration: .5s;
				-webkit-transition-timing-function: ease;
				transition-timing-function: ease;
				-webkit-transition-property: background-color,border-color;
				transition-property: background-color,border-color;
			}

			input:focus,
			input:hover {
				border-color: #006FC1;
				border-width: 2px;
				outline-width: 0;
				padding: -webkit-calc(.4rem - 1px) -webkit-calc(1rem - 1px);
				padding: calc(.4rem - 1px) calc(1rem - 1px);
			}

			.dropdown-content {
				background-color: white;
			}

			d2l-dropdown {
				min-width: 100%;
			}

			.search-icon {
				position: absolute;
				left: 0.25rem;
				top: 0.45rem;
				background: none;
				border: none;
				margin: 0;
				cursor: pointer;
			}

			.search-icon iron-icon {
				width: 24px;
				height: 24px;
				color: var(--d2l-color-tungsten);
			}

		</style>

		<d2l-ajax
			id="organizationsSearchRootRequest"
			url="[[organizationsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onOrganizationsSearchRootResponse">
		</d2l-ajax>

		<d2l-ajax
			id="coursesSearchRequest"
			url="[[_organizationsSearchUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onCoursesSearchResponse">
		</d2l-ajax>

		<div class="search-bar" id="opener">
			<button on-click="_onSearchButtonClick" class="search-icon">
				<iron-icon icon="d2l-tier1:search"></iron-icon>
			</button>

			<input
				is="iron-input"
				bind-value="{{_searchString}}"
				role="combobox"
				aria-autocomplete="list"
				placeholder="{{localize('courseSearchInputPlaceholder')}}"
				on-keydown="_onSearchInputKeyPressed">
			</input>

			<!--
			<button type="button" on-click="_clearSearchResults" class="search-icon clear-search-button">
				<iron-icon icon="d2l-tier1:close-default"></iron-icon>
			</button>
			-->
		</div>

		<d2l-search-dropdown
			id="dropdown"
			no-pointer
			no-auto-close
			no-auto-focus
			vertical-offset="10">

			<div class="dropdown-content">
				<iron-pages selectable=".search-results-listbox-page" selected="0">
					<div class="search-results-listbox-page">
						<d2l-search-listbox id="previous-searches-listbox">
							<div class="d2l-heading-4" data-list-title disabled>{{localize('recentSearches')}}</div>
							<template is="dom-repeat" items="[[_previousSearches]]">
								<option selectable data-text$="[[item]]" data-href$="[[_computePreviousSearchLink(item)]]">
									[[item]]
								</option>
							</template>
						</d2l-search-listbox>
					</div>

					<div class="search-results-listbox-page">
						<d2l-search-listbox id="search-results-listbox">
							<template id="courseSearchResultsTemplate" is="dom-repeat" items="[[_courseSearchResults]]">
								<option selectable data-text$="[[item.name]]" data-href$="[[item.href]]">
									[[item.name]]
								</option>
							</template>
							<template is="dom-if" if="[[_showNoResults]]">
								<div disabled>{{localize('noSearchResults')}}</div>
							</template>
						</d2l-search-listbox>
					</div>
				</iron-pages>
			</div>
		</d2l-search-dropdown>
	</template>
	<script>
		'use strict';

		Polymer({
			is: 'd2l-search-widget',

			properties: {

				organizationsUrl: String,

				/*
				* The search string updated by the course search input
				* @type {String}
				*/
				_searchString: {
					type: String,
					value: function() {
						return '';
					},
					observer: '_onSearchStringChanged'
				},

				/*
				* An array of objects containing the results of the search-course-collection action
				* @type {Array}
				*/
				_courseSearchResults: {
					type: Array,
					value: function() {
						return [];
					}
				},

				_organizationsSearchUrl: String,

				/*
				* List of strings containing previously searched terms/selected courses
				* @type {Array}
				*/
				_previousSearches: {
					type: Array,
					value: function() {
						return [];
					}
				},

				/*
				* Boolean indicating whether the "No Results" message should be displayed in the search results dropdown
				* @type {Boolean}
				*/
				_showNoResults: Boolean
			},

			listeners: {
				'iron-select': '_onIronSelect'
			},

			behaviors: [
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.UtilityBehavior
			],

			attached: function() {
				var i = 0;
				var searchBarElements = this.$$('.search-bar').children;

				for (i = 0; i < searchBarElements.length; i++) {
					this.listen(searchBarElements[i], 'blur', '_onElementBlur');
					this.listen(searchBarElements[i], 'focus', '_onElementFocus');
				}

				this._listboxes = Polymer.dom(this.root).querySelectorAll('d2l-search-listbox').slice();

				for (i = 0; i < this._listboxes.length; i++) {
					this._listboxes[i].owner = this.$$('input');
				}

				this._activateSearchDropdownPage(0);
				this._initializePreviousSearches();
				this.$.organizationsSearchRootRequest.generateRequest();
			},

			detached: function() {
				var searchBarElements = this.$$('.search-bar').children;
				for (var i = 0; i < searchBarElements.length; i++) {
					this.unlisten(searchBarElements[i], 'blur', '_onElementBlur');
					this.unlisten(searchBarElements[i], 'focus', '_onElementFocus');
				}
			},

			/*
			* Retrieves previous searches from local storage to populate listbox
			*/
			_initializePreviousSearches: function() {
				if (window.localStorage.getItem('myCourses.previousSearches')) {
					try {
						var prevSearchObject = JSON.parse(window.localStorage.getItem('myCourses.previousSearches'));

						if (prevSearchObject.hasOwnProperty('searches') && prevSearchObject.searches instanceof Array) {
							this._previousSearches = prevSearchObject.searches;
						}
					} catch (exception) {
						window.localStorage.removeItem('myCourses.previousSearches');
						this._previousSearches = [];
					}
				}
			},

			/*
			* Calls the search-course-collection action, used to populate live search results in the listbox
			*/
			_liveSearch: function() {
				if (this._searchString) {
					var queryParams = {
						search: this._searchString,
						page: 1,
						pageSize: 5
					};

					this._organizationsSearchUrl = this.createActionUrl(
						this._organizationsSearchAction,
						queryParams,
						1
					);

					this.$.coursesSearchRequest.generateRequest();
				}
			},

			/*
			* Submits an advanced search request
			*/
			_advancedSearch: function(searchString) {
				if (searchString) {
					var queryString = this._advancedSearchUrl + searchString;
					this._addSearchToHistory(searchString);
					window.location.href = queryString;
				}
			},

			_onSearchButtonClick: function() {
				this._advancedSearch(this._searchString);
			},

			_clearSearchResults: function() {
				this._showNoResults = false;
				this._searchString = '';
				this.set('_courseSearchResults', []);
			},

			_onSearchStringChanged: function(newString) {
				if (this._listboxes) {
					if (newString.length > 0) {
						this._liveSearch();
						this._activateSearchDropdownPage(1);
					} else {
						this._clearSearchResults();
						this._activateSearchDropdownPage(0);
					}
				}
			},

			_onSearchInputKeyPressed: function(e) {
				switch (e.keyCode) {
					case this._keyCodes.ENTER:
						this._advancedSearch(this._searchString);
						break;

					case this._keyCodes.DOWN:
						if (this._currentListbox.hasItems()) {
							this._currentListbox.focus();
						}
						e.preventDefault();
						break;

					case this._keyCodes.UP:
						if (this._currentListbox.hasItems()) {
							this._currentListbox.focusLast();
						}
						e.preventDefault();
						break;
				}
			},

			/*
			 * Adds a search term to the list of recent searches.
			 * @param {String} Search string
			 */
			_addSearchToHistory: function(searchTerm) {
				// Remove prior existence of this search term if it exists
				var currSearchHistoryIndex = this._previousSearches.indexOf(searchTerm);

				if (currSearchHistoryIndex !== -1) {
					this.splice('_previousSearches', currSearchHistoryIndex, 1);
				}

				if (this.unshift('_previousSearches', searchTerm) > 5) {
					this.splice('_previousSearches', this._previousSearches.length - 1, 1);
				}

				window.localStorage.setItem(
					'myCourses.previousSearches',
					JSON.stringify({
						searches: this._previousSearches
					})
				);
			},

			/*
			 * Creates a search URL from a previous search term
			 * @param {String} Search string
			 */
			_computePreviousSearchLink: function(searchTerm) {
				return this._advancedSearchUrl + searchTerm;
			},

			_onOrganizationsSearchRootResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var organizationsResponse = parser.parse(response.detail.xhr.response);

					this._organizationsSearchAction = organizationsResponse.getActionByName('search-course-collection');

					// Temporarily override action href as actions won't work with canonical API until routes fixed
					this._organizationsSearchAction.href = '/d2l/api/hm/organizations';
				}
			},

			/*
			* Called when search-course-collection response received
			* @param {Object}
			*/
			_onCoursesSearchResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var organizationResponse = parser.parse(response.detail.xhr.response);
					var organizationEntities = organizationResponse.entities;
					var courseSearchResults = [];

					for (var i = 0; i < organizationEntities.length; i++) {
						courseSearchResults.push({
							name: organizationEntities[i].properties.name,
							href: organizationEntities[i].getLinkByRel(/\/organization-homepage$/).href
						});
					}

					this.set('_courseSearchResults', courseSearchResults);
					this._showNoResults = organizationEntities.length === 0;
				}
			},

			/*
			* Handles iron-select events, fired when listbox items are selected
			*/
			_onIronSelect: function(e) {
				if (e.detail.item.dataset.href) {
					if (e.detail.item.dataset.text) {
						this._addSearchToHistory(e.detail.item.dataset.text);
					}

					window.location.href = e.detail.item.dataset.href;
				}
			},

			/*
			* Indicates which dropdown context should be open.
			* @param {Number} Page number to activate
			*/
			_activateSearchDropdownPage: function(page) {
				this._currentListbox = this._listboxes[page];
				this.$$('iron-pages').select(page);
			},

			_keyCodes: {
				DOWN: 40,
				UP: 38,
				ENTER: 13
			},

			/*
			* URL for advanced search functionality (existing advanced search page from legacy My Courses widget).
			* @type {String}
			*/
			_advancedSearchUrl: 'le/manageCourses/search/6606?searchTerm=',

			/*
			 * Called when an element within the search bar gains focus, to open the dropdown.
			 */
			_onElementFocus: function() {
				if (!this.$.dropdown.opened) {
					this.$.dropdown.open(this.$.opener);
				}
			},

			/*
			* Called when an element within the search bar loses focus.
			* If the search bar isn't an ancestor of the newly focused item (e.relatedTarget),
			* the search listbox is closed.
			*/
			_onElementBlur: function(e) {
				if (this.$.dropdown.opened) {
					if (!e.relatedTarget || !Polymer.dom(this).deepContains(e.relatedTarget)) {
						this.$.dropdown.close();
					}
				}
			}

		});
	</script>
</dom-module>
