<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/animations/slide-from-bottom-animation.html">
<link rel="import" href="../neon-animation/animations/slide-from-top-animation.html">
<link rel="import" href="../neon-animation/animations/slide-down-animation.html">
<link rel="import" href="../neon-animation/animations/slide-up-animation.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="d2l-simple-overlay-styles.html">
<link rel="import" href="icons.html">

<dom-module id='d2l-simple-overlay'>
	<style include="d2l-simple-overlay-styles"></style>
	<template>
		<div class="max-width">
			<button class="close-button pull-right" on-tap="handleClose">
				<iron-icon icon="actions:close"></iron-icon>
			</button>
			<h2>{{title}}</h2>
		</div>
		<div class="scrollable">
			<div id="scrollable-width-container" class="max-width">
				<div id="margin-offset-placeholder">
					<content></content>
				</div>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'd2l-simple-overlay',
			behaviors: [
				Polymer.IronOverlayBehavior,
				Polymer.NeonAnimationRunnerBehavior
			],
			listeners: {
				'neon-animation-finish': '_onNeonAnimationFinish'
			},
			properties: {
				title: {
					type: String
				},
				animationConfig: {
					value: function() {
						return {
							'fromBottom': {
								name: 'slide-from-bottom-animation',
								node: this
							},
							'fromTop': {
								name: 'slide-from-top-animation',
								node: this
							},
							'down': {
								name: 'slide-down-animation',
								node: this
							},
							'up': {
								name: 'slide-up-animation',
								node: this
							}
						};
					}
				},
				windowResizeHandler: {
					type: Object,
					value: function () {
						return this._handleWindowResize.bind(this);
						},
					readOnly: true
					}
			},
			handleClose: function () {
				this.close();
			},
			_isMobile: function () {
				var width = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
				return width < 768;
			},
			_renderOpened: function () {
				this.cancelAnimation();

				if (this._isMobile()) {
					this.playAnimation('fromBottom');
				} else {
					this.playAnimation('fromTop');
				}
			},
			_renderClosed: function () {
				this.cancelAnimation();

				if (this._isMobile()) {
					this.playAnimation('down');
				} else {
					this.playAnimation('up');
				}
			},
			_onNeonAnimationFinish: function () {
				document.body.classList.toggle('d2l-shim-body-overflow', this.opened);
				if (this.opened) {
					this._finishRenderOpened();
					this._reinitializeLayout();
				} else {
					this._finishRenderClosed();
				}
			},
			_handleWindowResize: function () {
				this._reinitializeLayout();
			},
			_reinitializeLayout: function() {
				var scrollbarMarginClassName = "scrollbar-margin-offset";
				var maxWidthClassName = "max-width";
				var maxWidthOverflowClassName = "max-width-scrollable-overflow";
				
				var scrollableElement = this.$$('.scrollable');
				var scrollableContainer = this.$$('#scrollable-width-container');
				var marginOffsetPlaceholderElement = this.$$('#margin-offset-placeholder');
				
				var scrollbarVisible = scrollableElement.scrollHeight > scrollableElement.clientHeight;
				
				if(scrollbarVisible) {
					marginOffsetPlaceholderElement.classList.add(scrollbarMarginClassName);
					scrollableContainer.classList.add(maxWidthOverflowClassName);
					scrollableContainer.classList.remove(maxWidthClassName);
				}
				else {
					marginOffsetPlaceholderElement.classList.remove(scrollbarMarginClassName);
					scrollableContainer.classList.add(maxWidthClassName);
					scrollableContainer.classList.remove(maxWidthOverflowClassName);
				}
			},
			attached: function () {
				this._addThrottledEventListener('resize', this.windowResizeHandler);
			},
			detached: function () {
				window.removeEventListener('resize', this.windowResizeHandler);
			},
			_addThrottledEventListener: function (eventName, eventHandler) {
				var timeout = false,
					delay = 100;

				window.addEventListener(eventName, function () {
					clearTimeout(timeout);
					timeout = setTimeout(eventHandler, delay);
				});
			}
		})
	</script>
</dom-module>
