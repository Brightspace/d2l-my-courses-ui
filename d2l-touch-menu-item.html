<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="d2l-touch-menu-item-styles.html">

<dom-module id="d2l-touch-menu-item">
    <template>
        <style include="d2l-touch-menu-item-styles"></style>

        <div class="longpress-menu-item">
            <div class="longpress-menu-item-text">{{_displayText}}</div>

            <div class="longpress-menu-item-image-background">
                <img class="longpress-menu-item-image" src$="{{resolveUrl(_displayBackgroundImage)}}">
            </div>
        </div>

        <div class="d2l-offscreen" aria-live="assertive">{{ariaMessage}}</div>
    </template>
    <script>
        Polymer({
            is: 'd2l-touch-menu-item',
            properties: {
                backgroundImage: {
                    type: String,
                    observer: '_backgroundImageChanged'
                },
                text: {
                    type: String,
                    observer: '_textChanged'
                },
                selectionHandler: {
                    type: String
                },
                selectionHandlerFunc: {
                    type: Object
                },
                inTransition: {
                    type: Boolean
                },
                hoverState: {
                    type: Boolean,
                    observer: '_hoverStateChanged'
                },
                offset: {
                    type: Object,
                    observer: '_offsetChanged'
                },
                actionDescription: {
                    type: String
                },
                _menuItem: {
                    type: Object
                },
                _displayText: {
                    type: String
                },
                _displayBackgroundImage: {
                    type: String
                },
                _touchMenu: {
                    type: Object,
                    observer: '_initialize'
                },
                touchRegion: {
                    type: Object
                },
                ariaMessage: {
                    type: String,
                    readOnly: true
                },
                _hostNode: {
                    type: Object
                },
                _initialized: {
                    type: Boolean
                },
                _visible: {
                    type: Boolean,
                    readOnly: true
                }
            },
            ready: function() {
                this._menuItem = this.$$('.longpress-menu-item');
            },
            attached: function() {
                this._initialize();
            },
            _hoverStateChanged: function(isHovered, wasHovered) {
                this.toggleClass('longpress-menu-item-hover', isHovered, this._menuItem);

                if(isHovered !== wasHovered) {
                    var eventName = 'start';

                    if(isHovered && this.actionDescription) {
                        this._ariaAnnounce(this.actionDescription);
                    }
                    else {
                        eventName = 'end'
                        this._ariaAnnounce('');
                    }

                    this.fire('touch-menu-item-hover-' + eventName, {element: this});
                }
            },
            set selected(isSelected) {
                this.toggleClass('selected', isSelected, this._menuItem);

                if(isSelected) {
                    this.inTransition = true;
                    this.listen(this._menuItem, 'transitionend', 'transitionendHandler');

                    if(this.selectionHandlerFunc) {
                        this.async(this.selectionHandlerFunc);
                    }
                }
            },
            get selected() {
                return this._menuItem.classList.contains('selected');
            },
            get width() {
                return this._menuItem.clientWidth;
            },
            get height() {
                return this._menuItem.clientHeight;
            },
            transitionendHandler: function () {
                // Triggered by the end of the transition caused by adding 'selected' class
                this.inTransition = false;
                this.hoverState = false;
                this.selected = false;
                this.visible = false;
                // Detach this event handler - otherwise the menu item's classes thrash
                this.unlisten(this._menuItem, 'transitionend', 'transitionendHandler');
                this._touchMenu.clearItemSelected();

                this._updateDisplayData();
            },
            _textChanged: function(newValue) {
                if(!this.inTransition) {
                    this._displayText = newValue;
                }
            },
            _backgroundImageChanged: function(newValue) {
                if(!this.inTransition) {
                    this._displayBackgroundImage = newValue;
                }
            },
            _updateDisplayData: function() {
                this._displayText = this.text;
                this._displayBackgroundImage = this.backgroundImage;
            },
            _offsetChanged: function(newOffset) {
                this.style.left = newOffset.x + 'px';
                this.style.top = newOffset.y + 'px';
            },
            get visible() {
                return this._visible;
            },
            set visible(isVisible) {
                if(!this.inTransition) {
                    this._menuItem.style.opacity = isVisible ? '1.0' : '0.0';
                }
            },
            pointInTouchRegion: function(point) {
                var rect = {
                    top: this.touchRegion.top,
                    bottom: this.touchRegion.top + this.height,
                    left: this.touchRegion.left,
                    right: this.touchRegion.left + this.width
                };

                return (
                    (point.y < rect.bottom)
                    && (point.y > rect.top)
                    && (point.x < rect.right)
                    && (point.x > rect.left)
                );
            },
            _initialize: function() {
                if(!this._initialized && this._touchMenu) {
                    this._initialized = true;
                    this.visible = false;

                    var host = this._getHostNode();

                    if(this.selectionHandler) {
                        if( !host[this.selectionHandler] || (typeof host[this.selectionHandler] != 'function') ) {
                            throw this.selectionHandler + ' is not a function';
                        }

                        this.selectionHandlerFunc = (host[this.selectionHandler]).bind(host);
                    }

                    this._updateDisplayData();
                }
            },
            _ariaAnnounce: function (message) {
                this._setAriaMessage('');
                this._setAriaMessage(message);
            },
            _getHostNode: function () {
                if(!this._hostNode) {
                    this._hostNode = Polymer.dom(this._touchMenu).parentNode.host;
                }

                return this._hostNode;
            }
        });
    </script>
</dom-module>
