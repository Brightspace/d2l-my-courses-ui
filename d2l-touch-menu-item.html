<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="d2l-touch-menu-item-styles.html">

<dom-module id="d2l-touch-menu-item">
	<template>
		<style include="d2l-touch-menu-item-styles"></style>

		<div class="longpress-menu-item">
			<div class="longpress-menu-item-text">{{_displayText}}</div>

			<div class="longpress-menu-item-image-background">
				<iron-icon class="longpress-menu-item-image" icon="{{_displayBackgroundImage}}" aria-hidden="true"></iron-icon>
			</div>
		</div>

		<d2l-offscreen aria-live="polite">{{ariaMessage}}</d2l-offscreen>
	</template>
	<script>
		Polymer({
			is: 'd2l-touch-menu-item',
			properties: {
				actionDescription: {
					type: String
				},
				ariaMessage: {
					type: String,
					readOnly: true
				},
				backgroundImage: {
					type: String,
					observer: '_backgroundImageChanged'
				},
				hoverState: {
					type: Boolean,
					observer: '_hoverStateChanged'
				},
				offset: {
					type: Object,
					observer: '_offsetChanged'
				},
				hoverEvent: {
					type: String
				},
				selectionEvent: {
					type: String
				},
				text: {
					type: String,
					observer: '_textChanged'
				},
				touchRegion: {
					type: Object
				},
				_inTransition: {
					type: Boolean
				},
				_menuItem: {
					type: Object
				},
				_displayText: {
					type: String
				},
				_displayBackgroundImage: {
					type: String
				},
				_hostNode: {
					type: Object
				},
				_touchRadiusPadding: {
					type: Number,
					value: 30
				},
				_selected: {
					type: Boolean
				},
				_visible: {
					type: Boolean
				}
			},
			ready: function() {
				this._menuItem = this.$$('.longpress-menu-item');
				this._updateDisplayData();
			},
			set selected(isSelected) {
				this._selected = isSelected;
				this.toggleClass('selected', isSelected, this._menuItem);

				if (isSelected) {
					this._inTransition = true;
					this.listen(this._menuItem, 'transitionend', 'transitionendHandler');
				} else {
					// Not selected implied not visible
					this.visible = false;
				}
			},
			get selected() {
				return this._selected;
			},
			get width() {
				return this._menuItem.clientWidth;
			},
			get height() {
				return this._menuItem.clientHeight;
			},
			pointInTouchRegion: function(point) {
				var rect = {
					top: this.touchRegion.top - this._touchRadiusPadding,
					bottom: this.touchRegion.top + this.height + this._touchRadiusPadding,
					left: this.touchRegion.left - this._touchRadiusPadding,
					right: this.touchRegion.left + this.width + this._touchRadiusPadding
				};

				return (
					(point.y < rect.bottom)
					&& (point.y > rect.top)
					&& (point.x < rect.right)
					&& (point.x > rect.left)
				);
			},
			transitionendHandler: function() {
				// Triggered by the end of the transition caused by adding 'selected' class
				this._inTransition = false;
				this.hoverState = false;
				this.selected = false;
				this.visible = false;
				// Detach this event handler - otherwise the menu item's classes thrash
				this.unlisten(this._menuItem, 'transitionend', 'transitionendHandler');

				this._updateDisplayData();
			},
			_hoverStateChanged: function(isHovered, wasHovered) {
				this.toggleClass('longpress-menu-item-hover', isHovered, this._menuItem);

				if (isHovered !== wasHovered) {
					if (isHovered && this.actionDescription) {
						this._ariaAnnounce(this.actionDescription);
					} else {
						this._ariaAnnounce('');
					}

					if (this.hoverEvent && !this.selected) {
						this.fire(this.hoverEvent, {hoverState: isHovered, element: this._touchTarget});
					}
				}
			},
			_textChanged: function(newValue) {
				if (!this._inTransition) {
					this._displayText = newValue;
				}
			},
			_backgroundImageChanged: function(newValue) {
				if (!this._inTransition) {
					this._displayBackgroundImage = newValue;
				}
			},
			_updateDisplayData: function() {
				this._displayText = this.text;
				this._displayBackgroundImage = this.backgroundImage;
			},
			_offsetChanged: function(newOffset) {
				this.style.left = newOffset.x + 'px';
				this.style.top = newOffset.y + 'px';
			},
			_ariaAnnounce: function(message) {
				this._setAriaMessage('');
				this._setAriaMessage(message);
			},
			set visible(isVisible) {
				if (!this._selected) {
					this._visible = isVisible;
					this.toggleClass('visible', isVisible, this._menuItem);
				}
			},
			get visible() {
				return this._visible;
			}
		});
	</script>
</dom-module>
