<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../localize-behavior.html">
<link rel="import" href="../../d2l-search-widget/d2l-search-widget.html">
<link rel="import" href="d2l-image-tile-grid.html">
<link rel="import" href="../../d2l-icons/d2l-icons.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">

<dom-module id="d2l-basic-image-selector">
	<template>
		<style include="d2l-colors">
			#image-search{
				flex: 0.5;
			}

			.no-results-search-text {
				font-weight: bolder;
				word-wrap: break-word;
			}

			.no-results-text {
				font-size: 1.5rem;
				margin-bottom: 12px;
			}

			.top-section {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 45px;
			}

			.upload {
				color: var(--d2l-color-ferrite);
				font-weight: 400;
				margin: 5px 10px;
			}

			.upload:focus .upload-text,
			.upload:hover .upload-text {
				text-decoration: underline;
			}
		</style>

		<d2l-ajax
			id="imagesRequest"
			url="[[_searchString]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onDefaultImagesRequestResponse">
		</d2l-ajax>

		<div class="top-section">
			<d2l-search-widget
				id="image-search"
				class="small"
				search-action="[[_searchAction]]"
				placeholder-text="[[localize('search')]]"
				search-field-name="search"
			>
			</d2l-search-widget>

			<template is="dom-if" if="{{_organizationChangeImageHref}}" restamp="true">
				<a class="upload" href$=[[_organizationChangeImageHref]]>
					<d2l-icon class="upload-icon" icon="d2l-tier2:upload" aria-hidden="true"></d2l-icon>
					<span class="upload-text">{{localize('upload')}}</span>
				</a>
			</template>
		</div>

		<template is="dom-if" if="{{_showGrid}}">
			<d2l-image-tile-grid
				image-catalog-location="[[imageCatalogLocation]]"
				organization="[[organization]]"
				images="[[_images]]"
			></d2l-image-tile-grid>
		</template>

		<template is="dom-if" if="{{!_showGrid}}">
			<div class="no-results-area">
				<div class="no-results-text">
					<span>{{_noResultsTextStart}}</span><span class="no-results-search-text">{{_noResultsTextMid}}</span><span>{{_noResultsTextEnd}}</span>
				</div>
				<div class="please-change-text">{{localize('images.pleaseModify')}}</div>
			</div>
		</template>
	</template>
	<script>
		'use strict';

		Polymer({
			is: 'd2l-basic-image-selector',
			ready: function() {
				this._images = this._defaultImages;
				this.$$('d2l-search-widget').addEventListener('search-results-changed', function(response) {

					var searchRegex = /search=([^&]*)/,
						searchHref = decodeURIComponent( response.detail.getLinkByRel('self').href ),
						match = searchRegex.exec(searchHref),
						userSearchText = (match.length > 1) ? match[1] : null;

					if (userSearchText) {
						this._displaySearchResults(userSearchText);
					} else {
						// Throw out empty searches
						// TODO: d2l-search-widget property that sends events instead of making network calls
						this._displayDefaultResults();
					}

					this._updateImages();
				}.bind(this));
			},
			properties: {
				imageCatalogLocation: String,
				organization: Object,
				_searchString: String,
				_images: Array,
				_searchAction: String,
				_noResultsTextStart: String,
				_noResultsTextMid: String,
				_noResultsTextEnd: String,
				_showGrid: Boolean,
				_organizationChangeImageHref: String
			},
			behaviors: [ window.D2L.MyCourses.LocalizeBehavior ],
			listeners: {
				'd2l-simple-overlay-opening': '_initialize',
				'd2l-simple-overlay-closed': '_clear'
			},
			_sirenParser: document.createElement('d2l-siren-parser'),
			_searchImages: [],
			_defaultImages: [],
			_displaySearchResults: function(userSearchText) {
				var searchWidget = this.$$('d2l-search-widget'),
					delimiter = '$$$DELIMITER???',
					noResultsText = this.localize('images.noResults', 'search', delimiter),
					noResultsSplit = noResultsText.split(delimiter);

				this._searchImages = searchWidget.searchResults.entities || [];
				this._noResultsTextStart = noResultsSplit[0];
				this._noResultsTextMid = userSearchText;
				this._noResultsTextEnd = noResultsSplit[1];

				this._showGrid = (userSearchText || '') === '' || this._searchImages.length > 0;
			},
			_displayDefaultResults: function() {
				this._searchImages = [];
				this._showGrid = true;
			},
			_onDefaultImagesRequestResponse: function(response) {
				if (response.detail.status !== 200) {
					return;
				}

				var parsedResponse = this._sirenParser.parse(response.detail.xhr.response);
				this._defaultImages = parsedResponse.entities || [];

				this._updateImages();
			},
			_initialize: function() {
				this._searchAction = JSON.stringify(this._getSearchAction());
				this._showGrid = true;
				this.$$('d2l-search-widget').clear();
				this._organizationChangeImageHref = this._getChangeCourseImageLink(organization);

				// TODO: Add 'department' to the organization HM entity and use that information here
				if (this.organization && (this.organization.properties || {}).name) {
					this._searchString = this._getSearchStringValue(this.organization.properties.name, true);
				} else {
					// This is better than 'default' because we get random defaults rather than starting at 0
					this._searchString = this._getSearchStringValue('THIS_WILL_RETURN_NOTHING', true);
				}

				if (this._searchString !== null) {
					this.$.imagesRequest.generateRequest();
				}
			},
			_clear: function() {
				this._searchString = '';
				this._images = [];
			},
			_getSearchAction: function() {
				return {
					name: 'search-catalog-image',
					method: 'GET',
					href: this._searchPath,
					fields: [
						{ name: 'search', type: 'search', value: '' }
					]
				};
			},
			get _searchPath() {
				if (!this.imageCatalogLocation) {
					return null;
				}

				var endSlash = this.imageCatalogLocation.slice(-1) === '/' ? '' : '/';
				return this.imageCatalogLocation + endSlash + 'images';
			},
			_getSearchStringValue: function(search, appendMore) {
				var appendMoreQuery = appendMore ? '&appendMore=1' : '';
				return this._searchPath + '?search=' + search + appendMoreQuery;
			},
			_updateImages: function() {
				var searchImages = this._searchImages || [];
				this._images = (searchImages.length > 0) ? searchImages : this._defaultImages;
			},
			_getChangeCourseImageLink: function(organization) {
				var rel = /edit-image-page/;
				var editImagePage = organization && organization.getLinkByRel(rel);
				if (editImagePage) {
					return editImagePage.href;
				}
			}
		});
	</script>
</dom-module>
