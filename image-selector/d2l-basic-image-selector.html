<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../localize-behavior.html">
<link rel="import" href="../../d2l-search-widget/d2l-search-widget.html">
<link rel="import" href="d2l-image-tile-grid.html">

<dom-module id="d2l-basic-image-selector">
	<template>
		<style>
			d2l-search-widget {
				width: 50%;
				margin-bottom: 60px;
			}
		</style>

		<d2l-ajax
			id="imagesRequest"
			url="[[_searchString]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onDefaultImagesRequestResponse">
		</d2l-ajax>

		<d2l-search-widget
			id="image-search"
			class="small"
			search-action="[[_searchAction]]"
			placeholder-text="[[localize('search')]]"
			search-field-name="search"
		>
		</d2l-search-widget>

		<template is="dom-if" if="{{_showGrid}}">
			<d2l-image-tile-grid
				image-catalog-location="[[imageCatalogLocation]]"
				organization="[[organization]]"
				images="[[_images]]"
			></d2l-image-tile-grid>
		</template>
	</template>
	<script>
		'use strict';

		Polymer({
			is: 'd2l-basic-image-selector',
			ready: function() {
				this._images = this._defaultImages;
				this.$$('d2l-search-widget').addEventListener('search-results-changed', function(response) {
					var searchWidget = this.$$('d2l-search-widget');
					this._searchImages = searchWidget.searchResults.entities || [];

					var searchRegex = /search=([^&]*)/;
					var searchHref = response.detail.getLinkByRel('self').href;
					var match = searchRegex.exec(searchHref);
					this._userSearchText = (match.length > 1) ? match[1] : null;
					this._showGrid = (this._userSearchText || '') === '' || this._searchImages.length > 0;

					this._updateImages();
				}.bind(this));
			},
			properties: {
				imageCatalogLocation: String,
				organization: {
					type: Object,
					observer: '_updateOrganization'
				},
				_searchString: String,
				_images: Array,
				_searchAction: String,
				_userSearchText: String,
				_showGrid: Boolean,
			},
			behaviors: [ Polymer.D2L.MyCourses.LocalizeBehavior ],
			focusableNodesOverride: function() {
				var imageTileFocusables = [];
				var grid = this.$$('d2l-image-tile-grid');
				[].forEach.call(grid.querySelectorAll('d2l-image-selector-tile'), function(imageTile) {
					Array.prototype.push.apply(imageTileFocusables, Polymer.dom(imageTile.root).querySelectorAll('button'));
				});
				return imageTileFocusables;
			},
			_sirenParser: document.createElement('d2l-siren-parser'),
			_searchImages: [],
			_defaultImages: [],
			_onDefaultImagesRequestResponse: function(response) {
				if (response.detail.status !== 200) {
					return;
				}

				var parsedResponse = this._sirenParser.parse(response.detail.xhr.response);
				this._defaultImages = parsedResponse.entities || [];

				this._updateImages();

				// if the course name search gets nothing back, use the default images
				if (this._defaultImages.length === 0 && this._searchString !== this._getSearchStringValue('default')) {
					this._searchString = this._getSearchStringValue('default');
					this.$.imagesRequest.generateRequest();
				}
			},
			_updateOrganization: function(organization) {
				this._searchAction = JSON.stringify(this._getSearchAction());
				this._userSearchText = null;
				this._showGrid = true;

				// TODO: Add 'department' to the organization HM entity and use that information here
				if (organization && (organization.properties || {}).name) {
					this._searchString = this._getSearchStringValue(organization.properties.name);
				} else {
					this._searchString = this._getSearchStringValue('default');
				}

				if (this._searchString !== null) {
					this.$.imagesRequest.generateRequest();
				}
			},
			_getSearchAction: function() {
				return {
					name: 'search-catalog-image',
					method: 'GET',
					href: this._searchPath,
					fields: [
						{ name: 'search', type: 'search', value: '' }
					]
				};
			},
			get _searchPath() {
				if (!this.imageCatalogLocation) {
					return null;
				}

				var endSlash = this.imageCatalogLocation.slice(-1) === '/' ? '' : '/';
				return this.imageCatalogLocation + endSlash + 'images';
			},
			_getSearchStringValue: function(search) {
				return this._searchPath + '?search=' + search;
			},
			_updateImages: function() {
				var searchImages = this._searchImages || [];
				this._images = (searchImages.length > 0) ? searchImages : this._defaultImages;
			}
		});
	</script>
</dom-module>
