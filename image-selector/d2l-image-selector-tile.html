<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../localize-behavior.html">
<link rel="import" href="../d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="../d2l-course-tile-grid-styles.html">
<link rel="import" href="../d2l-utility-behavior.html">
<link rel="import" href="../../d2l-icons/d2l-icons.html">
<link rel="import" href="d2l-image-selector-tile-styles.html">
<script src="../bower_components/picturefill/src/picturefill.js" async></script>

<dom-module id="d2l-image-selector-tile">
	<template>
		<style include="d2l-image-selector-tile-styles"></style>

		<div class$="{{_getTileClass(image)}}">
			<div class="padding"></div>
			<div class="click-overlay"
				on-click="_toggleOverlayOn"
				on-blur="_toggleOverlayOff"
				tabindex="-1">
			</div>
			<div class="d2l-image-tile-overlay">
				<button class="overlay-button" on-tap="_selectImage" on-focus="_toggleOverlayOn" on-blur="_toggleOverlayOff">
					<div class="overlay-button-inner">
						<d2l-icon class="camera-icon" icon="d2l-tier1:pic" aria-hidden="true"></d2l-icon>
						<span class="overlay-button-text">{{localize('useThisImage')}}</span>
					</div>
				</button>
			</div>
			<div class="d2l-image-tile-content">
				<img src="[[getDefaultImageLink(image, 'narrow')]]"></img>
			</div>

			<d2l-ajax
				id="setImageRequest"
				url="[[_setImageUrl]]"
				method="POST"
				headers='{ "Accept": "application/vnd.siren+json" }'
				on-iron-ajax-response="_onSetImageResponse"
				on-iron-ajax-error="_onSetImageError">
			</d2l-ajax>

		</div>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-image-selector-tile',
			properties: {
				image: {
					type: Object,
					observer: '_updateImageSource'
				},
				organization: Object,
				_setImageUrl: String
			},
			behaviors: [
				window.D2L.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.UtilityBehavior
			],
			ready: function() {
				this._updateImageSource();
			},
			_getTileClass: function(image) {
				return image ? 'd2l-image-tile' : 'd2l-image-tile no-image';
			},
			_toggleOverlayOn: function() {
				this.toggleClass('mobile-selected', true, this.$$('.d2l-image-tile'));
			},
			_toggleOverlayOff: function() {
				this.toggleClass('mobile-selected', false, this.$$('.d2l-image-tile'));
			},
			_getSetImageUrl: function() {
				if (this.organization && this.image) {
					var setImageAction = this.organization.getActionByName('set-catalog-image') || {},
						setImagePath = setImageAction.href || '';

					var url = this.image.getLinkByRel('self').href,
						regex = /\/images\/[^\/?]*/i,
						match = url.match(regex);

					if (setImagePath !== '' && match) {
						return setImagePath + '?imagePath=' + match[0];
					}
				}

				return '';
			},
			_onSetImageResponse: function(response) {
				var status = response.detail.status === 200 ? 'success': 'failure';
				this._fireCourseImageMessage(status);
			},
			_onSetImageError: function() {
				this._fireCourseImageMessage('failure');
			},
			_fireCourseImageMessage: function(status) {
				this.fire('set-course-image', {
					organization: this.organization,
					image: this.image,
					status: status
				});
			},
			_selectImage: function() {
				this._setImageUrl = this._getSetImageUrl();
				this.$.setImageRequest.generateRequest();
				this._fireCourseImageMessage('set');
				this.fire('close-simple-overlay');
			},
			_updateImageSource: function() {
				var courseImage = Polymer.dom(this.root).querySelector('img');
				Polymer.dom(courseImage).setAttribute('srcset', this.getImageSrcset(this.image, 'narrow'));
				Polymer.dom(courseImage).setAttribute('sizes', "(max-width: 767px) 100vw, (max-width: 991px) and (min-width: 768px) 50vw, 33vw");
				picturefill({ reevaluate: true, elements: [ courseImage ] });
			}
		});
	</script>
</dom-module>
