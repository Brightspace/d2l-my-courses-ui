<link rel="import" href="http://www.polymer-project.org/1.0/components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="course-tile.html">

<dom-module id="my-courses-widget">
	<template>

		<style>
		:host {
			display: inline-block;
		}
		</style>

		<h2>My Courses</h2>

		<p>
		Xsrf: [[xsrfResponse.referrerToken]]<br/>
		Token: [[tokenResponse.access_token]]
		</p>

		<iron-ajax
			auto
			id="xsrfRequest"
			on-response="xsrfOnResponse"
			url="[[lms]]/d2l/lp/auth/xsrf-tokens"
			with-credentials="true"
			last-response="{{xsrfResponse}}"></iron-ajax>

		<iron-ajax
			id="tokenRequest"
			on-response="tokenOnResponse"
			method="POST"
			body="scope=*:*:*"
			url="[[lms]]/d2l/lp/auth/oauth2/token"
			headers="{{tokenHeaders}}"
			with-credentials="true"
			last-response="{{tokenResponse}}"></iron-ajax>

		<iron-ajax
			id="enrollmentsRequest"
			url="[[uisEndpoint]]"
			headers="{{enrollmentsHeaders}}"
			last-response="{{enrollmentsResponse}}"></iron-ajax>

		<template is="dom-repeat" items="[[enrollmentsResponse.entities]]">
			<course-tile
				target="[[lms]]/d2l/home/[[item.properties.id]]"
				name="[[item.properties.name]]"></course-tile>
		</template>

	</template>

	<script>
	Polymer({
		is: 'my-courses-widget',
		properties: {
			xsrfResponse: Object,
			tokenResponse: Object,
			enrollmentsResponse: Object,
			tokenHeaders: {
				type: Object,
				computed: 'getTokenHeaders(xsrfResponse)'
			},
			enrollmentsHeaders: {
				type: Object,
				computed: 'getEnrollmentsHeaders(tokenResponse)'
			},
			uisEndpoint: {
				type: String,
				value: 'http://127.0.0.1:3000/enrollments'
			},
			lms: {
				type: String,
				value: 'http://127.0.0.1:44444'
			}
		},
		getTokenHeaders: function (xsrfResponse) {
			return {
				'X-Csrf-Token': xsrfResponse.referrerToken
			};
		},
		getEnrollmentsHeaders: function (tokenResponse) {
			return {
				'Authorization': 'Bearer ' + tokenResponse.access_token,
				'Accept': 'application/vnd.siren+json'
			};
		},
		xsrfOnResponse: function (e, request) {
			if (request.xhr.status === 200) {
				// Don't try to get tokens until we have the XSRF header
				this.$.tokenRequest.generateRequest();
			}
		},
		tokenOnResponse: function (e, request) {
			if (request.xhr.status === 200) {
				// Don't try to get enrollments until we have the JWT header
				this.$.enrollmentsRequest.generateRequest();
			}
		}
	});
	</script>
</dom-module>
