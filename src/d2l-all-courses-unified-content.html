<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="d2l-css-grid-view/d2l-css-grid-view-behavior.html">
<link rel="import" href="d2l-css-grid-view/d2l-css-grid-view-styles.html">
<link rel="import" href="d2l-all-courses-styles.html">
<link rel="import" href="d2l-course-image-tile.html">
<link rel="import" href="localize-behavior.html">

<!--
`d2l-all-courses-unified-content`
Polymer-based web component for the all courses content.

This is only used if the `US90527-my-courses-updates` LD flag is ON
(meaning the `updated-sort-logic` attribute was added to the `d2l-my-courses` component).

-->

<dom-module id="d2l-all-courses-unified-content">
	<template strip-whitespace>
		<style include="d2l-all-courses-styles"></style>
		<style include="d2l-css-grid-view-styles"></style>

		<span class="bottom-pad" hidden$="[[!_noCoursesInSearch]]">
			[[localize('noCoursesInSearch')]]
		</span>
		<span class="bottom-pad" hidden$="[[!_noCoursesInSelection]]">
			[[localize('noCoursesInSelection')]]
		</span>
		<span class="bottom-pad" hidden$="[[!_noCoursesInDepartment]]">
			[[localize('noCoursesInDepartment')]]
		</span>
		<span class="bottom-pad" hidden$="[[!_noCoursesInSemester]]">
			[[localize('noCoursesInSemester')]]
		</span>
		<span class="bottom-pad" hidden$="[[!_noCoursesInRole]]">
			[[localize('noCoursesInRole')]]
		</span>

		<template is="dom-if" if="[[_renderContents]]">
			<div class="course-tile-grid">
				<template is="dom-repeat" items="[[filteredEnrollments]]">
					<div>
						<d2l-course-image-tile
							enrollment="[[item]]"
							tile-sizes="[[_tileSizes]]"
							show-course-code="[[showCourseCode]]"
							show-semester="[[showSemester]]"
							course-updates-config="[[courseUpdatesConfig]]">
						</d2l-course-image-tile>
					</div>
				</template>
			</div>
		</template>
	</template>
	<script>
		Polymer({
			is: 'd2l-all-courses-unified-content',
			properties: {
				showCourseCode: Boolean,
				showSemester: Boolean,
				courseUpdatesConfig: Object,
				updatedSortLogic: Boolean,
				totalFilterCount: Number,
				filterCounts: Object,
				isSearched: Boolean,
				filteredEnrollments: Array,

				_animate: {
					type: Boolean,
					value: false
				},
				_noCoursesInSearch: Boolean,
				_noCoursesInSelection: Boolean,
				_noCoursesInDepartment: Boolean,
				_noCoursesInSemester: Boolean,
				_noCoursesInRole: Boolean,
				_renderContents: {
					type: Boolean,
					value: false
				},
				_tileSizes: Object,
				_itemCount: {
					type: Number,
					value: 0
				}
			},
			behaviors: [
				D2L.PolymerBehaviors.MyCourses.LocalizeBehavior,
				D2L.MyCourses.CssGridBehavior
			],
			observers: [
				'_enrollmentsChanged(filteredEnrollments.length)'
			],

			attached: function() {
				document.body.addEventListener('d2l-tab-panel-selected', this._onTabSelected.bind(this));
				Polymer.RenderStatus.afterNextRender(this, function() {
					this._onResize();
				});
			},
			detached: function() {
				document.body.removeEventListener('d2l-tab-panel-selected', this._onTabSelected.bind(this));
			},

			getCourseTileItemCount: function() {
				return this._itemCount;
			},

			_enrollmentsChanged: function(enrollmentLength) {
				this._noCoursesInSearch = false;
				this._noCoursesInSelection = false;
				this._noCoursesInDepartment = false;
				this._noCoursesInSemester = false;
				this._noCoursesInRole = false;
				if (enrollmentLength === 0) {
					if (this.isSearched) {
						this._noCoursesInSearch = true;
					} else if (this.totalFilterCount === 1) {
						if (this.filterCounts.departments === 1) {
							this._noCoursesInDepartment = true;
						} else if (this.filterCounts.semesters === 1) {
							this._noCoursesInSemester = true;
						} else if (this.filterCounts.roles === 1) {
							this._noCoursesInRole = true;
						}
					} else if (this.totalFilterCount > 1) {
						this._noCoursesInSelection = true;
					}
				} else {
					if (!this.isSearched && this.totalFilterCount === 0) {
						this._itemCount = enrollmentLength;
					}
				}
			},
			_onTabSelected: function(e) {
				// Component is within a `div` inside the `d2l-tab-panel`, so we
				// need the parent's parent's ID.
				var tabPanelId = this.parentElement
					&& this.parentElement.parentElement
					&& this.parentElement.parentElement.id;
				if (e.target.id === tabPanelId) {
					// If we try to render the `d2l-all-courses-unified-content`
					// for a large number of tabs right away, the page lags.
					// Instead, only render a tab when it's selected for the
					// first time.
					this._renderContents = true;
				}
			}
		});
	</script>
</dom-module>
