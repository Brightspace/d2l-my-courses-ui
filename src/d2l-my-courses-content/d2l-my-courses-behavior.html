<link rel="import" href="../../../polymer/polymer.html">

<link rel="import" href="../../../siren-parser-import/siren-parser.html">
<script type="text/javascript" src="../../saved-searches.json"></script>

<script>
	window.D2L = window.D2L || {};
	window.D2L.MyCourses = window.D2L.MyCourses || {};

	/*
	* Common properties between d2l-my-courses and d2l-my-courses-content-behavior-animated
	* @polymerBehavior D2L.MyCourses.MyCoursesBehavior
	*/
	D2L.MyCourses.MyCoursesBehavior = {
		properties: {
			// URL that directs to the advanced search page
			advancedSearchUrl: String,
			// URL that is called by the widget to fetch enrollments
			enrollmentsUrl: String,
			// URL that is called by the widget to fetch results from the course image catalog
			imageCatalogLocation: String,
			// Configuration value passed in to toggle course code
			showCourseCode: Boolean,
			// Configuration value passed in to toggle semester on course tile
			showSemester: Boolean,
			// Standard Semester OU Type name to be displayed in the all-courses filter dropdown
			standardDepartmentName: String,
			// Standard Department OU Type name to be displayed in the all-courses filter dropdown
			standardSemesterName: String,
			// Types of notifications to include in update count in course tile
			courseUpdatesConfig: Object,
			// Callback for upload in image-selector
			courseImageUploadCb: Function,
			// Feature flag for using d2l-course-image-tile and CSS grid view
			cssGridView: {
				type: Boolean,
				value: false
			},
			tabSearchActions: {
				type: Array,
				value: []
			},
			// Feature flag (switch) for using the updated sort logic and related fetaures
			updatedSortLogic: {
				type: Boolean,
				value: false
			}
		},
		attached: function() {
			this.fetchTabSearchActions();
		},
		courseImageUploadCompleted: function(success) {
			return this.updatedSortLogic
				? this.$$('d2l-my-courses-content').courseImageUploadCompleted(success)
				: this.$$('d2l-my-courses-content-animated').courseImageUploadCompleted(success);
		},
		getLastOrgUnitId: function() {
			return this.updatedSortLogic
				? this.$$('d2l-my-courses-content').getLastOrgUnitId()
				: this.$$('d2l-my-courses-content-animated').getLastOrgUnitId();
		},
		fetchTabSearchActions: function() {
			return this.fetchSirenEntity(this.enrollmentsUrl)
				.then(function(enrollmentsRootEntity) {
					if (!enrollmentsRootEntity.hasAction('search-my-enrollments')) {
						return Promise.resolve();
					}
					var searchAction = enrollmentsRootEntity.getActionByName('search-my-enrollments');
					this.tabSearchActions = [{'name': searchAction.name, 'title': 'All', 'selected': false, 'enrollmentsSearchAction': searchAction}];
				}.bind(this))
				.then(function() {
					// TODO: Call the promoted-searches route to get the list of searchActions, rather than from savedSearches.json
					// TODO: Look for the "most-recent" class property in the returned searchActions to select the right initial tab
					const promotedSearchesEntity = window.D2L.Hypermedia.Siren.Parse(savedSearches);
					const promotedSearchesArray = promotedSearchesEntity.actions.map(action => ({'name': action.name, 'title': action.title, 'selected': false, 'enrollmentsSearchAction': action}));
					promotedSearchesArray[1].selected = true;
					this.tabSearchActions = this.tabSearchActions.concat(promotedSearchesArray);
				}.bind(this));
		}
	};
</script>
