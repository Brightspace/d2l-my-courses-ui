<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../d2l-all-courses.html">
<link rel="import" href="../d2l-css-grid-view/d2l-css-grid-view-behavior.html">
<link rel="import" href="../d2l-alert-behavior.html">
<link rel="import" href="../d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="../d2l-interaction-detection-behavior.html">
<link rel="import" href="../d2l-utility-behavior.html">
<link rel="import" href="../localize-behavior.html">
<link rel="import" href="../../../d2l-fetch/d2l-fetch.html">

<script>
	window.D2L = window.D2L || {};
	window.D2L.MyCourses = window.D2L.MyCourses || {};

	/*
	* Common behavior shared between d2l-my-courses-content and d2l-my-courses-content-animated.
	* This exists as a temporary behavior, to be removed when the -content-animated component is removed,
	* and the functionality can be merged back into d2l-my-courses-content.
	*
	* @polymerBehavior D2L.MyCourses.MyCoursesContentBehavior
	*/
	D2L.MyCourses.MyCoursesContentBehaviorImpl = {
		properties: {
			enrollmentsSearchAction: Object,
			tabSearchActions: Array,
			userSettingsUrl: String,

			// Alerts to display in widget, above course tiles
			_alerts: {
				type: Array,
				value: function() { return []; }
			},
			// Whether course tiles should animate during pin/unpin
			_animateCourseTileGrid: {
				type: Boolean,
				value: false
			},
			// Array of enrollments being displayed by the widget
			_enrollments: {
				type: Array,
				value: function() { return []; }
			},
			// Object containing the IDs of previously loaded enrollments, to avoid duplicates
			_existingEnrollmentsMap: {
				type: Object,
				value: function() { return {}; }
			},
			// True when user has enrollments
			_hasEnrollments: {
				type: Boolean,
				value: false
			},
			// True when user has >1 page of enrollments
			_hasMoreEnrollments: {
				type: Boolean,
				value: false
			},
			// Lookup table of org unit ID -> enrollment, to avoid having to re-fetch enrollments
			_orgUnitIdMap: {
				type: Object,
				value: function() { return {}; }
			},
			// The organization which the user is selecting the image of
			_setImageOrg: {
				type: Object,
				value: function() { return {}; }
			},
			// Hides loading spinner and shows content when true
			_showContent: {
				type: Boolean,
				value: false
			},
			// Size the tile should render with respect to vw
			_tileSizes: {
				type: Object,
				value: function() { return {}; }
			},
			// Text to render for "View All Courses" link (includes enrollment count approximation)
			_viewAllCoursesText: {
				type: String,
				computed: '_getViewAllCoursesText(_hasMoreEnrollments, _enrollments.length)'
			}
		},
		listeners: {
			'open-change-image-view': '_onOpenChangeImageView',
			'clear-image-scroll-threshold': '_onClearImageScrollThreshold',
			'd2l-simple-overlay-closed': '_onSimpleOverlayClosed',
			'enrollment-pinned': '_onEnrollmentPinAction',
			'enrollment-unpinned': '_onEnrollmentPinAction',
			'course-tile-organization': '_onCourseTileOrganization',
			'course-image-loaded': '_onCourseImageLoaded',
			'initially-visible-course-tile': '_onInitiallyVisibleCourseTile',
			'started-inactive': '_onStartedInactiveAlert'
		},
		attached: function() {
			this.performanceMark('d2l.my-courses.attached');

			this._onEnrollmentPinnedMessage = this._onEnrollmentPinnedMessage.bind(this);
			document.body.addEventListener('d2l-course-pinned-change', this._onEnrollmentPinnedMessage, true);
			document.body.addEventListener('set-course-image', this._onSetCourseImage.bind(this));
			document.body.addEventListener('d2l-tab-panel-selected', this._onTabSelected.bind(this));
			this.$['image-selector-threshold'].scrollTarget = this.$['basic-image-selector-overlay'].scrollRegion;

			Polymer.RenderStatus.afterNextRender(this, function() {
				if (!this.cssGridView) {
					this.$$('d2l-course-tile-grid').addEventListener('startedInactiveAlert', this._onStartedInactiveAlert.bind(this));
				}
			});
		},
		detached: function() {
			document.body.removeEventListener('d2l-course-pinned-change', this._onEnrollmentPinnedMessage, true);
			document.body.removeEventListener('set-course-image', this._onSetCourseImage.bind(this));
			document.body.removeEventListener('d2l-tab-panel-selected', this._onTabSelected.bind(this));
		},
		observers: [
			'_enrollmentsChanged(_enrollments)',
		],

		/*
		* Public API functions
		*/

		courseImageUploadCompleted: function(success) {
			if (success) {
				this.$['basic-image-selector-overlay'].close();

				if (this.cssGridView) {
					var courseTiles = this.$$('.course-tile-grid').querySelectorAll('d2l-course-image-tile');
					for (var i = 0; i < courseTiles.length; i++) {
						courseTiles[i].refreshImage(this._setImageOrg);
					}
				} else {
					this.$$('d2l-course-tile-grid').refreshCourseTileImage(this._setImageOrg);
				}
			}
			this.focus();
		},
		focus: function() {
			var tileGrid = this.cssGridView ? this.$$('.course-tile-grid') : this.$$('d2l-course-tile-grid');
			if (tileGrid.focus(this._setImageOrg)) {
				return;
			}
			this.$.viewAllCourses.focus();
		},
		getCourseTileItemCount: function() {
			return this._enrollments.length;
		},
		getLastOrgUnitId: function() {
			if (!this._setImageOrg.links) {
				return;
			}
			return this._getOrgUnitIdFromHref(this.getEntityIdentifier(this._setImageOrg));
		},

		_allCoursesCreated: false,
		_courseImagesLoadedEventCount: 0,
		_courseTileOrganizationEventCount: 0,
		_initiallyVisibleCourseTileCount: 0,
		_enrollmentsSearchUrl: null,

		_enrollmentsChanged: function(enrollments) {
			this._hasEnrollments = enrollments.length > 0;

			this._clearAlerts();
			if (!this._hasEnrollments) {
				this._addAlert('call-to-action', 'noCourses', this.localize('noCoursesMessage'));
			}
		},

		/*
		* Listeners
		*/

		_onChangeImageLowerThreshold: function() {
			this.$$('d2l-basic-image-selector').loadMore(this.$['image-selector-threshold']);
		},
		_onClearImageScrollThreshold: function() {
			this.$['image-selector-threshold'].clearTriggers();
		},
		_onCourseImageLoaded: function() {
			this._courseImagesLoadedEventCount++;

			if (this._courseImagesLoadedEventCount === this._initiallyVisibleCourseTileCount) {
				this.performanceMark('d2l.my-courses.visible-images-complete');
				this.performanceMeasure(
					'd2l.my-courses',
					'd2l.my-courses.attached',
					'd2l.my-courses.visible-images-complete'
				);
			}
		},
		_onCourseTileOrganization: function() {
			if (this._initiallyVisibleCourseTileCount === 0 && this._courseTileOrganizationEventCount === 0) {
				// If no course tiles are initially visible (widget is outside of initial viewport)
				// then we can say we're already finished loading the visible organizations and images
				this.performanceMark('d2l.my-courses.visible-organizations-complete');
				this.performanceMeasure(
					'd2l.my-courses.meaningful.visible',
					'd2l.my-courses.attached',
					'd2l.my-courses.visible-organizations-complete'
				);
				this.performanceMark('d2l.my-courses.visible-images-complete');
				this.performanceMeasure(
					'd2l.my-courses.hero',
					'd2l.my-courses.attached',
					'd2l.my-courses.visible-images-complete',
					true
				);
			}

			this._courseTileOrganizationEventCount++;

			if (this._courseTileOrganizationEventCount === this._initiallyVisibleCourseTileCount) {
				this._addOnlyPastCoursesAlert();
				// Only show content once the last visible organization has loaded, to reduce jank
				this._showContent = true;
				this.performanceMark('d2l.my-courses.visible-organizations-complete');
				this.performanceMeasure(
					'd2l.my-courses.meaningful.visible',
					'd2l.my-courses.attached',
					'd2l.my-courses.visible-organizations-complete'
				);
			} else if (this._courseTileOrganizationEventCount === this._enrollments.length) {
				this.performanceMark('d2l.my-courses.all-organizations-complete');
				this.performanceMeasure(
					'd2l.my-courses.meaningful.all',
					'd2l.my-courses.attached',
					'd2l.my-courses.all-organizations-complete'
				);
			}
		},
		_onInitiallyVisibleCourseTile: function() {
			this._initiallyVisibleCourseTileCount++;
		},
		_onEnrollmentPinAction: function(e) {
			var isPinned = e.type === 'enrollment-pinned';
			var orgUnitId = this._getOrgUnitIdFromHref(this.getEntityIdentifier(this.parseEntity(e.detail.organization)));

			if (!orgUnitId) {
				return;
			}

			this.fire(
				'd2l-course-pinned-change', {
					orgUnitId: orgUnitId,
					isPinned: isPinned
				}
			);
		},
		_onEnrollmentPinnedMessage: function(e) {
			if (Polymer.dom(e).rootTarget === this) return;

			var orgUnitId;
			if (e.detail.orgUnitId) {
				orgUnitId = e.detail.orgUnitId;
			}
			else if (e.detail.enrollment && e.detail.enrollment.hasLinkByRel(this.HypermediaRels.organization)) {
				orgUnitId = this._getOrgUnitIdFromHref(e.detail.enrollment.getLinkByRel(this.HypermediaRels.organization).href);
			}

			// Only want to move pinned/unpinned enrollment if it exists in the panel
			var enrollment = orgUnitId && this._orgUnitIdMap[orgUnitId];
			if (!enrollment) {
				return this._refetchEnrollments();
			}
			var changedEnrollmentId = this.getEntityIdentifier(enrollment);
			var removalIndex = -1;
			var lastPinnedIndex = 0;
			for (var i = 0; i < this._enrollments.length; i++) {
				if (this._enrollments[lastPinnedIndex].hasClass('pinned')) {
					lastPinnedIndex = i;
				}

				var enrollmentId = this.getEntityIdentifier(this._enrollments[i]);
				if (enrollmentId === changedEnrollmentId) {
					removalIndex = i;
				}
			}

			// Find the last pinned enrollment
			while (
				lastPinnedIndex < this._enrollments.length
				&& this._enrollments[lastPinnedIndex].hasClass('pinned')
			) {
				lastPinnedIndex++;
			}

			var url = enrollment.getLinkByRel('self').href;
			url += (url.indexOf('?') === -1 ? '?' : '&') + 'bustCache=' + Math.random();

			var isPinned = lastPinnedIndex === 1 ? e.detail.isPinned : true;
			this._addOnlyPastCoursesAlert(isPinned);

			return this.fetchSirenEntity(url)
				.then(function(updatedEnrollment) {
					var orgUnitId = this._getOrgUnitIdFromHref(this.getEntityIdentifier(updatedEnrollment));
					this._orgUnitIdMap[orgUnitId] = updatedEnrollment;

					if (removalIndex === -1) {
						// Course was not already in list, insert it as last pinned item
						this.splice('_enrollments', lastPinnedIndex, 0, updatedEnrollment);
					} else if (removalIndex === lastPinnedIndex) {
						// Course is already in the correct position, just update it
						// (avoids removal animation + insertion animation in exact same position)
						this.splice('_enrollments', removalIndex, 1, updatedEnrollment);
					} else {
						// Remove the enrollment from its current location
						this.splice('_enrollments', removalIndex, 1);

						if (removalIndex < lastPinnedIndex) {
							// Need to account for us removing the enrollment
							lastPinnedIndex--;
						}
						// Re-add the (updated) enrollment at the end of the pinned list
						this.splice('_enrollments', lastPinnedIndex, 0, updatedEnrollment);
					}
				}.bind(this));
		},
		_onStartedInactiveAlert: function(e) {
			this._removeAlert('startedInactiveCourses');
			if (this._checkIfStartedInactiveCourses(e)) {
				this._addAlert('warning', 'startedInactiveCourses', this.localize('startedInactiveAlert'));
			}
		},
		_onTabSelected: function(e) {
			// Only handle if tab selected corresponds to this panel
			if (e.target.id !== this.parentElement.id) {
				return;
			}
			if (!this._hasEnrollments) {
				this._fetchRoot()
					.then(function() {
						window.dispatchEvent(new Event('resize'));
					});
			}
			else {
				setTimeout(function() {
					// Force redraw of course tiles.
					window.dispatchEvent(new Event('resize'));
				}, 10);
			}
			this._setLastSearchName(this.enrollmentsSearchAction.name);
		},
		_checkIfStartedInactiveCourses: function(e) {
			var type = e && e.detail && e.detail.type;
			var hasStartedInactiveCourses = false;
			if (this.cssGridView) {
				hasStartedInactiveCourses = !!this.$$('.course-tile-grid d2l-course-image-tile[started-inactive]');
			} else {
				hasStartedInactiveCourses = this.$$('d2l-course-tile-grid').checkForStartedInactive(type);
			}
			return hasStartedInactiveCourses;
		},
		_onSimpleOverlayClosed: function() {
			this._removeAlert('setCourseImageFailure');
			// update the startedInactive alert in case the user changed the pinned states in the overlay
			this._onStartedInactiveAlert();
		},
		_onOpenChangeImageView: function(e) {
			if (e.detail.organization) {
				this._setImageOrg = this.parseEntity(e.detail.organization);
			}

			this.$['basic-image-selector-overlay'].open();
		},
		_onSetCourseImage: function(e) {
			this.$['basic-image-selector-overlay'].close();
			this._removeAlert('setCourseImageFailure');
			if (e && e.detail) {
				if (e.detail.status === 'failure') {
					setTimeout(function() {
						this._addAlert('warning', 'setCourseImageFailure', this.localize('error.settingImage'));
					}.bind(this), 1000); // delay until the tile fail icon animation begins to kick in (1 sec delay)
				}
			}
			if (this._allCoursesCreated) {
				this.$$('d2l-all-courses').setCourseImage(e);
			}
			!this.cssGridView && this.$$('d2l-course-tile-grid').setCourseImage(e);
		},

		/*
		* Utility/helper functions
		*/

		_createFetchEnrollmentsUrl: function(bustCache) {
			var query = {
				pageSize: 20,
				embedDepth: 1,
				sort: 'current',
				autoPinCourses: false,
				promotePins: true
			};
			var enrollmentsSearchUrl = this.createActionUrl(this.enrollmentsSearchAction, query);

			if (bustCache) {
				enrollmentsSearchUrl += '&bustCache=' + Math.random();
			}

			return enrollmentsSearchUrl;
		},
		_createAllCourses: function() {
			if (!this._allCoursesCreated) {
				var allCourses = document.createElement('d2l-all-courses');
				this.$.allCoursesPlaceholder.appendChild(allCourses);
				this._allCoursesCreated = true;
			}
		},
		_keypressOpenAllCoursesView: function(e) {
			if (e.code === 'Space' || e.code === 'Enter') {
				return this._openAllCoursesView(e);
			}
		},
		_fetchRoot: function() {
			if (!this.enrollmentsSearchAction) {
				return;
			}
			this.performanceMark('d2l.my-courses.root-enrollments.request');

			var showContent = function() {
				this._showContent = true;
			}.bind(this);

			return this._fetchEnrollments()
				.then(function() {
					// At worst, display content 1s after we fetch enrollments
					// (Usually set to true before that, in _onCourseTileOrganization)
					this._addOnlyPastCoursesAlert();
					setTimeout(showContent, 1000);
				}.bind(this))
				.catch(showContent);
		},
		_fetchEnrollments: function() {
			this.performanceMark('d2l.my-courses.root-enrollments.response');
			this.performanceMeasure(
				'd2l.my-courses.root-enrollments',
				'd2l.my-courses.root-enrollments.request',
				'd2l.my-courses.root-enrollments.response'
			);

			this._enrollmentsSearchUrl = this._createFetchEnrollmentsUrl();
			this.performanceMark('d2l.my-courses.search-enrollments.request');
			return this.fetchSirenEntity(this._enrollmentsSearchUrl)
				.then(this._enrollmentsResponsePerfMeasures.bind(this))
				.then(this._populateEnrollments.bind(this));
		},
		_enrollmentsResponsePerfMeasures: function(enrollmentsEntity) {
			this.performanceMark('d2l.my-courses.search-enrollments.response');
			this.performanceMeasure(
				'd2l.my-courses.search-enrollments',
				'd2l.my-courses.search-enrollments.request',
				'd2l.my-courses.search-enrollments.response'
			);

			return Promise.resolve(enrollmentsEntity);
		},
		_getOrgUnitIdFromHref: function(organizationHref) {
			var match = /[0-9]+$/.exec(organizationHref);

			if (!match) {
				return;
			}
			return match[0];
		},
		_getViewAllCoursesText: function(hasMoreEnrollments, enrollmentsLength) {
			var viewAllCourses = this.localize('viewAllCourses');

			// With individual fetching of courses as they get pinned, we can end
			// up with "21+", "22+", etc., so round down to nearest 5 for >20 courses
			var count = enrollmentsLength < 20
				? enrollmentsLength
				: String(enrollmentsLength - (enrollmentsLength % 5));
			if (hasMoreEnrollments) count += '+';

			return enrollmentsLength > 0 ? viewAllCourses + ' (' + count + ')' : viewAllCourses;
		},
		_openAllCoursesView: function(e) {
			this._createAllCourses();

			var allCourses = this.$$('d2l-all-courses');

			allCourses.tabSearchActions = this.tabSearchActions;
			allCourses.locale = this.locale;
			allCourses.showCourseCode = this.showCourseCode;
			allCourses.showSemester = this.showSemester;
			allCourses.advancedSearchUrl = this.advancedSearchUrl;
			allCourses.filterStandardSemesterName = this.standardSemesterName;
			allCourses.filterStandardDepartmentName = this.standardDepartmentName;
			allCourses.courseUpdatesConfig = this.courseUpdatesConfig;
			allCourses.updatedSortLogic = this.updatedSortLogic;
			allCourses.cssGridView = this.cssGridView;

			allCourses.open();

			e.preventDefault();
			e.stopPropagation();
		},
		_populateEnrollments: function(enrollmentsEntity) {
			var enrollmentEntities = enrollmentsEntity.getSubEntitiesByClass('enrollment');
			this._hasMoreEnrollments = enrollmentsEntity.hasLinkByRel('next');
			var newEnrollments = [];

			if (
				this.enrollmentsSearchAction
				&& this.enrollmentsSearchAction.hasFieldByName('sort')
				&& this.enrollmentsSearchAction.getFieldByName('sort').value.toLowerCase() === 'current'
			) {
				// When using Current sort, hide past courses in the widget view
				var tileGrid = this.cssGridView ? this.$$('.course-tile-grid') : this.$$('d2l-course-tile-grid');
				tileGrid.setAttribute('hide-past-courses', '');
			}

			enrollmentEntities.forEach(function(enrollment) {
				var enrollmentId = this.getEntityIdentifier(enrollment);
				if (!this._existingEnrollmentsMap.hasOwnProperty(enrollmentId)) {
					newEnrollments.push(enrollment);
					this._existingEnrollmentsMap[enrollmentId] = true;
				}

				var orgHref = (enrollment.getLinkByRel(this.HypermediaRels.organization) || {}).href;
				var orgUnitId = this._getOrgUnitIdFromHref(orgHref);
				if (!this._orgUnitIdMap.hasOwnProperty(orgUnitId)) {
					this._orgUnitIdMap[orgUnitId] = enrollment;
				}
			}, this);

			this._enrollments = this._enrollments.concat(newEnrollments);

			if (this._enrollments.length === 0) {
				// Normally we'd wait until the visible organization requests have finished,
				// but this user has no enrollments, so we won't hit that case.
				this._showContent = true;
			}

			var colNum = this._calcNumColumns(this._getAvailableWidth(Polymer.dom(this.root).node.host), this._enrollments.length);
			this._tileSizes = (colNum === 2) ?
				{ mobile: { maxwidth: 767, size: 50 }, tablet: { maxwidth: 1243, size: 33 }, desktop: { size: 20 } } :
				{ mobile: { maxwidth: 767, size: 100 }, tablet: { maxwidth: 1243, size: 67 }, desktop: { size: 25 } };

			this.fire('recalculate-columns');

			var lastEnrollment = enrollmentEntities[enrollmentEntities.length - 1];
			if (lastEnrollment && lastEnrollment.hasClass('pinned') && this._hasMoreEnrollments) {
				var url = enrollmentsEntity.getLinkByRel('next').href;
				return this.fetchSirenEntity(url)
					.then(this._populateEnrollments.bind(this));
			}
		},
		_refetchEnrollments: function() {
			this._enrollmentsSearchUrl = this._createFetchEnrollmentsUrl(true);
			return this.fetchSirenEntity(this._enrollmentsSearchUrl)
				.then(this._populateEnrollments.bind(this));
		},
		_addOnlyPastCoursesAlert: function(hasPinnedEnrollmentArg) {
			var courseTileGrid = this.cssGridView ? this.$$('.course-tile-grid') : this.$$('d2l-course-tile-grid');
			var hasCurrentOrFutureSelector, hasPinnedEnrollmentSelector;

			if (this.cssGridView) {
				hasCurrentOrFutureSelector = this.$$('.course-tile-grid d2l-course-image-tile:not([past-course])');
				hasPinnedEnrollmentSelector = this.$$('.course-tile-grid d2l-course-image-tile[pinned]');
			} else {
				hasCurrentOrFutureSelector = courseTileGrid.$$('d2l-course-tile:not([past-course])');
				hasPinnedEnrollmentSelector = courseTileGrid.$$('d2l-course-tile[pinned]');
			}

			var hasPinnedEnrollment = hasPinnedEnrollmentArg !== undefined ? hasPinnedEnrollmentArg : hasPinnedEnrollmentSelector;

			if (!hasPinnedEnrollment && this._hasEnrollments && !hasCurrentOrFutureSelector && courseTileGrid.hasAttribute('hide-past-courses')) {
				if (!this._hasAlert('onlyPastCourses')) this._addAlert('call-to-action', 'onlyPastCourses', this.localize('onlyPastCoursesMessage'));
			} else {
				this._removeAlert('onlyPastCourses');
			}
		},
		_setLastSearchName: function(id) {
			var formData = new FormData();
			formData.append('mostRecentEnrollmentsSearchType', '0');
			formData.append('mostRecentEnrollmentsSearchName', id);
			return window.d2lfetch
				.fetch(new Request(this.userSettingsUrl, {
					method: 'PUT',
					body: formData
				}));
		}
	};

	/*
	* @polymerBehavior D2L.MyCourses.MyCoursesContentBehavior
	*/
	D2L.MyCourses.MyCoursesContentBehavior = [
		D2L.PolymerBehaviors.MyCourses.LocalizeBehavior,
		window.D2L.Hypermedia.HMConstantsBehavior,
		D2L.MyCourses.CourseTileResponsiveGridBehavior,
		D2L.MyCourses.InteractionDetectionBehavior,
		D2L.MyCourses.AlertBehavior,
		D2L.MyCourses.UtilityBehavior,
		D2L.MyCourses.CssGridBehavior,
		D2L.MyCourses.MyCoursesContentBehaviorImpl
	];
</script>
